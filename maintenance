<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Machine Maintenance System</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0f1117;
  --bg-secondary: #181a22;
  --bg-tertiary: #1f2230;
  --bg-card: #242736;
  --bg-card-hover: #2a2e42;
  --border: #2e3348;
  --border-light: #3a3f5a;
  --text-primary: #e8eaf0;
  --text-secondary: #9498b0;
  --text-muted: #5e6380;
  --amber: #f59e0b;
  --amber-dim: #b27308;
  --amber-glow: rgba(245, 158, 11, 0.15);
  --red: #ef4444;
  --red-dim: rgba(239, 68, 68, 0.15);
  --green: #22c55e;
  --green-dim: rgba(34, 197, 94, 0.15);
  --blue: #3b82f6;
  --blue-dim: rgba(59, 130, 246, 0.15);
  --purple: #a855f7;
  --purple-dim: rgba(168, 85, 247, 0.15);
  --cyan: #06b6d4;
  --font-mono: 'JetBrains Mono', monospace;
  --font-body: 'DM Sans', sans-serif;
  --radius: 8px;
  --radius-lg: 12px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}
/* LAYOUT */
.app-shell { display: flex; min-height: 100vh; }
.sidebar {
  width: 240px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  z-index: 100;
  transition: transform 0.3s ease;
}
.sidebar-brand {
  padding: 20px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
}
.sidebar-brand .logo {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--amber), #d97706);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}
.sidebar-brand h1 {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: var(--text-primary);
  line-height: 1.3;
}
.sidebar-brand span {
  font-size: 10px;
  color: var(--text-muted);
  font-weight: 400;
  text-transform: none;
  letter-spacing: 0;
}
.sidebar-nav { padding: 12px 10px; flex: 1; }
.nav-section-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  padding: 12px 10px 6px;
}
.nav-btn {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-family: var(--font-body);
  font-size: 13.5px;
  font-weight: 500;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all 0.15s;
  text-align: left;
}
.nav-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.nav-btn.active {
  background: var(--amber-glow);
  color: var(--amber);
}
.nav-btn .icon { font-size: 17px; width: 22px; text-align: center; }
.nav-btn .badge {
  margin-left: auto;
  background: var(--red);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  font-family: var(--font-mono);
}
.sidebar-footer {
  padding: 14px 18px;
  border-top: 1px solid var(--border);
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}
.sidebar-footer .status-dot {
  display: inline-block;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--green);
  margin-right: 6px;
  animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
.main-content {
  margin-left: 240px;
  flex: 1;
  min-height: 100vh;
}
.page-header {
  padding: 22px 32px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-secondary);
  position: sticky;
  top: 0;
  z-index: 50;
}
.page-header h2 {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.3px;
}
.page-header .subtitle {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 2px;
}
.page-body { padding: 24px 32px; }

/* MOBILE */
.mobile-header {
  display: none;
  position: sticky;
  top: 0;
  z-index: 90;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 12px 16px;
  align-items: center;
  justify-content: space-between;
}
.hamburger {
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 22px;
  cursor: pointer;
  padding: 4px;
}
.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 99;
}

@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.open { display: block; }
  .mobile-header { display: flex; }
  .main-content { margin-left: 0; }
  .page-header { padding: 16px; }
  .page-body { padding: 16px; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr) !important; }
  .machines-grid { grid-template-columns: 1fr !important; }
}

/* KPI CARDS */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}
.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s;
}
.kpi-card:hover { border-color: var(--border-light); }
.kpi-card .kpi-icon {
  font-size: 20px;
  margin-bottom: 10px;
}
.kpi-card .kpi-value {
  font-family: var(--font-mono);
  font-size: 28px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 4px;
}
.kpi-card .kpi-label {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.kpi-card .kpi-accent {
  position: absolute;
  top: 0;
  right: 0;
  width: 60px;
  height: 60px;
  border-radius: 0 var(--radius-lg) 0 60px;
  opacity: 0.07;
}
.kpi-card.overdue .kpi-value { color: var(--red); }
.kpi-card.overdue .kpi-accent { background: var(--red); }
.kpi-card.open .kpi-value { color: var(--amber); }
.kpi-card.open .kpi-accent { background: var(--amber); }
.kpi-card.total .kpi-value { color: var(--blue); }
.kpi-card.total .kpi-accent { background: var(--blue); }
.kpi-card.completed .kpi-value { color: var(--green); }
.kpi-card.completed .kpi-accent { background: var(--green); }

/* PANELS / SECTIONS */
.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 20px;
  overflow: hidden;
}
.panel-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.panel-header h3 {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.panel-body { padding: 16px 20px; }

/* STATUS BADGES */
.badge-status {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 20px;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.badge-overdue { background: var(--red-dim); color: var(--red); }
.badge-open { background: var(--amber-glow); color: var(--amber); }
.badge-closed { background: var(--green-dim); color: var(--green); }
.badge-operational { background: var(--green-dim); color: var(--green); }
.badge-critical { background: var(--red-dim); color: var(--red); }
.badge-maintenance { background: var(--blue-dim); color: var(--blue); }
.badge-waiting { background: var(--purple-dim); color: var(--purple); }

/* TABLE */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.data-table th {
  text-align: left;
  padding: 10px 14px;
  font-family: var(--font-mono);
  font-size: 10.5px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.data-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  color: var(--text-secondary);
  vertical-align: middle;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover td { background: var(--bg-card-hover); }
.data-table .machine-id {
  font-family: var(--font-mono);
  font-weight: 600;
  color: var(--amber);
  font-size: 12px;
}
.data-table .cell-name { color: var(--text-primary); font-weight: 500; }

/* TWO COL LAYOUT */
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 1000px) { .two-col { grid-template-columns: 1fr; } }
.three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
@media (max-width: 1200px) { .three-col { grid-template-columns: 1fr 1fr; } }
@media (max-width: 768px) { .three-col { grid-template-columns: 1fr; } }

/* MACHINES GRID */
.machines-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 14px;
}
.machine-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px 18px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
.machine-card:hover { border-color: var(--amber-dim); transform: translateY(-1px); }
.machine-card .mc-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 10px;
}
.machine-card .mc-id {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 700;
  color: var(--amber);
}
.machine-card .mc-name {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 3px;
}
.machine-card .mc-type {
  font-size: 12px;
  color: var(--text-muted);
}
.machine-card .mc-meta {
  display: flex;
  gap: 16px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
  font-size: 11.5px;
  color: var(--text-secondary);
}
.machine-card .mc-meta .label {
  color: var(--text-muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: block;
  margin-bottom: 2px;
  font-family: var(--font-mono);
}
.machine-card .mc-overdue-bar {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--red);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

/* FORMS */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}
@media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
.form-group { margin-bottom: 0; }
.form-group.full { grid-column: 1 / -1; }
.form-group label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  margin-bottom: 6px;
  font-family: var(--font-mono);
}
.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 13.5px;
  transition: border-color 0.2s;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--amber);
}
.form-group select { cursor: pointer; }
.form-group textarea { resize: vertical; min-height: 70px; }

/* BUTTONS */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 9px 18px;
  border: none;
  border-radius: var(--radius);
  font-family: var(--font-body);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-primary {
  background: var(--amber);
  color: #000;
}
.btn-primary:hover { background: #eab308; }
.btn-secondary {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.btn-secondary:hover { border-color: var(--border-light); color: var(--text-primary); }
.btn-danger { background: var(--red-dim); color: var(--red); }
.btn-danger:hover { background: rgba(239,68,68,0.25); }

/* SEARCH */
.search-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0 12px;
}
.search-bar input {
  flex: 1;
  padding: 9px 0;
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 13px;
  font-family: var(--font-body);
}
.search-bar input:focus { outline: none; }
.search-bar .search-icon { color: var(--text-muted); font-size: 15px; }

/* SCAN PAGE */
.scan-zone {
  border: 2px dashed var(--border-light);
  border-radius: var(--radius-lg);
  padding: 40px;
  text-align: center;
  background: var(--bg-tertiary);
  transition: border-color 0.2s;
}
.scan-zone.active { border-color: var(--amber); background: var(--amber-glow); }
.scan-zone .scan-icon { font-size: 48px; margin-bottom: 16px; }
.scan-zone h3 { font-family: var(--font-mono); font-size: 16px; margin-bottom: 6px; }
.scan-zone p { font-size: 13px; color: var(--text-muted); }
.scan-input-wrap {
  max-width: 440px;
  margin: 20px auto 0;
}
.scan-input-wrap input {
  width: 100%;
  padding: 14px 18px;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--amber);
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 600;
  text-align: center;
  letter-spacing: 1px;
}
.scan-input-wrap input:focus { outline: none; border-color: var(--amber); }
.scan-result {
  margin-top: 24px;
  text-align: left;
}

/* MACHINE DETAIL MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 200;
  justify-content: center;
  align-items: flex-start;
  padding: 40px 20px;
  overflow-y: auto;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 720px;
  animation: modal-in 0.2s ease;
}
@keyframes modal-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.modal-header {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-header h3 { font-family: var(--font-mono); font-size: 15px; }
.modal-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 22px;
  cursor: pointer;
  padding: 4px;
}
.modal-close:hover { color: var(--text-primary); }
.modal-body { padding: 20px 24px; }

/* SETTINGS */
.settings-group {
  margin-bottom: 24px;
}
.settings-group h4 {
  font-family: var(--font-mono);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  margin-bottom: 12px;
}
.settings-field {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}
.settings-field label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  width: 140px;
  flex-shrink: 0;
}
.settings-field input {
  flex: 1;
  padding: 9px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12.5px;
}
.settings-field input:focus { outline: none; border-color: var(--amber); }

/* TOAST */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 300;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.toast {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-left: 3px solid var(--green);
  border-radius: var(--radius);
  padding: 12px 18px;
  font-size: 13px;
  color: var(--text-primary);
  animation: toast-in 0.3s ease;
  max-width: 340px;
}
.toast.error { border-left-color: var(--red); }
.toast.warning { border-left-color: var(--amber); }
@keyframes toast-in { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

/* ACTIVITY FEED */
.activity-item {
  display: flex;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.activity-item:last-child { border-bottom: none; }
.activity-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-top: 5px;
  flex-shrink: 0;
}
.activity-item .activity-text { font-size: 13px; color: var(--text-secondary); line-height: 1.4; }
.activity-item .activity-text strong { color: var(--text-primary); }
.activity-item .activity-time {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  margin-top: 2px;
}

/* FILTER BAR */
.filter-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.filter-chip {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-body);
}
.filter-chip:hover { border-color: var(--border-light); color: var(--text-primary); }
.filter-chip.active { background: var(--amber-glow); border-color: var(--amber-dim); color: var(--amber); }

/* PAGE SECTIONS */
.page { display: none; }
.page.active { display: block; }

/* CHART BAR simple */
.bar-chart-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}
.bar-chart-row .bar-label {
  font-size: 12px;
  color: var(--text-secondary);
  width: 110px;
  flex-shrink: 0;
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.bar-chart-row .bar-track {
  flex: 1;
  height: 22px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
}
.bar-chart-row .bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.6s ease;
}
.bar-chart-row .bar-count {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  width: 32px;
}

/* HIDDEN */
.hidden { display: none !important; }

/* MOBILE SCAN FAB */
.scan-fab {
  display: none;
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--amber);
  color: #000;
  border: none;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(245,158,11,0.4);
  z-index: 80;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s;
}
.scan-fab:active { transform: scale(0.92); }
@media (max-width: 768px) {
  .scan-fab { display: flex; }
  .scan-fab.hide-on-scan { display: none; }
}
</style>
</head>
<body>

<!-- MOBILE HEADER -->
<div class="mobile-header">
  <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
  <span style="font-family:var(--font-mono);font-size:13px;font-weight:600;">MAINT SYS</span>
  <span style="font-size:12px;color:var(--text-muted)">v1.0</span>
</div>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="app-shell">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="logo">‚öô</div>
      <div>
        <h1>Maint Sys<br><span>Machine Maintenance</span></h1>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Operations</div>
      <button class="nav-btn active" onclick="showPage('dashboard')">
        <span class="icon">üìä</span> Dashboard
      </button>
      <button class="nav-btn" onclick="showPage('machines')">
        <span class="icon">üè≠</span> Machines
      </button>
      <button class="nav-btn" onclick="showPage('workorders')">
        <span class="icon">üîß</span> Work Orders
        <span class="badge" id="openWoBadge">2</span>
      </button>
      <button class="nav-btn" onclick="showPage('scan')">
        <span class="icon">üì∑</span> Scan
      </button>
      <div class="nav-section-label" style="margin-top:12px">Admin</div>
      <button class="nav-btn" onclick="showPage('operators')">
        <span class="icon">üë§</span> Operators
      </button>
      <button class="nav-btn" onclick="showPage('settings')">
        <span class="icon">‚ö°</span> Settings
      </button>
    </nav>
    <div class="sidebar-footer">
      <span class="status-dot" id="connDot"></span>
      <span id="connLabel">Demo Mode</span>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main-content">

    <!-- ==================== DASHBOARD ==================== -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div>
          <h2>Dashboard</h2>
          <div class="subtitle" id="dashDate"></div>
        </div>
        <button class="btn btn-secondary" onclick="refreshDashboard()">‚Üª Refresh</button>
      </div>
      <div class="page-body">
        <div class="kpi-grid" id="kpiGrid"></div>
        <div class="two-col">
          <div class="panel">
            <div class="panel-header">
              <h3>‚ö† Overdue Services</h3>
              <span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono)" id="overdueCount"></span>
            </div>
            <div style="overflow-x:auto">
              <table class="data-table" id="overdueTable">
                <thead>
                  <tr><th>Machine</th><th>Name</th><th>Days Overdue</th><th>Status</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div>
            <div class="panel">
              <div class="panel-header"><h3>üìà Work Orders by Type</h3></div>
              <div class="panel-body" id="woTypeChart"></div>
            </div>
            <div class="panel" style="margin-top:20px">
              <div class="panel-header"><h3>üïê Recent Activity</h3></div>
              <div class="panel-body" id="recentActivity"></div>
            </div>
          </div>
        </div>
        <div class="panel" style="margin-top:20px">
          <div class="panel-header"><h3>üè≠ Machines by Location</h3></div>
          <div class="panel-body" id="locationChart"></div>
        </div>
      </div>
    </div>

    <!-- ==================== MACHINES ==================== -->
    <div class="page" id="page-machines">
      <div class="page-header">
        <div>
          <h2>Machines</h2>
          <div class="subtitle">Asset Registry ‚Äî <span id="machineCount">0</span> machines</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="search-bar" style="width:260px">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="Search machines..." id="machineSearch">
          </div>
          <button class="btn btn-primary" onclick="openAddMachine()">+ Add Machine</button>
        </div>
      </div>
      <div class="page-body">
        <div class="filter-bar" style="margin-bottom:16px" id="locationFilters"></div>
        <div class="machines-grid" id="machinesGrid"></div>
      </div>
    </div>

    <!-- ==================== WORK ORDERS ==================== -->
    <div class="page" id="page-workorders">
      <div class="page-header">
        <div>
          <h2>Work Orders</h2>
          <div class="subtitle">Maintenance Log</div>
        </div>
        <button class="btn btn-primary" onclick="openNewWorkOrder()">üö® Report Issue</button>
      </div>
      <div class="page-body">
        <div class="filter-bar" style="margin-bottom:16px">
          <div class="filter-chip active" onclick="filterWO('all', this)">All</div>
          <div class="filter-chip" onclick="filterWO('Open', this)">Open</div>
          <div class="filter-chip" onclick="filterWO('Closed', this)">Closed</div>
          <div class="filter-chip" onclick="filterWO('PM', this)">üîÑ PM</div>
          <div class="filter-chip" onclick="filterWO('Reported', this)">üö® Reported</div>
          <div class="search-bar" style="width:240px;margin-left:auto">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="Search work orders..." id="woSearch">
          </div>
        </div>
        <div class="panel">
          <div style="overflow-x:auto">
            <table class="data-table" id="woTable">
              <thead>
                <tr>
                  <th>Machine</th><th>Name</th><th>Type</th><th>Priority</th>
                  <th>Category</th><th>Reported</th><th>Tech</th><th>Status</th><th>Notes</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== SCAN ==================== -->
    <div class="page" id="page-scan">
      <div class="page-header">
        <div>
          <h2>Scan Machine</h2>
          <div class="subtitle">Scan QR / enter Machine ID to pull up details</div>
        </div>
      </div>
      <div class="page-body">
        <div class="scan-zone" id="scanZone">
          <div class="scan-icon">üì∑</div>
          <h3>Scan QR Code or Enter Machine ID</h3>
          <p>Use a barcode scanner or type the Machine ID below</p>
          <div class="scan-input-wrap">
            <input type="text" id="scanInput" placeholder="AFI-221" autofocus
              onkeydown="if(event.key==='Enter')scanMachine()">
          </div>
        </div>
        <div class="scan-result" id="scanResult"></div>
      </div>
    </div>

    <!-- ==================== OPERATORS ==================== -->
    <div class="page" id="page-operators">
      <div class="page-header">
        <div>
          <h2>Operators</h2>
          <div class="subtitle">Technicians & service personnel</div>
        </div>
        <button class="btn btn-primary" onclick="openAddOperator()">+ Add Operator</button>
      </div>
      <div class="page-body">
        <div class="panel">
          <div style="overflow-x:auto">
            <table class="data-table" id="operatorsTable">
              <thead>
                <tr><th>Initials/Name</th><th>Role</th><th>Work Orders</th><th>Status</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== SETTINGS ==================== -->
    <div class="page" id="page-settings">
      <div class="page-header">
        <div>
          <h2>Settings</h2>
          <div class="subtitle">Airtable API connection & app configuration</div>
        </div>
      </div>
      <div class="page-body">
        <div class="panel">
          <div class="panel-header"><h3>Airtable Connection</h3></div>
          <div class="panel-body">
            <div class="settings-group">
              <h4>API Credentials</h4>
              <div class="settings-field">
                <label>API Token</label>
                <input type="password" id="atApiKey" placeholder="pat_xxxxxxxxxxxx">
              </div>
              <div class="settings-field">
                <label>Base ID</label>
                <input type="text" id="atBaseId" placeholder="appXXXXXXXXXXXXXX">
              </div>
            </div>
            <div class="settings-group">
              <h4>Table Names</h4>
              <div class="settings-field">
                <label>Machines Table</label>
                <input type="text" id="atMachinesTable" value="Machines">
              </div>
              <div class="settings-field">
                <label>Service Log Table</label>
                <input type="text" id="atServiceTable" value="Service Log">
              </div>
              <div class="settings-field">
                <label>Operators Table</label>
                <input type="text" id="atOperatorsTable" value="Operators">
              </div>
            </div>
            <div style="display:flex;gap:10px">
              <button class="btn btn-primary" onclick="saveSettings()">Save & Connect</button>
              <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
              <button class="btn btn-danger" onclick="disconnectAirtable()">Disconnect</button>
            </div>
            <div id="connStatus" style="margin-top:12px;font-size:13px;color:var(--text-muted)"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-header"><h3>Data Management</h3></div>
          <div class="panel-body">
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn btn-secondary" onclick="exportData()">‚¨á Export Local Data (JSON)</button>
              <button class="btn btn-danger" onclick="resetDemoData()">üóë Reset Demo Data to Defaults</button>
            </div>
            <p style="margin-top:10px;font-size:12px;color:var(--text-muted)">In demo mode, all data persists in your browser's local storage. Reset clears everything and reloads the original 19 machines from the Excel model.</p>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- WORK ORDER MODAL -->
<div class="modal-overlay" id="woModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="woModalTitle">Report Machine Issue</h3>
      <button class="modal-close" onclick="closeModal('woModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Machine ID</label>
          <select id="woMachineId" onchange="autoFillMachine()"></select>
        </div>
        <div class="form-group">
          <label>Machine Name</label>
          <input type="text" id="woMachineName" readonly style="opacity:0.6">
        </div>
        <div class="form-group">
          <label>Incident Type</label>
          <select id="woIncidentType">
            <option>Repair</option><option>Preventive</option><option>Emergency</option>
            <option>Inspection</option><option>Installation</option><option>Upgrade</option>
            <option>Tooling</option><option>Clean</option>
          </select>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select id="woPriority">
            <option>Low</option><option selected>Medium</option><option>High</option><option>Critical</option>
          </select>
        </div>
        <div class="form-group">
          <label>Issue Category</label>
          <select id="woCategory">
            <option>Mechanical</option><option>Electrical</option><option>Hydraulic</option>
            <option>Pneumatic</option><option>Lubrication</option><option>Heating/Cooling</option>
            <option>Water System</option><option>Belt/Chain</option><option>Motor/Drive</option>
            <option>Blade/Cutting</option><option>Pump/Valve</option><option>Pressure System</option>
            <option>Glue/Adhesive</option><option>Software/Controls</option><option>Calibration</option>
            <option>Filter/Fluid</option><option>Tooling/Fixtures</option><option>Facility/Building</option>
            <option>Waste Removal</option><option>Scheduled PM</option><option>Safety</option><option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reported By</label>
          <select id="woReportedBy"></select>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select id="woPriorityAlt">
            <option>Low</option><option selected>Medium</option><option>High</option><option>Critical</option>
          </select>
        </div>
        <div class="form-group full">
          <label>Describe the Problem</label>
          <textarea id="woNotes" placeholder="What's happening? Any error codes, sounds, smells? When did it start?"></textarea>
        </div>
      </div>
      <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeModal('woModal')">Cancel</button>
        <button class="btn btn-primary" onclick="submitWorkOrder()">üö® Submit Issue Report</button>
      </div>
    </div>
  </div>
</div>

<!-- MACHINE DETAIL MODAL -->
<div class="modal-overlay" id="machineModal">
  <div class="modal">
    <div class="modal-header">
      <h3 id="machineModalTitle">Machine Detail</h3>
      <button class="modal-close" onclick="closeModal('machineModal')">‚úï</button>
    </div>
    <div class="modal-body" id="machineModalBody"></div>
  </div>
</div>

<!-- ADD MACHINE MODAL -->
<div class="modal-overlay" id="addMachineModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Add New Machine</h3>
      <button class="modal-close" onclick="closeModal('addMachineModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Machine ID</label><input type="text" id="amId" placeholder="AFI-XXX"></div>
        <div class="form-group"><label>Machine Name</label><input type="text" id="amName"></div>
        <div class="form-group"><label>Type</label><input type="text" id="amType"></div>
        <div class="form-group"><label>Location</label><select id="amLocation"></select></div>
        <div class="form-group"><label>Manufacturer</label><input type="text" id="amMfg"></div>
        <div class="form-group"><label>Model Number</label><input type="text" id="amModel"></div>
        <div class="form-group"><label>Service Freq (Days)</label><input type="number" id="amFreq" value="30"></div>
        <div class="form-group"><label>Status</label>
          <select id="amStatus">
            <option>Operational</option><option>Under Maintenance</option><option>Down - Critical</option>
            <option>Down - Non-Critical</option><option>Waiting Parts</option><option>Scheduled Downtime</option>
            <option>Out for Service</option><option>Decommissioned</option>
          </select>
        </div>
      </div>
      <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeModal('addMachineModal')">Cancel</button>
        <button class="btn btn-primary" onclick="addMachine()">Add Machine</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD OPERATOR MODAL -->
<div class="modal-overlay" id="addOperatorModal">
  <div class="modal" style="max-width:460px">
    <div class="modal-header">
      <h3>Add Operator</h3>
      <button class="modal-close" onclick="closeModal('addOperatorModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:14px"><label>Name / Initials</label><input type="text" id="aoName" placeholder="e.g. Mike T."></div>
      <div class="form-group" style="margin-bottom:14px"><label>Role</label>
        <select id="aoRole"><option>Technician</option><option>Lead Technician</option><option>External Service</option><option>Supervisor</option></select>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeModal('addOperatorModal')">Cancel</button>
        <button class="btn btn-primary" onclick="addOperator()">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- RESOLVE WORK ORDER MODAL -->
<div class="modal-overlay" id="resolveWoModal">
  <div class="modal" style="max-width:640px">
    <div class="modal-header">
      <h3 id="resolveWoTitle">Work Order Detail</h3>
      <button class="modal-close" onclick="closeModal('resolveWoModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="resolveWoInfo" style="margin-bottom:18px"></div>
      <div id="resolveWoForm">
        <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:14px">
          <h4 style="font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:var(--amber);margin-bottom:12px">Management / Tech Actions</h4>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Assign Tech</label>
            <select id="resolveAssignTech"></select>
          </div>
          <div class="form-group">
            <label>Priority</label>
            <select id="resolvePriority">
              <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="resolveStatus">
              <option>Open</option><option>Closed</option>
            </select>
          </div>
          <div class="form-group full">
            <label>Resolution / Work Notes</label>
            <textarea id="resolveNotes" placeholder="Describe diagnosis, work performed, parts replaced..."></textarea>
          </div>
          <div class="form-group">
            <label>Parts Used</label>
            <input type="text" id="resolvePartsUsed" placeholder="P/N, description...">
          </div>
          <div class="form-group">
            <label>Follow-up Required?</label>
            <select id="resolveFollowUp" onchange="toggleFollowUpDate()">
              <option value="No">No</option><option value="Yes">Yes</option>
            </select>
          </div>
        </div>
        <div id="followUpDateSection" style="display:none;margin-top:14px;background:var(--bg-tertiary);border:1px solid var(--amber-dim);border-radius:var(--radius);padding:14px 16px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
            <span style="font-size:16px">üìÖ</span>
            <span style="font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:var(--amber);font-weight:600">Follow-Up Scheduling</span>
          </div>
          <div class="form-grid" style="margin-bottom:0">
            <div class="form-group">
              <label>Follow-up Date</label>
              <input type="date" id="resolveFollowUpDate">
            </div>
            <div class="form-group">
              <label>Quick Select</label>
              <div style="display:flex;gap:6px;flex-wrap:wrap;padding-top:2px">
                <button type="button" class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="setFollowUpDays(7)">1 Wk</button>
                <button type="button" class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="setFollowUpDays(14)">2 Wks</button>
                <button type="button" class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="setFollowUpDays(30)">30d</button>
                <button type="button" class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="setFollowUpDays(45)">45d</button>
                <button type="button" class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="setFollowUpDays(60)">60d</button>
                <button type="button" class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="setFollowUpDays(90)">90d</button>
              </div>
            </div>
            <div class="form-group full">
              <label>Follow-up Notes</label>
              <input type="text" id="resolveFollowUpNotes" placeholder="e.g. Re-check seal after 500 hrs, order part and reschedule...">
            </div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--text-muted)">
            <span style="color:var(--amber)">‚ö°</span> This overrides the machine's next service due date so it appears in the overdue tracker on that date.
          </div>
        </div>
        <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
          <button class="btn btn-secondary" onclick="closeModal('resolveWoModal')">Cancel</button>
          <button class="btn btn-primary" onclick="resolveWorkOrder()">üíæ Save Changes</button>
        </div>
      </div>
    </div>
  </div>
</div>

<button class="scan-fab" id="scanFab" onclick="showPage('scan')" title="Scan Machine">üì∑</button>

<div class="toast-container" id="toastContainer"></div>

<script>
// ===================================================================
// DATA LAYER ‚Äî Mock data from real Excel, swappable to Airtable
// ===================================================================

const CONFIG = {
  airtable: {
    apiKey: '',
    baseId: '',
    tables: { machines: 'Machines', serviceLog: 'Service Log', operators: 'Operators' }
  },
  useAirtable: false
};

// Load saved settings
try {
  const saved = JSON.parse(localStorage.getItem('maint_settings') || '{}');
  if (saved.apiKey) { Object.assign(CONFIG.airtable, saved); CONFIG.useAirtable = !!saved.apiKey && !!saved.baseId; }
} catch(e) {}

// ===================================================================
// LOCAL PERSISTENCE (demo mode ‚Äî survives refresh)
// ===================================================================
const LocalStore = {
  _key: 'maint_data_v1',
  save() {
    if (CONFIG.useAirtable) return; // don't cache when Airtable is source of truth
    try {
      localStorage.setItem(this._key, JSON.stringify({
        machines, workOrders, operators, savedAt: new Date().toISOString()
      }));
    } catch(e) { /* quota exceeded ‚Äî fail silently */ }
  },
  load() {
    try {
      const raw = localStorage.getItem(this._key);
      if (!raw) return false;
      const data = JSON.parse(raw);
      if (data.machines) machines = data.machines;
      if (data.workOrders) workOrders = data.workOrders;
      if (data.operators) operators = data.operators;
      return true;
    } catch(e) { return false; }
  },
  clear() {
    localStorage.removeItem(this._key);
  }
};

// ---- OPERATORS (from Excel Lookup > Technicians) ----
let operators = [
  { id: 'op-1', name: 'EO', role: 'Technician', active: true },
  { id: 'op-2', name: 'NC', role: 'Technician', active: true },
  { id: 'op-3', name: 'JR', role: 'Technician', active: true },
  { id: 'op-4', name: 'Mike T.', role: 'Technician', active: true },
  { id: 'op-5', name: 'Carlos R.', role: 'Technician', active: true },
  { id: 'op-6', name: 'Alex', role: 'Technician', active: true },
  { id: 'op-7', name: 'Noel', role: 'Technician', active: true },
  { id: 'op-8', name: 'External Service', role: 'External Service', active: true },
];

// ---- MACHINES (from Excel Asset Registry ‚Äî all 19) ----
let machines = [
  { id:'AFI-221', name:'Oscilator Machine', type:'Foam Oscillating Cutter', location:'Rigid Foam', manufacturer:'Wintech', model:'D0Z2018-2225-BCT', serviceFreqDays:30, lastService:'2025-10-07', status:'Operational', manualLink:'https://wintech.com' },
  { id:'QFP-81', name:'Brown Machinery', type:'Plastic Machinery', location:'Raw Materials', manufacturer:'John Brown Plastic Machinery', model:'R-223-E', serviceFreqDays:60, lastService:'2025-11-26', status:'Operational', manualLink:'' },
  { id:'QFP-396', name:'Brown Machine', type:'Plastic Machinery', location:'Raw Materials', manufacturer:'Brown Machine', model:'n/a', serviceFreqDays:60, lastService:'2025-10-15', status:'Operational', manualLink:'' },
  { id:'QFP-544', name:'Bandsaw Jet 18', type:'Band Saw', location:'Fabrication', manufacturer:'JET', model:'JWBS-18QT', serviceFreqDays:90, lastService:'2025-10-21', status:'Operational', manualLink:'' },
  { id:'QFP-531A', name:'Flow Waterjet', type:'Waterjet', location:'Waterjet Dept', manufacturer:'WardJet', model:'4020 Quad Head', serviceFreqDays:30, lastService:'2025-08-01', status:'Down - Non-Critical', manualLink:'https://flowwaterjet.com' },
  { id:'AFI-125', name:'Bldg C Laminator', type:'Laminator', location:'Building C', manufacturer:'Veit-Kannegiesser', model:'Multstar CLF 1400L', serviceFreqDays:60, lastService:'2025-09-30', status:'Operational', manualLink:'' },
  { id:'AFI-33', name:'Seat Fab Router', type:'Router', location:'Seat Fab', manufacturer:'Grizzly', model:'G8030', serviceFreqDays:90, lastService:'2025-08-05', status:'Operational', manualLink:'https://grizzly.com' },
  { id:'QFP-577A', name:'Wardjet Z', type:'Waterjet', location:'Waterjet Dept', manufacturer:'Wardjet', model:'Z-2543', serviceFreqDays:30, lastService:'2025-10-02', status:'Operational', manualLink:'https://wardjet.com' },
  { id:'AFI-191', name:'Plastic Dept Maac ASP', type:'Vacuum Former', location:'Plastic Dept', manufacturer:'MAAC', model:'ASP', serviceFreqDays:45, lastService:'2025-08-07', status:'Down - Non-Critical', manualLink:'https://maacmachinery.com' },
  { id:'AFI-254', name:'Plastic Dept Maac', type:'Vacuum Former', location:'Plastic Dept', manufacturer:'MAAC', model:'C64S', serviceFreqDays:45, lastService:'2025-08-15', status:'Operational', manualLink:'https://maacmachinery.com' },
  { id:'AFI-87', name:'Gerber', type:'Leather Cut', location:'Building C', manufacturer:'Gerber Taurus 2', model:'n/a', serviceFreqDays:60, lastService:'2025-09-11', status:'Operational', manualLink:'https://lectra.com' },
  { id:'AFI-257', name:'PathFinder', type:'Fabric CNC', location:'Fabrication', manufacturer:'PathFinder', model:'8038', serviceFreqDays:60, lastService:'2025-11-11', status:'Operational', manualLink:'https://pathfindercutting.com' },
  { id:'AFI-16', name:'MAAC ASP #1', type:'Thermoformer', location:'Raw Materials', manufacturer:'MAAC', model:'ASP 4079', serviceFreqDays:45, lastService:'2025-12-08', status:'Operational', manualLink:'https://maacmachinery.com' },
  { id:'QFP-292', name:'JET Bandsaw', type:'Band Saw', location:'Fabrication', manufacturer:'JET', model:'JWBS-20-1', serviceFreqDays:90, lastService:'2025-10-06', status:'Operational', manualLink:'https://jettools.com' },
  { id:'QFP-561A', name:'JET Bandsaw 18"', type:'Band Saw', location:'Raw Materials', manufacturer:'JET', model:'JWBS-18QT', serviceFreqDays:90, lastService:'2025-09-23', status:'Operational', manualLink:'' },
  { id:'QFP-577B', name:'Hypertherm', type:'Intensifier', location:'Waterjet Dept', manufacturer:'Hypertherm', model:'HyPrecision 75s', serviceFreqDays:30, lastService:'2025-09-16', status:'Operational', manualLink:'https://hypertherm.com' },
  { id:'AFI-5/AFI-44A', name:'DMS(1)', type:'CNC Router Cooling', location:'CNC Routers', manufacturer:'Pfannenberg', model:'DTS-3041', serviceFreqDays:45, lastService:'2025-09-22', status:'Operational', manualLink:'https://pfannenberg.com' },
  { id:'AFI-42/AFI-44B', name:'DMS(2)', type:'CNC Router Cooling', location:'CNC Routers', manufacturer:'Pfannenberg', model:'DTS-3041', serviceFreqDays:45, lastService:'2025-09-22', status:'Operational', manualLink:'https://pfannenberg.com' },
  { id:'QFP-562', name:'WAPORA Bandsaw', type:'Vertical Foam Cut', location:'Fabrication', manufacturer:'AB WAPORA', model:'n/a', serviceFreqDays:60, lastService:'2025-11-17', status:'Operational', manualLink:'https://baumer.com' },
];

// ---- WORK ORDERS (sample from Excel Maintenance Log) ----
let workOrders = [
  { id:'WO-001', machineId:'AFI-125', machineName:'Bldg C Laminator', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-01', assignedTech:'EO', status:'Closed', notes:'Replaced Bearing', laborCost:0, partsCost:0 },
  { id:'WO-002', machineId:'QFP-531A', machineName:'Flow Waterjet', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-01', assignedTech:'EO', status:'Closed', notes:'Flow waterjet Wiring and grease', laborCost:0, partsCost:0 },
  { id:'WO-003', machineId:'AFI-125', machineName:'Bldg C Laminator', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-01', assignedTech:'EO', status:'Closed', notes:'Removed Bladder and grease', laborCost:0, partsCost:0 },
  { id:'WO-004', machineId:'QFP-531A', machineName:'Flow Waterjet', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-04', assignedTech:'EO', status:'Open', notes:'New wire Harness P/N 044107-5 / Greased Rails', laborCost:0, partsCost:0 },
  { id:'WO-005', machineId:'AFI-125', machineName:'Bldg C Laminator', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-04', assignedTech:'EO', status:'Closed', notes:'Greased and Clean / Replaced Bladder', laborCost:0, partsCost:0 },
  { id:'WO-006', machineId:'AFI-33', machineName:'Seat Fab Router', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-05', assignedTech:'EO', status:'Closed', notes:'ON/OFF SWITCH / REFIT AIR REGULATOR AND AIR HOSES', laborCost:0, partsCost:0 },
  { id:'WO-007', machineId:'QFP-577A', machineName:'Wardjet Z', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-05', assignedTech:'EO', status:'Closed', notes:'High Pressure line and Transition Block on head 1 to 4', laborCost:0, partsCost:0 },
  { id:'WO-008', machineId:'AFI-191', machineName:'Plastic Dept Maac ASP', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-07', assignedTech:'EO', status:'Open', notes:'Replaced Fuse for Oven', laborCost:0, partsCost:0 },
  { id:'WO-009', machineId:'QFP-577A', machineName:'Wardjet Z', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-06', assignedTech:'EO', status:'Closed', notes:'Replaced High pressure line', laborCost:0, partsCost:0 },
  { id:'WO-010', machineId:'AFI-254', machineName:'Plastic Dept Maac', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-15', assignedTech:'EO', status:'Closed', notes:'Replaced Disconnect on Clamp Frames', laborCost:0, partsCost:0 },
  { id:'WO-011', machineId:'AFI-257', machineName:'PathFinder', incidentType:'Corrective', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-14', assignedTech:'EO', status:'Closed', notes:'Switch on PathFinder (Fireblock Dept)', laborCost:0, partsCost:0 },
  { id:'WO-012', machineId:'QFP-81', machineName:'Brown Machinery', incidentType:'Preventive', priority:'Medium', category:'Scheduled PM', reportedBy:'EO', reportedDate:'2025-08-14', assignedTech:'EO', status:'Closed', notes:'Brown Machine Oven PM', laborCost:0, partsCost:0 },
  { id:'WO-013', machineId:'AFI-87', machineName:'Gerber', incidentType:'Preventive', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-09-11', assignedTech:'EO', status:'Closed', notes:'Gerber PM service - cleaned and inspected', laborCost:0, partsCost:0 },
  { id:'WO-014', machineId:'AFI-16', machineName:'MAAC ASP #1', incidentType:'Preventive', priority:'Medium', category:'Scheduled PM', reportedBy:'EO', reportedDate:'2025-12-08', assignedTech:'EO', status:'Closed', notes:'MAAC ASP quarterly PM completed', laborCost:0, partsCost:0 },
  { id:'WO-015', machineId:'QFP-577B', machineName:'Hypertherm', incidentType:'Corrective', priority:'High', category:'Pressure System', reportedBy:'EO', reportedDate:'2025-09-16', assignedTech:'EO', status:'Closed', notes:'Replaced seals on intensifier pump', laborCost:0, partsCost:0 },
];

const LOCATIONS = ['All Areas','CNC Routers','Waterjet Dept','Fabrication','Plastic Dept','Raw Materials','Seat Fab','Drum Fab','Building C','Rigid Foam'];

// ===================================================================
// AIRTABLE API LAYER
// ===================================================================
const AirtableAPI = {
  headers() {
    return { 'Authorization': `Bearer ${CONFIG.airtable.apiKey}`, 'Content-Type': 'application/json' };
  },
  baseUrl() {
    return `https://api.airtable.com/v0/${CONFIG.airtable.baseId}`;
  },
  async fetchAll(tableName) {
    let all = [], offset = null, page = 0;
    do {
      if (page > 0) await new Promise(r => setTimeout(r, 220)); // rate limit: stay under 5 RPS
      const url = `${this.baseUrl()}/${encodeURIComponent(tableName)}${offset ? '?offset='+offset : ''}`;
      const res = await fetch(url, { headers: this.headers() });
      if (!res.ok) throw new Error(`Airtable ${res.status}: ${res.statusText}`);
      const data = await res.json();
      all = all.concat(data.records);
      offset = data.offset;
      page++;
    } while (offset);
    return all;
  },
  async createRecord(tableName, fields) {
    const res = await fetch(`${this.baseUrl()}/${encodeURIComponent(tableName)}`, {
      method: 'POST', headers: this.headers(),
      body: JSON.stringify({ fields })
    });
    if (!res.ok) throw new Error(`Airtable ${res.status}`);
    return await res.json();
  },
  async updateRecord(tableName, recordId, fields) {
    const res = await fetch(`${this.baseUrl()}/${encodeURIComponent(tableName)}/${recordId}`, {
      method: 'PATCH', headers: this.headers(),
      body: JSON.stringify({ fields })
    });
    if (!res.ok) throw new Error(`Airtable ${res.status}`);
    return await res.json();
  },
  async testConnection() {
    const res = await fetch(`${this.baseUrl()}/${encodeURIComponent(CONFIG.airtable.tables.machines)}?maxRecords=1`, {
      headers: this.headers()
    });
    return res.ok;
  }
};

// ===================================================================
// DATA ACCESS (abstracts mock vs Airtable)
// ===================================================================
const DataService = {
  async getMachines() {
    if (CONFIG.useAirtable) {
      try {
        const records = await AirtableAPI.fetchAll(CONFIG.airtable.tables.machines);
        machines = records.map(r => ({
          _airtableId: r.id,
          id: r.fields['Machine_ID'] || r.fields['Machine ID'] || '',
          name: r.fields['Machine_Name'] || r.fields['Name'] || '',
          type: r.fields['Type'] || '',
          location: r.fields['Location'] || '',
          manufacturer: r.fields['Manufacturer'] || '',
          model: r.fields['Model'] || '',
          serviceFreqDays: r.fields['Service_Freq_Days'] || r.fields['Service Freq (Days)'] || 30,
          lastService: r.fields['Last_Service'] || r.fields['Last Service'] || '',
          status: r.fields['Status'] || r.fields['Current Status'] || 'Operational',
          manualLink: r.fields['Manual_Link'] || r.fields['Manual Link'] || '',
        }));
      } catch(e) { toast('Airtable fetch failed: ' + e.message, 'error'); }
    }
    return machines;
  },
  async getWorkOrders() {
    if (CONFIG.useAirtable) {
      try {
        const records = await AirtableAPI.fetchAll(CONFIG.airtable.tables.serviceLog);
        workOrders = records.map(r => ({
          _airtableId: r.id,
          id: r.fields['WO_ID'] || r.id,
          machineId: r.fields['Machine_ID'] || r.fields['Machine ID'] || '',
          machineName: r.fields['Machine_Name'] || r.fields['Machine Name'] || '',
          incidentType: r.fields['Incident_Type'] || r.fields['Incident Type'] || '',
          priority: r.fields['Priority'] || 'Medium',
          category: r.fields['Category'] || r.fields['Issue Category'] || '',
          reportedBy: r.fields['Reported_By'] || r.fields['Reported By'] || '',
          reportedDate: r.fields['Reported_Date'] || r.fields['Reported Date/Time'] || '',
          assignedTech: r.fields['Assigned_Tech'] || r.fields['Assigned Tech'] || '',
          status: r.fields['Status'] || '',
          notes: r.fields['Notes'] || r.fields['Resolution Notes'] || '',
          laborCost: r.fields['Labor_Cost'] || r.fields['Labor Cost'] || 0,
          partsCost: r.fields['Parts_Cost'] || r.fields['Parts Cost'] || 0,
          _isPM: r.fields['Is_PM'] || false,
          partsUsed: r.fields['Parts_Used'] || '',
          followUp: r.fields['Follow_Up'] || 'No',
          followUpDate: r.fields['Follow_Up_Date'] || '',
          followUpNotes: r.fields['Follow_Up_Notes'] || '',
          resolutionNotes: r.fields['Resolution_Notes'] || '',
          workStarted: r.fields['Work_Started'] || '',
          workCompleted: r.fields['Work_Completed'] || '',
        }));
      } catch(e) { toast('Airtable fetch failed: ' + e.message, 'error'); }
    }
    return workOrders;
  },
  async getOperators() {
    if (CONFIG.useAirtable) {
      try {
        const records = await AirtableAPI.fetchAll(CONFIG.airtable.tables.operators);
        operators = records.map(r => ({
          _airtableId: r.id,
          id: r.id,
          name: r.fields['Name'] || '',
          role: r.fields['Role'] || 'Technician',
          active: r.fields['Active'] !== false,
        }));
      } catch(e) { toast('Airtable fetch failed: ' + e.message, 'error'); }
    }
    return operators;
  },
  async addWorkOrder(wo) {
    if (CONFIG.useAirtable) {
      try {
        const fields = {
          'Machine_ID': wo.machineId,
          'Machine_Name': wo.machineName,
          'Incident_Type': wo.incidentType,
          'Priority': wo.priority,
          'Category': wo.category,
          'Reported_By': wo.reportedBy,
          'Reported_Date': wo.reportedDate,
          'Assigned_Tech': wo.assignedTech,
          'Status': wo.status,
          'Notes': wo.notes,
          'Is_PM': wo._isPM || false,
        };
        const result = await AirtableAPI.createRecord(CONFIG.airtable.tables.serviceLog, fields);
        wo._airtableId = result.id;
      } catch(e) {
        toast('Work order NOT saved ‚Äî Airtable write failed: ' + e.message, 'error');
        return false; // signal failure to caller
      }
    }
    workOrders.unshift(wo);
    LocalStore.save();
    return true;
  },
  async addMachine(m) {
    if (CONFIG.useAirtable) {
      try {
        const fields = {
          'Machine_ID': m.id, 'Machine_Name': m.name, 'Type': m.type,
          'Location': m.location, 'Manufacturer': m.manufacturer, 'Model': m.model,
          'Service_Freq_Days': m.serviceFreqDays, 'Status': m.status,
        };
        const result = await AirtableAPI.createRecord(CONFIG.airtable.tables.machines, fields);
        m._airtableId = result.id;
      } catch(e) {
        toast('Machine NOT saved ‚Äî Airtable write failed: ' + e.message, 'error');
        return false;
      }
    }
    machines.push(m);
    LocalStore.save();
    return true;
  },
  async addOperator(op) {
    if (CONFIG.useAirtable) {
      try {
        const fields = { 'Name': op.name, 'Role': op.role, 'Active': true };
        const result = await AirtableAPI.createRecord(CONFIG.airtable.tables.operators, fields);
        op._airtableId = result.id;
      } catch(e) {
        toast('Operator NOT saved ‚Äî Airtable write failed: ' + e.message, 'error');
        return false;
      }
    }
    operators.push(op);
    LocalStore.save();
  }
};

// ===================================================================
// UTILITY
// ===================================================================

// FIX: XSS sanitizer ‚Äî all user content must pass through this before innerHTML
function esc(str) {
  if (str === null || str === undefined) return '';
  const d = document.createElement('div');
  d.textContent = String(str);
  return d.innerHTML;
}

function daysSince(dateStr) {
  if (!dateStr) return 9999;
  const d = new Date(dateStr);
  const now = new Date();
  return Math.floor((now - d) / (1000*60*60*24));
}
function daysUntilService(machine) {
  if (!machine.lastService) return -9999;
  const last = new Date(machine.lastService);
  const next = new Date(last.getTime() + machine.serviceFreqDays * 86400000);
  const now = new Date();
  return Math.floor((next - now) / 86400000);
}
function nextServiceDate(machine) {
  if (!machine.lastService) return 'Unknown';
  const last = new Date(machine.lastService);
  const next = new Date(last.getTime() + machine.serviceFreqDays * 86400000);
  return next.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}
function formatDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}

// FIX: Error toasts persist 8s, critical errors persist until clicked
function toast(msg, type='success') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast ' + (type||'');
  t.textContent = msg;
  const duration = type === 'error' ? 8000 : 4000;
  t.style.cursor = 'pointer';
  t.onclick = () => t.remove();
  c.appendChild(t);
  setTimeout(() => { if (t.parentNode) t.remove(); }, duration);
}

// FIX: Collision-proof ID generation using timestamp + random
function uid() {
  return 'WO-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substring(2, 5).toUpperCase();
}

// FIX: Debounce for search inputs
function debounce(fn, ms) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), ms);
  };
}

// ===================================================================
// NAVIGATION
// ===================================================================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const btns = document.querySelectorAll('.nav-btn');
  const map = { dashboard:0, machines:1, workorders:2, scan:3, operators:4, settings:5 };
  if (map[name] !== undefined) btns[map[name]].classList.add('active');
  if (name === 'dashboard') refreshDashboard();
  if (name === 'machines') renderMachines();
  if (name === 'workorders') renderWorkOrders();
  if (name === 'operators') renderOperators();
  if (name === 'scan') document.getElementById('scanInput').focus();
  // Hide FAB when already on scan page
  const fab = document.getElementById('scanFab');
  if (fab) fab.classList.toggle('hide-on-scan', name === 'scan');
  // close mobile sidebar
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ===================================================================
// DASHBOARD
// ===================================================================
// ===================================================================
// AUTO-GENERATE PM WORK ORDERS
// ===================================================================
async function generatePMWorkOrders() {
  const overdueMachines = machines.filter(m => daysUntilService(m) < 0);
  let created = 0;

  for (const m of overdueMachines) {
    // Check if there's already an open PM work order for this machine
    const existingPM = workOrders.find(w =>
      w.machineId === m.id &&
      w.status === 'Open' &&
      w._isPM === true
    );
    if (existingPM) continue; // already queued, skip

    const daysOver = Math.abs(daysUntilService(m));
    const priority = daysOver > 90 ? 'High' : daysOver > 30 ? 'Medium' : 'Low';

    const wo = {
      id: uid(),
      machineId: m.id,
      machineName: m.name,
      incidentType: 'Preventive',
      priority: priority,
      category: 'Scheduled PM',
      reportedBy: 'System',
      reportedDate: new Date().toISOString().split('T')[0],
      assignedTech: '',
      status: 'Open',
      notes: `Auto-generated PM ‚Äî ${m.serviceFreqDays}-day service interval overdue by ${daysOver} days. Last serviced ${formatDate(m.lastService)}.`,
      laborCost: 0,
      partsCost: 0,
      partsUsed: '',
      followUp: 'No',
      followUpDate: '',
      followUpNotes: '',
      resolutionNotes: '',
      _isPM: true, // flag to prevent duplicates
    };

    await DataService.addWorkOrder(wo);
    created++;
  }

  if (created > 0) {
    toast(`${created} PM work order${created>1?'s':''} auto-generated for overdue machines`, 'warning');
  }
}

// ===================================================================
// DASHBOARD
// ===================================================================
async function refreshDashboard() {
  await DataService.getMachines();
  await DataService.getWorkOrders();

  // AUTO-GENERATE PM WORK ORDERS for overdue machines
  await generatePMWorkOrders();

  document.getElementById('dashDate').textContent = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  const overdue = machines.filter(m => daysUntilService(m) < 0);
  const openWO = workOrders.filter(w => w.status === 'Open');
  const closedWO = workOrders.filter(w => w.status === 'Closed');

  document.getElementById('openWoBadge').textContent = openWO.length;

  document.getElementById('kpiGrid').innerHTML = `
    <div class="kpi-card overdue"><div class="kpi-accent"></div><div class="kpi-icon">‚ö†Ô∏è</div><div class="kpi-value">${overdue.length}</div><div class="kpi-label">Overdue Services</div></div>
    <div class="kpi-card open"><div class="kpi-accent"></div><div class="kpi-icon">üîß</div><div class="kpi-value">${openWO.length}</div><div class="kpi-label">Open Work Orders</div></div>
    <div class="kpi-card total"><div class="kpi-accent"></div><div class="kpi-icon">üè≠</div><div class="kpi-value">${machines.length}</div><div class="kpi-label">Total Machines</div></div>
    <div class="kpi-card completed"><div class="kpi-accent"></div><div class="kpi-icon">‚úÖ</div><div class="kpi-value">${closedWO.length}</div><div class="kpi-label">Completed WOs</div></div>
  `;

  // Overdue table ‚Äî now links to the PM work order so management can assign directly
  const sorted = [...overdue].sort((a,b) => daysUntilService(a) - daysUntilService(b));
  document.getElementById('overdueCount').textContent = overdue.length + ' machines';
  const tbody = document.querySelector('#overdueTable tbody');
  tbody.innerHTML = sorted.slice(0,10).map(m => {
    const days = Math.abs(daysUntilService(m));
    const pmWO = workOrders.find(w => w.machineId === m.id && w.status === 'Open' && w._isPM);
    const clickAction = pmWO
      ? `onclick="openResolveWO('${pmWO.id}')" title="Click to assign tech & resolve"`
      : `onclick="openMachineDetail('${esc(m.id)}')"`;
    return `<tr style="cursor:pointer" ${clickAction}>
      <td class="machine-id">${esc(m.id)}</td>
      <td class="cell-name">${esc(m.name)}</td>
      <td><span style="color:var(--red);font-family:var(--font-mono);font-weight:600">${days}d</span></td>
      <td>${pmWO
        ? `<span class="badge-status badge-open" style="font-size:10px">${pmWO.id} ¬∑ ASSIGN ‚Üó</span>`
        : '<span class="badge-status badge-overdue">‚ö† OVERDUE</span>'
      }</td>
    </tr>`;
  }).join('');

  // WO Type chart
  const types = {};
  workOrders.forEach(w => { types[w.incidentType] = (types[w.incidentType]||0) + 1; });
  const maxType = Math.max(...Object.values(types), 1);
  const colors = { Corrective:'var(--red)', Preventive:'var(--green)', Emergency:'var(--amber)', Inspection:'var(--blue)', Repair:'var(--red)', Installation:'var(--purple)', Upgrade:'var(--cyan)' };
  document.getElementById('woTypeChart').innerHTML = Object.entries(types)
    .sort((a,b) => b[1]-a[1])
    .map(([k,v]) => `<div class="bar-chart-row">
      <div class="bar-label">${esc(k)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(v/maxType)*100}%;background:${colors[k]||'var(--blue)'}"></div></div>
      <div class="bar-count">${v}</div>
    </div>`).join('');

  // Recent Activity
  const recent = [...workOrders].sort((a,b) => new Date(b.reportedDate)-new Date(a.reportedDate)).slice(0,6);
  document.getElementById('recentActivity').innerHTML = recent.map(w => {
    const dotColor = w.status==='Open' ? 'var(--amber)' : 'var(--green)';
    const click = w.status==='Open' ? `onclick="openResolveWO('${esc(w.id)}')" style="cursor:pointer"` : '';
    return `<div class="activity-item" ${click}>
      <div class="activity-dot" style="background:${dotColor}"></div>
      <div>
        <div class="activity-text"><strong>${esc(w.machineId)}</strong> ‚Äî ${esc(w.notes.substring(0,60))}${w.notes.length>60?'...':''} ${w.status==='Open'?'<span style="color:var(--amber);font-size:11px">‚Üó OPEN</span>':''}</div>
        <div class="activity-time">${formatDate(w.reportedDate)} ¬∑ ${w.assignedTech || 'Unassigned'}</div>
      </div>
    </div>`;
  }).join('');

  // Location chart
  const locs = {};
  machines.forEach(m => { locs[m.location] = (locs[m.location]||0) + 1; });
  const maxLoc = Math.max(...Object.values(locs), 1);
  document.getElementById('locationChart').innerHTML = Object.entries(locs)
    .sort((a,b) => b[1]-a[1])
    .map(([k,v]) => `<div class="bar-chart-row">
      <div class="bar-label">${esc(k)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(v/maxLoc)*100}%;background:var(--cyan)"></div></div>
      <div class="bar-count">${v}</div>
    </div>`).join('');
}

// ===================================================================
// MACHINES
// ===================================================================
let machineLocationFilter = 'all';

function renderMachines() {
  document.getElementById('machineCount').textContent = machines.length;

  // Location filters
  const locs = [...new Set(machines.map(m=>m.location))].sort();
  document.getElementById('locationFilters').innerHTML =
    `<div class="filter-chip ${machineLocationFilter==='all'?'active':''}" onclick="machineLocationFilter='all';renderMachines()">All</div>` +
    locs.map(l => `<div class="filter-chip ${machineLocationFilter===l?'active':''}" onclick="machineLocationFilter='${l}';renderMachines()">${l}</div>`).join('');

  const search = (document.getElementById('machineSearch').value||'').toLowerCase();
  let filtered = machines.filter(m => {
    if (machineLocationFilter !== 'all' && m.location !== machineLocationFilter) return false;
    if (search && !(m.id+m.name+m.type+m.manufacturer).toLowerCase().includes(search)) return false;
    return true;
  });

  document.getElementById('machinesGrid').innerHTML = filtered.map(m => {
    const dts = daysUntilService(m);
    const isOverdue = dts < 0;
    const statusBadge = isOverdue ? '<span class="badge-status badge-overdue">‚ö† OVERDUE</span>' :
      m.status.includes('Down') ? '<span class="badge-status badge-critical">'+m.status+'</span>' :
      '<span class="badge-status badge-operational">'+m.status+'</span>';

    return `<div class="machine-card" onclick="openMachineDetail('${esc(m.id)}')">
      ${isOverdue ? '<div class="mc-overdue-bar"></div>' : ''}
      <div class="mc-top">
        <div class="mc-id">${esc(m.id)}</div>
        ${statusBadge}
      </div>
      <div class="mc-name">${esc(m.name)}</div>
      <div class="mc-type">${esc(m.type)} ¬∑ ${esc(m.manufacturer)}</div>
      <div class="mc-meta">
        <div><span class="label">Location</span>${esc(m.location)}</div>
        <div><span class="label">Service Freq</span>${m.serviceFreqDays}d</div>
        <div><span class="label">Next Service</span>${nextServiceDate(m)}</div>
      </div>
    </div>`;
  }).join('');
}

function filterMachines() { renderMachines(); }

function openAddMachine() {
  const sel = document.getElementById('amLocation');
  sel.innerHTML = LOCATIONS.map(l => `<option>${l}</option>`).join('');
  openModal('addMachineModal');
}

async function addMachine() {
  const m = {
    id: document.getElementById('amId').value.trim(),
    name: document.getElementById('amName').value.trim(),
    type: document.getElementById('amType').value.trim(),
    location: document.getElementById('amLocation').value,
    manufacturer: document.getElementById('amMfg').value.trim(),
    model: document.getElementById('amModel').value.trim(),
    serviceFreqDays: parseInt(document.getElementById('amFreq').value) || 30,
    lastService: new Date().toISOString().split('T')[0],
    status: document.getElementById('amStatus').value,
    manualLink: '',
  };
  if (!m.id || !m.name) { toast('Machine ID and Name required','error'); return; }
  await DataService.addMachine(m);
  closeModal('addMachineModal');
  renderMachines();
  toast('Machine added: ' + m.id);
}

function openMachineDetail(id) {
  const m = machines.find(x => x.id === id);
  if (!m) return;
  const dts = daysUntilService(m);
  const isOverdue = dts < 0;
  const mWOs = workOrders.filter(w => w.machineId === id).sort((a,b) => new Date(b.reportedDate)-new Date(a.reportedDate));

  document.getElementById('machineModalTitle').innerHTML = `<span style="color:var(--amber)">${esc(m.id)}</span> ‚Äî ${esc(m.name)}`;
  document.getElementById('machineModalBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
      <div><span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Type</span><br><span style="font-size:14px">${esc(m.type)}</span></div>
      <div><span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Location</span><br><span style="font-size:14px">${esc(m.location)}</span></div>
      <div><span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Manufacturer</span><br><span style="font-size:14px">${esc(m.manufacturer)}</span></div>
      <div><span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Model</span><br><span style="font-size:14px">${esc(m.model)}</span></div>
      <div><span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Service Freq</span><br><span style="font-size:14px">${m.serviceFreqDays} days</span></div>
      <div><span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Last Service</span><br><span style="font-size:14px">${formatDate(m.lastService)}</span></div>
      <div><span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Next Service</span><br><span style="font-size:14px;${isOverdue?'color:var(--red)':''}">${nextServiceDate(m)} ${isOverdue?'('+Math.abs(dts)+'d OVERDUE)':''}</span>
      ${m._followUpOverride ? `<br><span style="font-size:11px;color:var(--amber)">üìÖ Follow-up override: ${formatDate(m._followUpOverride)}</span>` : ''}
      ${m._followUpNotes ? `<br><span style="font-size:11px;color:var(--text-muted)">üìå ${m._followUpNotes}</span>` : ''}
      </div>
      <div><span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Status</span><br><span style="font-size:14px">${esc(m.status)}</span></div>
    </div>
    ${m.manualLink && /^https?:\/\//i.test(m.manualLink) ? `<a href="${esc(m.manualLink)}" target="_blank" rel="noopener" style="color:var(--amber);font-size:13px">üìÑ Manufacturer Manual ‚Üí</a><br><br>` : ''}
    <div style="border-top:1px solid var(--border);padding-top:16px">
      <h4 style="font-family:var(--font-mono);font-size:12px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:10px">Service History (${mWOs.length} records)</h4>
      ${mWOs.length ? `<table class="data-table"><thead><tr><th>Date</th><th>Type</th><th>Tech</th><th>Status</th><th>Notes</th></tr></thead><tbody>
        ${mWOs.slice(0,10).map(w => `<tr ${w.status==='Open'?`onclick="closeModal('machineModal');openResolveWO('${esc(w.id)}')" style="cursor:pointer"`:''}>
          <td style="white-space:nowrap">${formatDate(w.reportedDate)}</td>
          <td>${esc(w.incidentType)}</td>
          <td>${w.assignedTech || '<span style="color:var(--text-muted);font-style:italic">‚Äî</span>'}</td>
          <td><span class="badge-status ${w.status==='Open'?'badge-open':'badge-closed'}">${esc(w.status)}${w.status==='Open'?' ‚Üó':''}</span></td>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(w.notes)}</td>
        </tr>`).join('')}
      </tbody></table>` : '<p style="color:var(--text-muted);font-size:13px">No service history recorded.</p>'}
    </div>
    <div style="margin-top:16px">
      <button class="btn btn-primary" onclick="closeModal('machineModal');prefillWO('${esc(m.id)}')">üö® Report Issue</button>
    </div>
  `;
  openModal('machineModal');
}

// ===================================================================
// WORK ORDERS
// ===================================================================
let woFilterStatus = 'all';

function renderWorkOrders() {
  const search = (document.getElementById('woSearch').value||'').toLowerCase();
  let filtered = workOrders.filter(w => {
    if (woFilterStatus === 'Open' && w.status !== 'Open') return false;
    if (woFilterStatus === 'Closed' && w.status !== 'Closed') return false;
    if (woFilterStatus === 'PM' && !w._isPM) return false;
    if (woFilterStatus === 'Reported' && w._isPM) return false;
    if (search && !(w.machineId+w.machineName+w.notes+w.assignedTech+w.reportedBy).toLowerCase().includes(search)) return false;
    return true;
  });

  filtered.sort((a,b) => new Date(b.reportedDate) - new Date(a.reportedDate));

  const tbody = document.querySelector('#woTable tbody');
  tbody.innerHTML = filtered.map(w => {
    const prioColor = { Critical:'var(--red)', High:'var(--amber)', Medium:'var(--text-secondary)', Low:'var(--text-muted)' };
    const clickable = `onclick="openResolveWO('${esc(w.id)}')" style="cursor:pointer"`;
    const pmTag = w._isPM ? '<span style="background:var(--blue-dim);color:var(--blue);font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;font-family:var(--font-mono);margin-left:4px">PM</span>' : '';
    return `<tr ${clickable}>
      <td class="machine-id">${esc(w.machineId)}</td>
      <td class="cell-name">${esc(w.machineName)}${pmTag}</td>
      <td>${esc(w.incidentType)}</td>
      <td style="color:${prioColor[w.priority]||'inherit'};font-weight:600;font-size:12px">${esc(w.priority)}</td>
      <td>${esc(w.category)}</td>
      <td style="white-space:nowrap">${formatDate(w.reportedDate)}</td>
      <td>${w.assignedTech || '<span style="color:var(--text-muted);font-style:italic">Unassigned</span>'}</td>
      <td><span class="badge-status ${w.status==='Open'?'badge-open':'badge-closed'}">${esc(w.status)}</span></td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(w.notes)}</td>
    </tr>`;
  }).join('');
}

function filterWO(status, el) {
  woFilterStatus = status;
  document.querySelectorAll('#page-workorders .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderWorkOrders();
}
function filterWorkOrders() { renderWorkOrders(); }

function openNewWorkOrder() {
  document.getElementById('woModalTitle').textContent = 'Report Machine Issue';
  const sel = document.getElementById('woMachineId');
  sel.innerHTML = machines.map(m => `<option value="${esc(m.id)}">${esc(m.id)} ‚Äî ${esc(m.name)}</option>`).join('');
  autoFillMachine();
  populateTechSelects();
  openModal('woModal');
}

function prefillWO(machineId) {
  openNewWorkOrder();
  document.getElementById('woMachineId').value = machineId;
  autoFillMachine();
}

function autoFillMachine() {
  const id = document.getElementById('woMachineId').value;
  const m = machines.find(x => x.id === id);
  document.getElementById('woMachineName').value = m ? m.name : '';
}

function populateTechSelects() {
  const techHtml = operators.map(o => `<option value="${esc(o.name)}">${esc(o.name)}</option>`).join('');
  document.getElementById('woReportedBy').innerHTML = techHtml;
}

// ===================================================================
// RESOLVE / MANAGE WORK ORDER
// ===================================================================
let currentResolveWOId = null;

function openResolveWO(woId) {
  const w = workOrders.find(x => x.id === woId);
  if (!w) return;
  currentResolveWOId = woId;

  const m = machines.find(x => x.id === w.machineId);
  const dts = m ? daysUntilService(m) : null;
  const isOverdue = dts !== null && dts < 0;

  document.getElementById('resolveWoTitle').innerHTML = `<span style="color:var(--amber)">${esc(w.id)}</span> ‚Äî ${esc(w.machineId)}`;

  const isPM = w._isPM;
  const descLabel = isPM ? 'System PM Notice' : "Operator's Description";
  const descBorderColor = isPM ? 'var(--blue)' : 'var(--amber)';

  // Info section
  document.getElementById('resolveWoInfo').innerHTML = `
    ${isPM ? '<div style="background:var(--blue-dim);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius);padding:10px 14px;margin-bottom:10px;display:flex;align-items:center;gap:8px"><span style="font-size:16px">üîÑ</span><span style="font-size:13px;color:var(--blue);font-weight:600">Auto-Generated PM Work Order</span><span style="font-size:12px;color:var(--text-muted);margin-left:auto">Assign a tech to get this done</span></div>' : ''}
    <div style="background:var(--bg-tertiary);border-radius:var(--radius);padding:14px 16px;margin-bottom:4px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Machine</span><br>
          <span style="font-family:var(--font-mono);color:var(--amber);font-weight:600">${esc(w.machineId)}</span> ‚Äî ${esc(w.machineName)}</div>
        <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Location</span><br>${m ? m.location : '‚Äî'}</div>
        <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">${isPM ? 'Generated' : 'Reported By'}</span><br>${esc(w.reportedBy)}</div>
        <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Date</span><br>${formatDate(w.reportedDate)}</div>
        <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Type</span><br>${esc(w.incidentType)}</div>
        <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Category</span><br>${esc(w.category)}</div>
        ${w.workStarted || w.workCompleted ? `
        <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Work Started</span><br>${w.workStarted ? formatDate(w.workStarted) : '<span style="color:var(--text-muted)">‚Äî</span>'}</div>
        <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">${w.workCompleted ? 'Completed' : 'Turnaround'}</span><br>${w.workCompleted ? formatDate(w.workCompleted) + (w.workStarted ? ' <span style="font-size:11px;color:var(--green);font-family:var(--font-mono)">(' + Math.max(1, Math.round((new Date(w.workCompleted) - new Date(w.workStarted)) / 86400000)) + 'd)</span>' : '') : (w.workStarted ? '<span style="font-family:var(--font-mono);color:var(--amber)">' + Math.max(1, Math.round((new Date() - new Date(w.workStarted)) / 86400000)) + 'd in progress</span>' : '‚Äî')}</div>
        ` : ''}
      </div>
      <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">${descLabel}</span>
        <p style="margin-top:4px;font-size:13.5px;color:var(--text-primary);line-height:1.5;background:var(--bg-card);padding:10px 12px;border-radius:var(--radius);border-left:3px solid ${descBorderColor}">${w.notes || '<span style="color:var(--text-muted);font-style:italic">No description provided</span>'}</p>
      </div>
      ${w.resolutionNotes ? `<div style="margin-top:10px"><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Resolution Notes</span>
        <p style="margin-top:4px;font-size:13px;color:var(--text-secondary);line-height:1.4;background:var(--bg-card);padding:10px 12px;border-radius:var(--radius);border-left:3px solid var(--green)">${esc(w.resolutionNotes)}</p>
      </div>` : ''}
      <div style="margin-top:10px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <span class="badge-status ${w.status==='Open'?'badge-open':'badge-closed'}">${esc(w.status)}</span>
        ${w.assignedTech ? `<span style="font-size:12px;color:var(--text-secondary)">Assigned: <strong>${esc(w.assignedTech)}</strong></span>` : '<span style="font-size:12px;color:var(--text-muted);font-style:italic">‚ö† No tech assigned yet</span>'}
        ${isOverdue ? `<span class="badge-status badge-overdue">Machine ${Math.abs(dts)}d OVERDUE</span>` : ''}
        ${w.followUp==='Yes' && w.followUpDate ? `<span style="font-size:12px;color:var(--amber);font-family:var(--font-mono)">üìÖ Follow-up: ${formatDate(w.followUpDate)}</span>` : ''}
      </div>
      ${w.followUpNotes ? `<div style="margin-top:8px;font-size:12px;color:var(--text-secondary);padding:6px 10px;background:var(--bg-card);border-radius:var(--radius);border-left:2px solid var(--amber)">üìå ${esc(w.followUpNotes)}</div>` : ''}
    </div>
  `;

  // Pre-fill form fields with current values
  const techSelect = document.getElementById('resolveAssignTech');
  techSelect.innerHTML = '<option value="">‚Äî Select Tech ‚Äî</option>' + operators.map(o => `<option value="${esc(o.name)}" ${w.assignedTech===o.name?'selected':''}>${esc(o.name)}</option>`).join('');
  document.getElementById('resolvePriority').value = w.priority || 'Medium';
  document.getElementById('resolveStatus').value = w.status || 'Open';
  document.getElementById('resolveNotes').value = w.resolutionNotes || '';
  document.getElementById('resolvePartsUsed').value = w.partsUsed || '';
  document.getElementById('resolveFollowUp').value = w.followUp || 'No';

  // Handle follow-up date section
  const fuSection = document.getElementById('followUpDateSection');
  if (w.followUp === 'Yes') {
    fuSection.style.display = 'block';
    document.getElementById('resolveFollowUpDate').value = w.followUpDate || '';
    document.getElementById('resolveFollowUpNotes').value = w.followUpNotes || '';
  } else {
    fuSection.style.display = 'none';
    document.getElementById('resolveFollowUpDate').value = '';
    document.getElementById('resolveFollowUpNotes').value = '';
  }

  openModal('resolveWoModal');
}

async function resolveWorkOrder() {
  const w = workOrders.find(x => x.id === currentResolveWOId);
  if (!w) return;

  const newStatus = document.getElementById('resolveStatus').value;
  const assignedTech = document.getElementById('resolveAssignTech').value;
  const resNotes = document.getElementById('resolveNotes').value.trim();
  const followUp = document.getElementById('resolveFollowUp').value;
  const followUpDate = document.getElementById('resolveFollowUpDate').value;
  const followUpNotes = document.getElementById('resolveFollowUpNotes').value.trim();

  // Update the work order in local state
  // Track Work_Started: first time a tech is assigned = work begins
  if (assignedTech && !w.assignedTech && !w.workStarted) {
    w.workStarted = new Date().toISOString().split('T')[0];
  }
  w.assignedTech = assignedTech;
  w.priority = document.getElementById('resolvePriority').value;
  w.status = newStatus;
  w.resolutionNotes = resNotes;
  w.partsUsed = document.getElementById('resolvePartsUsed').value.trim();
  w.followUp = followUp;
  w.followUpDate = followUpDate || '';
  w.followUpNotes = followUpNotes;

  const m = machines.find(x => x.id === w.machineId);

  if (followUp === 'Yes' && followUpDate && m) {
    const fuDate = new Date(followUpDate);
    const fakeLastService = new Date(fuDate.getTime() - m.serviceFreqDays * 86400000);
    m.lastService = fakeLastService.toISOString().split('T')[0];
    m._followUpOverride = followUpDate;
    m._followUpNotes = followUpNotes;
  } else if (newStatus === 'Closed' && followUp !== 'Yes') {
    if (m) { m.lastService = new Date().toISOString().split('T')[0]; }
  }

  if (newStatus === 'Closed') {
    w.workCompleted = new Date().toISOString().split('T')[0];
  }

  // Push to Airtable if connected
  if (CONFIG.useAirtable && w._airtableId) {
    try {
      const updateFields = {
        'Assigned_Tech': w.assignedTech,
        'Priority': w.priority,
        'Status': w.status,
        'Resolution_Notes': w.resolutionNotes,
        'Parts_Used': w.partsUsed,
        'Follow_Up': w.followUp,
        'Follow_Up_Date': w.followUpDate || null,
        'Follow_Up_Notes': w.followUpNotes || '',
      };
      if (w.workStarted) updateFields['Work_Started'] = w.workStarted;
      if (w.workCompleted) updateFields['Work_Completed'] = w.workCompleted;
      await AirtableAPI.updateRecord(CONFIG.airtable.tables.serviceLog, w._airtableId, updateFields);
    } catch(e) { toast('Airtable update failed: ' + e.message, 'error'); }
  }

  closeModal('resolveWoModal');
  LocalStore.save();
  renderWorkOrders();

  if (followUp === 'Yes' && followUpDate) {
    toast(`${esc(w.id)} ‚Äî follow-up scheduled for ${formatDate(followUpDate)}. Next service date updated.`, 'warning');
  } else if (newStatus === 'Closed') {
    toast(`${esc(w.id)} resolved and closed${assignedTech ? ' by ' + assignedTech : ''}`);
  } else {
    toast(`${esc(w.id)} updated`);
  }

  // Update badge count
  const openCount = workOrders.filter(x => x.status === 'Open').length;
  document.getElementById('openWoBadge').textContent = openCount;
}

function toggleFollowUpDate() {
  const val = document.getElementById('resolveFollowUp').value;
  const section = document.getElementById('followUpDateSection');
  section.style.display = val === 'Yes' ? 'block' : 'none';
  if (val === 'Yes') {
    // Default to machine's current service freq from today
    const w = workOrders.find(x => x.id === currentResolveWOId);
    if (w) {
      const m = machines.find(x => x.id === w.machineId);
      if (m) {
        const defaultDate = new Date(Date.now() + m.serviceFreqDays * 86400000);
        document.getElementById('resolveFollowUpDate').value = defaultDate.toISOString().split('T')[0];
      }
    }
  }
}

function setFollowUpDays(days) {
  const d = new Date(Date.now() + days * 86400000);
  document.getElementById('resolveFollowUpDate').value = d.toISOString().split('T')[0];
}

async function submitWorkOrder() {
  const wo = {
    id: uid(),
    machineId: document.getElementById('woMachineId').value,
    machineName: document.getElementById('woMachineName').value,
    incidentType: document.getElementById('woIncidentType').value,
    priority: document.getElementById('woPriorityAlt').value,
    category: document.getElementById('woCategory').value,
    reportedBy: document.getElementById('woReportedBy').value,
    reportedDate: new Date().toISOString().split('T')[0],
    assignedTech: '',
    status: 'Open',
    notes: document.getElementById('woNotes').value,
    laborCost: 0,
    partsCost: 0,
    partsUsed: '',
    followUp: 'No',
    resolutionNotes: '',
  };
  if (!wo.machineId) { toast('Select a machine','error'); return; }
  if (!wo.notes.trim()) { toast('Describe the problem so we can start diagnosing','warning'); return; }
  await DataService.addWorkOrder(wo);
  closeModal('woModal');
  renderWorkOrders();
  toast('Work order submitted: ' + wo.id + ' ‚Äî management will assign a tech');
  document.getElementById('woNotes').value = '';
}

// ===================================================================
// SCAN
// ===================================================================
function scanMachine() {
  const input = document.getElementById('scanInput').value.trim().toUpperCase();
  if (!input) return;
  // strip asterisks from barcode scan
  const clean = input.replace(/\*/g, '');
  const m = machines.find(x => x.id.toUpperCase() === clean || x.id.toUpperCase().replace(/[()]/g,'') === clean);
  const resultDiv = document.getElementById('scanResult');

  if (!m) {
    resultDiv.innerHTML = `<div class="panel" style="border-left:3px solid var(--red)">
      <div class="panel-body"><p style="color:var(--red);font-weight:600">No machine found for ID: ${esc(clean)}</p><p style="color:var(--text-muted);font-size:13px;margin-top:4px">Check the ID and try again, or add a new machine from the Machines page.</p></div>
    </div>`;
    // Refocus for next scan
    const si = document.getElementById('scanInput');
    si.value = ''; si.focus(); si.select();
    return;
  }

  const dts = daysUntilService(m);
  const isOverdue = dts < 0;
  const mWOs = workOrders.filter(w => w.machineId === m.id).sort((a,b) => new Date(b.reportedDate)-new Date(a.reportedDate)).slice(0,5);

  resultDiv.innerHTML = `
    <div class="panel" style="border-left:3px solid var(--amber)">
      <div class="panel-header">
        <h3><span style="color:var(--amber)">${esc(m.id)}</span> ‚Äî ${esc(m.name)}</h3>
        ${isOverdue ? '<span class="badge-status badge-overdue">‚ö† OVERDUE '+Math.abs(dts)+'d</span>' : '<span class="badge-status badge-operational">'+m.status+'</span>'}
      </div>
      <div class="panel-body">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px">
          <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Type</span><br>${esc(m.type)}</div>
          <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Location</span><br>${esc(m.location)}</div>
          <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Mfg</span><br>${esc(m.manufacturer)}</div>
          <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Service Freq</span><br>${m.serviceFreqDays}d</div>
          <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Last Service</span><br>${formatDate(m.lastService)}</div>
          <div><span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase">Next Service</span><br><span style="${isOverdue?'color:var(--red)':''}">${nextServiceDate(m)}</span></div>
        </div>
        ${mWOs.length ? `<h4 style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);text-transform:uppercase;margin-bottom:8px">Recent Service History</h4>
        <table class="data-table"><thead><tr><th>Date</th><th>Type</th><th>Tech</th><th>Status</th><th>Notes</th></tr></thead><tbody>
        ${mWOs.map(w => `<tr ${w.status==='Open'?`onclick="openResolveWO('${esc(w.id)}')" style="cursor:pointer"`:''}>
          <td style="white-space:nowrap">${formatDate(w.reportedDate)}</td><td>${esc(w.incidentType)}</td><td>${w.assignedTech || '<span style="color:var(--text-muted)">‚Äî</span>'}</td>
          <td><span class="badge-status ${w.status==='Open'?'badge-open':'badge-closed'}">${esc(w.status)}${w.status==='Open'?' ‚Üó':''}</span></td>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(w.notes)}</td></tr>`).join('')}
        </tbody></table>` : ''}
        <div style="margin-top:16px;display:flex;gap:10px">
          <button class="btn btn-primary" onclick="prefillWO('${esc(m.id)}')">üö® Report Issue</button>
          <button class="btn btn-secondary" onclick="openMachineDetail('${esc(m.id)}')">Full Details</button>
        </div>
      </div>
    </div>`;

  // Refocus for next scan
  const si = document.getElementById('scanInput');
  si.value = ''; si.focus(); si.select();
}

// ===================================================================
// OPERATORS
// ===================================================================
function renderOperators() {
  const tbody = document.querySelector('#operatorsTable tbody');
  tbody.innerHTML = operators.map(o => {
    const woCount = workOrders.filter(w => w.assignedTech === o.name).length;
    return `<tr>
      <td class="cell-name" style="font-family:var(--font-mono);font-weight:600">${esc(o.name)}</td>
      <td>${esc(o.role)}</td>
      <td style="font-family:var(--font-mono)">${woCount}</td>
      <td><span class="badge-status ${o.active?'badge-operational':'badge-critical'}">${o.active?'Active':'Inactive'}</span></td>
    </tr>`;
  }).join('');
}

function openAddOperator() { openModal('addOperatorModal'); }

async function addOperator() {
  const name = document.getElementById('aoName').value.trim();
  if (!name) { toast('Name required','error'); return; }
  const op = { id: 'op-'+Date.now(), name, role: document.getElementById('aoRole').value, active: true };
  await DataService.addOperator(op);
  closeModal('addOperatorModal');
  renderOperators();
  toast('Operator added: ' + name);
  document.getElementById('aoName').value = '';
}

// ===================================================================
// SETTINGS
// ===================================================================
function saveSettings() {
  CONFIG.airtable.apiKey = document.getElementById('atApiKey').value.trim();
  CONFIG.airtable.baseId = document.getElementById('atBaseId').value.trim();
  CONFIG.airtable.tables.machines = document.getElementById('atMachinesTable').value.trim();
  CONFIG.airtable.tables.serviceLog = document.getElementById('atServiceTable').value.trim();
  CONFIG.airtable.tables.operators = document.getElementById('atOperatorsTable').value.trim();
  CONFIG.useAirtable = !!CONFIG.airtable.apiKey && !!CONFIG.airtable.baseId;

  localStorage.setItem('maint_settings', JSON.stringify(CONFIG.airtable));
  updateConnStatus();
  toast('Settings saved');

  if (CONFIG.useAirtable) {
    refreshDashboard();
  }
}

async function testConnection() {
  CONFIG.airtable.apiKey = document.getElementById('atApiKey').value.trim();
  CONFIG.airtable.baseId = document.getElementById('atBaseId').value.trim();
  if (!CONFIG.airtable.apiKey || !CONFIG.airtable.baseId) { toast('Enter API key and Base ID first','error'); return; }
  document.getElementById('connStatus').textContent = 'Testing connection...';
  try {
    const ok = await AirtableAPI.testConnection();
    document.getElementById('connStatus').innerHTML = ok
      ? '<span style="color:var(--green)">‚úì Connection successful</span>'
      : '<span style="color:var(--red)">‚úó Connection failed ‚Äî check credentials</span>';
  } catch(e) {
    document.getElementById('connStatus').innerHTML = `<span style="color:var(--red)">‚úó ${e.message}</span>`;
  }
}

function disconnectAirtable() {
  if (!confirm('Disconnect from Airtable? The app will switch to demo mode with local data only.')) return;
  CONFIG.airtable.apiKey = '';
  CONFIG.airtable.baseId = '';
  CONFIG.useAirtable = false;
  document.getElementById('atApiKey').value = '';
  document.getElementById('atBaseId').value = '';
  localStorage.removeItem('maint_settings');
  updateConnStatus();
  toast('Disconnected from Airtable');
}

function resetDemoData() {
  if (!confirm('Reset all local data to factory defaults? This clears all work orders, machines, and operators you have added in demo mode. This cannot be undone.')) return;
  LocalStore.clear();
  location.reload();
}

function updateConnStatus() {
  const dot = document.getElementById('connDot');
  const label = document.getElementById('connLabel');
  if (CONFIG.useAirtable) {
    dot.style.background = 'var(--green)';
    label.textContent = 'Airtable Connected';
  } else {
    dot.style.background = 'var(--amber)';
    label.textContent = 'Demo Mode';
  }
}

function exportData() {
  const data = { machines, workOrders, operators, exported: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'maintenance_data_' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
}

// ===================================================================
// INIT
// ===================================================================
(async function init() {
  updateConnStatus();

  // FIX: Load persisted data in demo mode (survives page refresh)
  if (!CONFIG.useAirtable) {
    const loaded = LocalStore.load();
    if (loaded) {
      toast('Data restored from local storage', 'success');
    }
  }

  // Prefill settings fields
  if (CONFIG.airtable.apiKey) document.getElementById('atApiKey').value = CONFIG.airtable.apiKey;
  if (CONFIG.airtable.baseId) document.getElementById('atBaseId').value = CONFIG.airtable.baseId;
  if (CONFIG.airtable.tables.machines) document.getElementById('atMachinesTable').value = CONFIG.airtable.tables.machines;
  if (CONFIG.airtable.tables.serviceLog) document.getElementById('atServiceTable').value = CONFIG.airtable.tables.serviceLog;
  if (CONFIG.airtable.tables.operators) document.getElementById('atOperatorsTable').value = CONFIG.airtable.tables.operators;

  // FIX: Debounce search inputs (300ms)
  const debouncedMachineSearch = debounce(() => renderMachines(), 300);
  const debouncedWOSearch = debounce(() => renderWorkOrders(), 300);
  document.getElementById('machineSearch').removeAttribute('oninput');
  document.getElementById('woSearch').removeAttribute('oninput');
  document.getElementById('machineSearch').addEventListener('input', debouncedMachineSearch);
  document.getElementById('woSearch').addEventListener('input', debouncedWOSearch);

  await refreshDashboard();
})();
</script>
</body>
</html>
