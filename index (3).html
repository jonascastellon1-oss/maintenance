<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Machine Maintenance System</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #f5f6fa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #eef0f6;
  --bg-card: #ffffff;
  --bg-card-hover: #f0f1f5;
  --border: #d8dce6;
  --border-light: #c5cad8;
  --text-primary: #1a1d2e;
  --text-secondary: #5c6178;
  --text-muted: #6b7080;
  --amber: #d97706;
  --amber-dim: #92400e;
  --amber-glow: rgba(217, 119, 6, 0.1);
  --red: #dc2626;
  --red-dim: rgba(220, 38, 38, 0.08);
  --green: #16a34a;
  --green-dim: rgba(22, 163, 74, 0.08);
  --blue: #2563eb;
  --blue-dim: rgba(37, 99, 235, 0.08);
  --purple: #7c3aed;
  --purple-dim: rgba(124, 58, 237, 0.08);
  --cyan: #0891b2;
  --font-mono: 'JetBrains Mono', monospace;
  --font-body: 'DM Sans', sans-serif;
  --radius: 8px;
  --radius-lg: 12px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#loginScreen {
  position: fixed; inset: 0; z-index: 9999;
  background: var(--bg-primary);
  display: flex; align-items: center; justify-content: center;
}
.login-card {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 40px 44px; width: 360px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12); text-align: center;
}
.login-logo {
  width: 52px; height: 52px;
  background: linear-gradient(135deg, var(--amber), #b45309);
  border-radius: 12px; display: flex; align-items: center; justify-content: center;
  font-size: 26px; margin: 0 auto 18px;
}
.login-card h2 { font-size: 19px; margin-bottom: 4px; }
.login-card p  { color: var(--text-muted); font-size: 13px; margin-bottom: 24px; }
.mode-tiles { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 22px; }
.mode-tile {
  border: 2px solid var(--border); border-radius: var(--radius);
  padding: 13px 6px; cursor: pointer;
  transition: border-color .15s, background .15s;
}
.mode-tile:hover  { border-color: var(--amber); background: var(--amber-glow); }
.mode-tile.selected { border-color: var(--amber); background: var(--amber-glow); }
.mode-tile .t-icon  { font-size: 20px; margin-bottom: 5px; }
.mode-tile .t-label { font-size: 11px; font-weight: 700; font-family: var(--font-mono);
                       text-transform: uppercase; letter-spacing: .5px; }
.login-pin input {
  width: 100%; text-align: center; font-size: 24px;
  font-family: var(--font-mono); letter-spacing: 8px;
  padding: 10px; margin-bottom: 8px; border-radius: var(--radius);
  border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary);
}
#loginErr { color: var(--red); font-size: 12px; min-height: 18px; margin-bottom: 10px; }
/* ‚îÄ‚îÄ MODE BADGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.mode-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 9px; border-radius: 20px;
  font-size: 11px; font-weight: 700; font-family: var(--font-mono);
  text-transform: uppercase; letter-spacing: .4px; cursor: pointer;
  margin-top: 6px;
}
.mode-badge.admin    { background: var(--amber-glow); color: var(--amber); border: 1px solid rgba(217,119,6,.4); }
.mode-badge.tech     { background: var(--blue-dim);   color: var(--blue);  border: 1px solid rgba(37,99,235,.3); }
.mode-badge.operator { background: var(--green-dim);  color: var(--green); border: 1px solid rgba(22,163,74,.3); }
/* ‚îÄ‚îÄ MACHINE AUTOCOMPLETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.machine-id-wrap { position: relative; }
#woMachineSuggestions {
  position: absolute; top: calc(100% + 2px); left: 0; right: 0; z-index: 600;
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius); box-shadow: 0 6px 18px rgba(0,0,0,0.13);
  max-height: 220px; overflow-y: auto; display: none;
}
.ms-item {
  padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--bg-tertiary);
  display: flex; gap: 10px; align-items: baseline;
}
.ms-item:last-child { border-bottom: none; }
.ms-item:hover, .ms-item.hi { background: var(--amber-glow); }
.ms-id   { font-family: var(--font-mono); font-size: 12px; font-weight: 700;
            color: var(--amber); min-width: 90px; flex-shrink: 0; }
.ms-name { font-size: 12px; color: var(--text-secondary);
           white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
/* ‚îÄ‚îÄ LOCKED FIELD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.field-locked {
  background: var(--bg-tertiary); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 8px 10px;
  font-size: 14px; color: var(--text-secondary); display: flex;
  align-items: center; gap: 6px;
}
.field-locked .lock-icon { font-size: 11px; opacity: .5; }
body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}
/* LAYOUT */
.app-shell { display: flex; min-height: 100vh; }
.sidebar {
  width: 240px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  z-index: 100;
  transition: transform 0.3s ease;
  box-shadow: 1px 0 4px rgba(0,0,0,0.06);
}
.sidebar-brand {
  padding: 20px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
}
.sidebar-brand .logo {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, var(--amber), #d97706);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}
.sidebar-brand h1 {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: var(--text-primary);
  line-height: 1.3;
}
.sidebar-brand span {
  font-size: 10px;
  color: var(--text-muted);
  font-weight: 400;
  text-transform: none;
  letter-spacing: 0;
}
.sidebar-nav { padding: 12px 10px; flex: 1; }
.nav-section-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-muted);
  padding: 12px 10px 6px;
}
.nav-btn {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-family: var(--font-body);
  font-size: 13.5px;
  font-weight: 500;
  cursor: pointer;
  border-radius: var(--radius);
  transition: all 0.15s;
  text-align: left;
}
.nav-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.nav-btn.active {
  background: var(--amber-glow);
  color: var(--amber);
}
.nav-btn .icon { font-size: 17px; width: 22px; text-align: center; }
.nav-btn .badge {
  margin-left: auto;
  background: var(--red);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  font-family: var(--font-mono);
}
.sidebar-footer {
  padding: 14px 18px;
  border-top: 1px solid var(--border);
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}
.sidebar-footer .status-dot {
  display: inline-block;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--green);
  margin-right: 6px;
  animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
.main-content {
  margin-left: 240px;
  flex: 1;
  min-height: 100vh;
}
.page-header {
  padding: 22px 32px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-secondary);
  position: sticky;
  top: 0;
  z-index: 50;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.page-header h2 {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 600;
  letter-spacing: -0.3px;
}
.page-header .subtitle {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 2px;
}
.page-body { padding: 24px 32px; }

/* MOBILE */
.mobile-header {
  display: none;
  position: sticky;
  top: 0;
  z-index: 90;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border);
  padding: 12px 16px;
  align-items: center;
  justify-content: space-between;
}
.hamburger {
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 22px;
  cursor: pointer;
  padding: 4px;
}
.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 99;
}

@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.open { display: block; }
  .mobile-header { display: flex; }
  .main-content { margin-left: 0; }
  .page-header { padding: 16px; }
  .page-body { padding: 16px; }
  .kpi-grid { grid-template-columns: repeat(2, 1fr) !important; }
  .machines-grid { grid-template-columns: 1fr !important; }
}

/* KPI CARDS */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}
.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.kpi-card:hover { border-color: var(--border-light); }
.kpi-card .kpi-icon {
  font-size: 20px;
  margin-bottom: 10px;
}
.kpi-card .kpi-value {
  font-family: var(--font-mono);
  font-size: 28px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 4px;
}
.kpi-card .kpi-label {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.kpi-card .kpi-accent {
  position: absolute;
  top: 0;
  right: 0;
  width: 60px;
  height: 60px;
  border-radius: 0 var(--radius-lg) 0 60px;
  opacity: 0.1;
}
.kpi-card.overdue .kpi-value { color: var(--red); }
.kpi-card.overdue .kpi-accent { background: var(--red); }
.kpi-card.open .kpi-value { color: var(--amber); }
.kpi-card.open .kpi-accent { background: var(--amber); }
.kpi-card.total .kpi-value { color: var(--blue); }
.kpi-card.total .kpi-accent { background: var(--blue); }
.kpi-card.completed .kpi-value { color: var(--green); }
.kpi-card.completed .kpi-accent { background: var(--green); }

/* PANELS / SECTIONS */
.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 20px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.panel-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.panel-header h3 {
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.panel-body { padding: 16px 20px; }

/* STATUS BADGES */
.badge-status {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 20px;
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.badge-overdue { background: var(--red-dim); color: var(--red); }
.badge-open { background: var(--amber-glow); color: var(--amber); }
.badge-pending { background: #fef3c7; color: #d97706; }
.badge-closed { background: var(--green-dim); color: var(--green); }
.detail-label { font-size: 11px; color: var(--text-muted); font-family: var(--font-mono); text-transform: uppercase; }
.detail-label-sm { font-size: 10px; color: var(--text-muted); font-family: var(--font-mono); text-transform: uppercase; }
.detail-value { font-size: 14px; }
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.detail-grid-auto { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; }
.section-divider { border-top: 1px solid var(--border); padding-top: 16px; }
.section-heading { font-family: var(--font-mono); font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 10px; }
.cell-truncate { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.badge-operational { background: var(--green-dim); color: var(--green); }
.badge-critical { background: var(--red-dim); color: var(--red); }
.badge-maintenance { background: var(--blue-dim); color: var(--blue); }
.badge-waiting { background: var(--purple-dim); color: var(--purple); }

/* TABLE */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.data-table th {
  text-align: left;
  padding: 10px 14px;
  font-family: var(--font-mono);
  font-size: 10.5px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
.data-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  color: var(--text-secondary);
  vertical-align: middle;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover td { background: var(--bg-card-hover); }
.data-table .machine-id {
  font-family: var(--font-mono);
  font-weight: 600;
  color: var(--amber);
  font-size: 12px;
}
.data-table .cell-name { color: var(--text-primary); font-weight: 500; }

/* TWO COL LAYOUT */
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 1000px) { .two-col { grid-template-columns: 1fr; } }
.three-col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
@media (max-width: 1200px) { .three-col { grid-template-columns: 1fr 1fr; } }
@media (max-width: 768px) { .three-col { grid-template-columns: 1fr; } }

/* MACHINES GRID */
.machines-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 14px;
}
.machine-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px 18px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.machine-card:hover { border-color: var(--amber-dim); transform: translateY(-1px); }
.machine-card .mc-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 10px;
}
.machine-card .mc-id {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 700;
  color: var(--amber);
}
.machine-card .mc-name {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 3px;
}
.machine-card .mc-type {
  font-size: 12px;
  color: var(--text-muted);
}
.machine-card .mc-meta {
  display: flex;
  gap: 16px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
  font-size: 11.5px;
  color: var(--text-secondary);
}
.machine-card .mc-meta .label {
  color: var(--text-muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: block;
  margin-bottom: 2px;
  font-family: var(--font-mono);
}
.machine-card .mc-overdue-bar {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--red);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

/* FORMS */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}
@media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
.form-group { margin-bottom: 0; }
.form-group.full { grid-column: 1 / -1; }
.form-group label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  margin-bottom: 6px;
  font-family: var(--font-mono);
}
.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 13.5px;
  transition: border-color 0.2s;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--amber);
}
.form-group select { cursor: pointer; }
.form-group textarea { resize: vertical; min-height: 70px; }

/* BUTTONS */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 12px 20px;
  min-height: 48px;
  border: none;
  border-radius: var(--radius);
  font-family: var(--font-body);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-primary {
  background: var(--amber);
  color: #000;
}
.btn-primary:hover { background: #eab308; }
.btn-secondary {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.btn-secondary:hover { border-color: var(--border-light); color: var(--text-primary); }
.btn-danger { background: var(--red-dim); color: var(--red); border: 1px solid rgba(220,38,38,0.2); }
.btn-danger:hover { background: rgba(220,38,38,0.15); }

/* SEARCH */
.search-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0 12px;
}
.search-bar input {
  flex: 1;
  padding: 9px 0;
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 13px;
  font-family: var(--font-body);
}
.search-bar input:focus { outline: none; }
.search-bar .search-icon { color: var(--text-muted); font-size: 15px; }

/* SCAN PAGE */
.scan-zone {
  border: 2px dashed var(--border-light);
  border-radius: var(--radius-lg);
  padding: 40px;
  text-align: center;
  background: var(--bg-tertiary);
  transition: border-color 0.2s;
}
.scan-zone.active { border-color: var(--amber); background: var(--amber-glow); }
.scan-zone .scan-icon { font-size: 48px; margin-bottom: 16px; }
.scan-zone h3 { font-family: var(--font-mono); font-size: 16px; margin-bottom: 6px; }
.scan-zone p { font-size: 13px; color: var(--text-muted); }
.scan-input-wrap {
  max-width: 440px;
  margin: 20px auto 0;
}
.scan-input-wrap input {
  width: 100%;
  padding: 14px 18px;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--amber);
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 600;
  text-align: center;
  letter-spacing: 1px;
}
.scan-input-wrap input:focus { outline: none; border-color: var(--amber); }
.scan-result {
  margin-top: 24px;
  text-align: left;
}

/* MACHINE DETAIL MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  justify-content: center;
  align-items: flex-start;
  padding: 40px 20px;
  overflow-y: auto;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 720px;
  animation: modal-in 0.2s ease;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
}
@keyframes modal-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.modal-header {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-header h3 { font-family: var(--font-mono); font-size: 15px; }
.modal-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 22px;
  cursor: pointer;
  padding: 4px;
}
.modal-close:hover { color: var(--text-primary); }
.modal-body { padding: 20px 24px; }

/* SETTINGS */
.settings-group {
  margin-bottom: 24px;
}
.settings-group h4 {
  font-family: var(--font-mono);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--text-muted);
  margin-bottom: 12px;
}
.settings-field {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}
.settings-field label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  width: 140px;
  flex-shrink: 0;
}
.settings-field input {
  flex: 1;
  padding: 9px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 12.5px;
}
.settings-field input:focus { outline: none; border-color: var(--amber); }

/* TOAST */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 300;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.toast {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-left: 3px solid var(--green);
  border-radius: var(--radius);
  padding: 12px 18px;
  font-size: 13px;
  color: var(--text-primary);
  animation: toast-in 0.3s ease;
  max-width: 340px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.toast.error { border-left-color: var(--red); }
.toast.warning { border-left-color: var(--amber); }
@keyframes toast-in { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

/* ACTIVITY FEED */
.activity-item {
  display: flex;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.activity-item:last-child { border-bottom: none; }
.activity-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-top: 5px;
  flex-shrink: 0;
}
.activity-item .activity-text { font-size: 13px; color: var(--text-secondary); line-height: 1.4; }
.activity-item .activity-text strong { color: var(--text-primary); }
.activity-item .activity-time {
  font-size: 11px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  margin-top: 2px;
}

/* FILTER BAR */
.filter-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.filter-chip {
  padding: 10px 16px;
  min-height: 44px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-body);
}
.filter-chip:hover { border-color: var(--border-light); color: var(--text-primary); }
.filter-chip.active { background: var(--amber-glow); border-color: var(--amber-dim); color: var(--amber); }

/* PAGE SECTIONS */
.page { display: none; }
.page.active { display: block; }

/* CHART BAR simple */
.bar-chart-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}
.bar-chart-row .bar-label {
  font-size: 12px;
  color: var(--text-secondary);
  width: 110px;
  flex-shrink: 0;
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.bar-chart-row .bar-track {
  flex: 1;
  height: 22px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
}
.bar-chart-row .bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.6s ease;
}
.bar-chart-row .bar-count {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  width: 32px;
}

/* HIDDEN */
.hidden { display: none !important; }

/* MOBILE SCAN FAB */
.scan-fab {
  display: none;
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--amber);
  color: #000;
  border: none;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(217,119,6,0.3);
  z-index: 80;
  align-items: center;
  justify-content: center;
  transition: transform 0.15s;
}
.scan-fab:active { transform: scale(0.92); }
@media (max-width: 768px) {
  .scan-fab { display: flex; }
  .scan-fab.hide-on-scan { display: none; }
}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">‚öô</div>
    <h2>Maintenance System</h2>
    <p>Select your role, then enter your access code</p>
    <div class="mode-tiles">
      <div class="mode-tile" id="tile-operator" onclick="selectMode('operator')">
        <div class="t-icon">üë∑</div>
        <div class="t-label">Operator</div>
      </div>
      <div class="mode-tile" id="tile-tech" onclick="selectMode('tech')">
        <div class="t-icon">üîß</div>
        <div class="t-label">Tech</div>
      </div>
      <div class="mode-tile" id="tile-admin" onclick="selectMode('admin')">
        <div class="t-icon">‚ö°</div>
        <div class="t-label">Admin</div>
      </div>
    </div>
    <div class="login-pin">
      <input type="password" id="loginPin" inputmode="numeric" maxlength="8"
        placeholder="¬∑ ¬∑ ¬∑ ¬∑" autocomplete="off"
        onkeydown="if(event.key==='Enter') doLogin()">
    </div>
    <div id="loginErr"></div>
    <button class="btn btn-primary" style="width:100%" onclick="doLogin()">Enter</button>
  </div>
</div>

<!-- MOBILE HEADER -->
<div class="mobile-header">
  <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
  <span style="font-family:var(--font-mono);font-size:13px;font-weight:600;">MAINT SYS</span>
  <span style="font-size:12px;color:var(--text-muted)">v1.0</span>
</div>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="app-shell">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="logo">‚öô</div>
      <div>
        <h1>Maint Sys<br><span>Machine Maintenance</span></h1>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Operations</div>
      <button class="nav-btn active" onclick="showPage('dashboard')">
        <span class="icon">üìä</span> Dashboard
      </button>
      <button class="nav-btn" onclick="showPage('machines')">
        <span class="icon">üè≠</span> Machines
      </button>
      <button class="nav-btn" onclick="showPage('workorders')">
        <span class="icon">üîß</span> Work Orders
        <span class="badge" id="openWoBadge">0</span>
      </button>
      <button class="nav-btn" onclick="showPage('scan')">
        <span class="icon">üì∑</span> Scan
      </button>
      <div class="nav-section-label admin-only-nav" style="margin-top:12px">Admin</div>
      <button class="nav-btn admin-only-nav" onclick="showPage('operators')">
        <span class="icon">üë§</span> Operators
      </button>
      <button class="nav-btn admin-only-nav" onclick="showPage('settings')">
        <span class="icon">‚ö°</span> Settings
      </button>
    </nav>
    <div class="sidebar-footer" style="flex-direction:column;align-items:flex-start;gap:6px">
      <div>
        <span class="status-dot" id="connDot"></span>
        <span id="connLabel">Demo Mode</span>
      </div>
      <div id="modeBadge" onclick="doLogout()" title="Tap to log out"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main-content">

    <!-- ==================== DASHBOARD ==================== -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div>
          <h2>Dashboard</h2>
          <div class="subtitle" id="dashDate"></div>
        </div>
        <button class="btn btn-secondary" onclick="refreshDashboard()">‚Üª Refresh</button>
      </div>
      <div class="page-body">
        <div class="kpi-grid" id="kpiGrid"></div>
        <div class="two-col">
          <div class="panel">
            <div class="panel-header">
              <h3>‚ö† Overdue Services</h3>
              <span style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono)" id="overdueCount"></span>
            </div>
            <div style="overflow-x:auto">
              <table class="data-table" id="overdueTable">
                <thead>
                  <tr><th>Machine</th><th>Name</th><th>Days Overdue</th><th>Status</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div>
            <div class="panel">
              <div class="panel-header"><h3>üìà Work Orders by Type</h3></div>
              <div class="panel-body" id="woTypeChart"></div>
            </div>
            <div class="panel" style="margin-top:20px">
              <div class="panel-header"><h3>üïê Recent Activity</h3></div>
              <div class="panel-body" id="recentActivity"></div>
            </div>
          </div>
        </div>
        <div class="panel" style="margin-top:20px">
          <div class="panel-header"><h3>üè≠ Machines by Location</h3></div>
          <div class="panel-body" id="locationChart"></div>
        </div>
      </div>
    </div>

    <!-- ==================== MACHINES ==================== -->
    <div class="page" id="page-machines">
      <div class="page-header">
        <div>
          <h2>Machines</h2>
          <div class="subtitle">Asset Registry ‚Äî <span id="machineCount">0</span> machines</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="search-bar" style="width:260px">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="Search machines..." id="machineSearch">
          </div>
          <button class="btn btn-primary" onclick="openAddMachine()">+ Add Machine</button>
        </div>
      </div>
      <div class="page-body">
        <div class="filter-bar" style="margin-bottom:16px" id="locationFilters"></div>
        <div class="machines-grid" id="machinesGrid"></div>
      </div>
    </div>

    <!-- ==================== WORK ORDERS ==================== -->
    <div class="page" id="page-workorders">
      <div class="page-header">
        <div>
          <h2>Work Orders</h2>
          <div class="subtitle">Maintenance Log</div>
        </div>
        <button class="btn btn-primary" onclick="openNewWorkOrder()">üö® Report Issue</button>
      </div>
      <div class="page-body">
        <div class="filter-bar" style="margin-bottom:16px">
          <div class="filter-chip active" onclick="filterWO('Active', this)">Active</div>
          <div class="filter-chip" onclick="filterWO('Open', this)">Open</div>
          <div class="filter-chip" onclick="filterWO('Pending', this)">‚è≥ Pending</div>
          <div class="filter-chip" onclick="filterWO('Closed', this)">‚úì Completed</div>
          <div class="filter-chip" onclick="filterWO('PM', this)">üîÑ PM</div>
          <div class="filter-chip" onclick="filterWO('Reported', this)">üö® Reported</div>
          <div class="search-bar" style="width:240px;margin-left:auto">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="Search work orders..." id="woSearch">
          </div>
        </div>
        <div class="panel">
          <div style="overflow-x:auto">
            <table class="data-table" id="woTable">
              <thead>
                <tr>
                  <th>Machine</th><th>Name</th><th>Type</th><th>Priority</th>
                  <th>Category</th><th>Reported</th><th>Tech</th><th>Status</th><th>Notes</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== SCAN ==================== -->
    <div class="page" id="page-scan">
      <div class="page-header">
        <div>
          <h2>Scan Machine</h2>
          <div class="subtitle">Scan QR / enter Machine ID to pull up details</div>
        </div>
      </div>
      <div class="page-body">
        <div class="scan-zone" id="scanZone">
          <div class="scan-icon">üì∑</div>
          <h3>Scan QR Code or Enter Machine ID</h3>
          <p>Use a barcode scanner or type the Machine ID below</p>
          <div class="scan-input-wrap">
            <input type="text" id="scanInput" placeholder="AFI-221" autofocus
              autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
              onkeydown="if(event.key==='Enter')scanMachine()"
              oninput="scheduleScan()">
          </div>
        </div>
        <div class="scan-result" id="scanResult"></div>
      </div>
    </div>

    <!-- ==================== OPERATORS ==================== -->
    <div class="page" id="page-operators">
      <div class="page-header">
        <div>
          <h2>Operators</h2>
          <div class="subtitle">Technicians & service personnel</div>
        </div>
        <button class="btn btn-primary" onclick="openAddOperator()">+ Add Operator</button>
      </div>
      <div class="page-body">
        <div class="panel">
          <div style="overflow-x:auto">
            <table class="data-table" id="operatorsTable">
              <thead>
                <tr><th>Initials/Name</th><th>Role</th><th>Work Orders</th><th>Status</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== SETTINGS ==================== -->
    <div class="page" id="page-settings">
      <div class="page-header">
        <div>
          <h2>Settings</h2>
          <div class="subtitle">Airtable API connection & app configuration</div>
        </div>
      </div>
      <div class="page-body">
        <div class="panel">
          <div class="panel-header"><h3>Airtable Connection</h3></div>
          <div class="panel-body">
            <div class="settings-group">
              <h4>API Credentials</h4>
              <div class="settings-field">
                <label>API Token</label>
                <input type="password" id="atApiKey" placeholder="pat_xxxxxxxxxxxx">
              </div>
              <div class="settings-field">
                <label>Base ID</label>
                <input type="text" id="atBaseId" placeholder="appXXXXXXXXXXXXXX">
              </div>
            </div>
            <div class="settings-group">
              <h4>Table Names</h4>
              <div class="settings-field">
                <label>Machines Table</label>
                <input type="text" id="atMachinesTable" value="Machines">
              </div>
              <div class="settings-field">
                <label>Service Log Table</label>
                <input type="text" id="atServiceTable" value="Service Log">
              </div>
              <div class="settings-field">
                <label>Operators Table</label>
                <input type="text" id="atOperatorsTable" value="Operators">
              </div>
            </div>
            <div style="display:flex;gap:10px">
              <button class="btn btn-primary" onclick="saveSettings()">Save & Connect</button>
              <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
              <button class="btn btn-danger" onclick="disconnectAirtable()">Disconnect</button>
            </div>
            <div id="connStatus" style="margin-top:12px;font-size:13px;color:var(--text-muted)"></div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-header"><h3>Data Management</h3></div>
          <div class="panel-body">
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn btn-secondary" onclick="exportData()">‚¨á Export Local Data (JSON)</button>
              <button class="btn btn-danger" onclick="resetDemoData()">üóë Reset Demo Data to Defaults</button>
            </div>
            <p style="margin-top:10px;font-size:12px;color:var(--text-muted)">In demo mode, all data persists in your browser's local storage. Reset clears everything and reloads the original 182 machines from the asset registry.</p>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- WORK ORDER MODAL -->
<div class="modal-overlay" id="woModal">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="woModalTitle">Report Machine Issue</h3>
      <button class="modal-close" onclick="closeModal('woModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label>Machine ID</label>
          <div class="machine-id-wrap">
            <input type="text" id="woMachineId"
              placeholder="Scan barcode or type ID / name‚Ä¶"
              autocomplete="off" autocorrect="off"
              autocapitalize="characters" spellcheck="false"
              oninput="machineInput()" onkeydown="machineKeydown(event)">
            <div id="woMachineSuggestions"></div>
          </div>
        </div>
        <div class="form-group">
          <label>Machine Name</label>
          <input type="text" id="woMachineName" readonly style="opacity:0.6">
        </div>
        <div class="form-group">
          <label>Incident Type</label>
          <select id="woIncidentType">
            <option>Repair</option><option>Corrective</option><option>Preventive</option><option>Emergency</option>
            <option>Inspection</option><option>Installation</option><option>Upgrade</option>
            <option>Tooling</option><option>Clean</option>
          </select>
        </div>
        <div class="form-group">
          <label>Issue Category</label>
          <select id="woCategory">
            <option>Mechanical</option><option>Electrical</option><option>Hydraulic</option>
            <option>Pneumatic</option><option>Lubrication</option><option>Heating/Cooling</option>
            <option>Water System</option><option>Belt/Chain</option><option>Motor/Drive</option>
            <option>Blade/Cutting</option><option>Pump/Valve</option><option>Pressure System</option>
            <option>Glue/Adhesive</option><option>Software/Controls</option><option>Calibration</option>
            <option>Filter/Fluid</option><option>Tooling/Fixtures</option><option>Facility/Building</option>
            <option>Waste Removal</option><option>Scheduled PM</option><option>Safety</option><option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Reported By</label>
          <input type="text" id="woReportedBy" placeholder="Your name or initials">
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select id="woPriority">
            <option>Low</option><option selected>Medium</option><option>High</option><option>Critical</option>
          </select>
        </div>
        <div class="form-group" id="woMachineDownGroup">
          <label>Machine Status</label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:400;font-size:13px;padding:8px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface)">
            <input type="checkbox" id="woMachineDown" onchange="onMachineDownToggle()" style="width:18px;height:18px;accent-color:var(--red);cursor:pointer">
            <span id="woMachineDownLabel">Machine is <strong>fully down</strong> ‚Äî not producing</span>
          </label>
        </div>
        <div class="form-group full">
          <label>Describe the Problem</label>
          <textarea id="woNotes" placeholder="What's happening? Any error codes, sounds, smells? When did it start?"></textarea>
        </div>
      </div>
      <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeModal('woModal')">Cancel</button>
        <button class="btn btn-primary" id="btnSubmitWO" onclick="submitWorkOrder()">üö® Submit Issue Report</button>
      </div>
    </div>
  </div>
</div>

<!-- MACHINE DETAIL MODAL -->
<div class="modal-overlay" id="machineModal" onclick="closeModal('machineModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="machineModalTitle">Machine Detail</h3>
      <button class="modal-close" onclick="closeModal('machineModal')">‚úï</button>
    </div>
    <div class="modal-body" id="machineModalBody"></div>
  </div>
</div>

<!-- ADD MACHINE MODAL -->
<div class="modal-overlay" id="addMachineModal" onclick="closeModal('addMachineModal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Add New Machine</h3>
      <button class="modal-close" onclick="closeModal('addMachineModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>Machine ID</label><input type="text" id="amId" placeholder="AFI-XXX"></div>
        <div class="form-group"><label>Machine Name</label><input type="text" id="amName"></div>
        <div class="form-group"><label>Type</label><input type="text" id="amType"></div>
        <div class="form-group"><label>Location</label><select id="amLocation"></select></div>
        <div class="form-group"><label>Manufacturer</label><input type="text" id="amMfg"></div>
        <div class="form-group"><label>Model Number</label><input type="text" id="amModel"></div>
        <div class="form-group"><label>Service Freq (Days)</label><input type="number" id="amFreq" value="30"></div>
        <div class="form-group"><label>Status</label>
          <select id="amStatus">
            <option>Operational</option><option>Under Maintenance</option><option>Down - Critical</option>
            <option>Down - Non-Critical</option><option>Waiting Parts</option><option>Scheduled Downtime</option>
            <option>Out for Service</option><option>Decommissioned</option>
          </select>
        </div>
      </div>
      <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeModal('addMachineModal')">Cancel</button>
        <button class="btn btn-primary" onclick="addMachine()">Add Machine</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD OPERATOR MODAL -->
<div class="modal-overlay" id="addOperatorModal" onclick="closeModal('addOperatorModal')">
  <div class="modal" style="max-width:460px" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Operator</h3>
      <button class="modal-close" onclick="closeModal('addOperatorModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:14px"><label>Name / Initials</label><input type="text" id="aoName" placeholder="e.g. Mike T."></div>
      <div class="form-group" style="margin-bottom:14px"><label>Role</label>
        <select id="aoRole"><option>Technician</option><option>Lead Technician</option><option>External Service</option><option>Supervisor</option></select>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeModal('addOperatorModal')">Cancel</button>
        <button class="btn btn-primary" onclick="addOperator()">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- RESOLVE WORK ORDER MODAL -->
<div class="modal-overlay" id="resolveWoModal">
  <div class="modal" style="max-width:640px" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="resolveWoTitle">Work Order Detail</h3>
      <button class="modal-close" onclick="closeModal('resolveWoModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="resolveWoInfo" style="margin-bottom:18px"></div>
      <div id="resolveWoForm">
        <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:14px">
          <h4 style="font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:var(--amber);margin-bottom:12px">Management / Tech Actions</h4>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Assign Tech</label>
            <div class="machine-id-wrap">
              <input type="text" id="resolveAssignTech"
                placeholder="Type name or scan tech ID‚Ä¶"
                autocomplete="off" spellcheck="false"
                oninput="techInput()" onkeydown="techKeydown(event)">
              <div id="techSuggestions"></div>
            </div>
          </div>
          <div class="form-group">
            <label>Priority</label>
            <select id="resolvePriority">
              <option>Low</option><option>Medium</option><option>High</option><option>Critical</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="resolveStatus">
              <option>Open</option><option>Pending</option><option>Closed</option>
            </select>
          </div>
          <div class="form-group full">
            <label>Resolution / Work Notes</label>
            <textarea id="resolveNotes" placeholder="Describe diagnosis, work performed, parts replaced..."></textarea>
          </div>
          <div class="form-group">
            <label>Parts Used</label>
            <input type="text" id="resolvePartsUsed" placeholder="P/N, description...">
          </div>
          <div class="form-group">
            <label>Work Started</label>
            <input type="datetime-local" id="resolveWorkStarted">
          </div>
          <div class="form-group">
            <label>Follow-up Required?</label>
            <select id="resolveFollowUp" onchange="toggleFollowUpDate()">
              <option value="No">No</option><option value="Yes">Yes</option>
            </select>
          </div>
        </div>
        <div id="followUpDateSection" style="display:none;margin-top:14px;background:var(--bg-tertiary);border:1px solid var(--amber-dim);border-radius:var(--radius);padding:14px 16px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
            <span style="font-size:16px">üìÖ</span>
            <span style="font-family:var(--font-mono);font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:var(--amber);font-weight:600">Follow-Up Scheduling</span>
          </div>
          <div class="form-grid" style="margin-bottom:0">
            <div class="form-group">
              <label>Follow-up Date</label>
              <input type="date" id="resolveFollowUpDate">
            </div>
            <div class="form-group">
              <label>Quick Select</label>
              <div style="display:flex;gap:6px;flex-wrap:wrap;padding-top:2px">
                <button type="button" class="btn btn-secondary" style="padding:8px 12px;font-size:12px;min-height:44px" onclick="setFollowUpDays(7)">1 Wk</button>
                <button type="button" class="btn btn-secondary" style="padding:8px 12px;font-size:12px;min-height:44px" onclick="setFollowUpDays(14)">2 Wks</button>
                <button type="button" class="btn btn-secondary" style="padding:8px 12px;font-size:12px;min-height:44px" onclick="setFollowUpDays(30)">30d</button>
                <button type="button" class="btn btn-secondary" style="padding:8px 12px;font-size:12px;min-height:44px" onclick="setFollowUpDays(45)">45d</button>
                <button type="button" class="btn btn-secondary" style="padding:8px 12px;font-size:12px;min-height:44px" onclick="setFollowUpDays(60)">60d</button>
                <button type="button" class="btn btn-secondary" style="padding:8px 12px;font-size:12px;min-height:44px" onclick="setFollowUpDays(90)">90d</button>
              </div>
            </div>
            <div class="form-group full">
              <label>Follow-up Notes</label>
              <input type="text" id="resolveFollowUpNotes" placeholder="e.g. Re-check seal after 500 hrs, order part and reschedule...">
            </div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--text-muted)">
            <span style="color:var(--amber)">‚ö°</span> This overrides the machine's next service due date so it appears in the overdue tracker on that date.
          </div>
        </div>
        <div style="margin-top:18px;display:flex;gap:10px;justify-content:flex-end">
          <button class="btn btn-secondary" onclick="closeModal('resolveWoModal')">Cancel</button>
          <button class="btn btn-primary" id="btnResolveWO" onclick="resolveWorkOrder()">üíæ Save Changes</button>
        </div>
      </div>
    </div>
  </div>
</div>

<button class="scan-fab" id="scanFab" onclick="showPage('scan')" title="Scan Machine">üì∑</button>

<div class="toast-container" id="toastContainer"></div>

<script>
// ===================================================================
// UTILITY SHORTHANDS
// ===================================================================
const $ = id => document.getElementById(id);
const $val = id => $(id)?.value.trim() ?? '';
const todayISO = () => new Date().toISOString().split('T')[0];

// ===================================================================
// DATA LAYER ‚Äî Mock data from real Excel, swappable to Airtable
// ===================================================================

const CONFIG = {
  airtable: {
    apiKey: '',
    baseId: '',
    tables: { machines: 'Machines', serviceLog: 'Service Log', operators: 'Operators' }
  },
  useAirtable: false,
  // ‚îÄ‚îÄ ACCESS CODES ‚Äî change these ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Techs: map PIN ‚Üí operator name (must match operator name in the Operators list)
  pins: {
    admin: '1234',
    tech: { '5678': 'Tech' },   // add more: '1111': 'Jane', '2222': 'Bob'
    operator: '9012'
  }
};

let currentMode = null;       // 'admin' | 'tech' | 'operator'
let _loginMode  = null;       // selection in progress
let _loggedInTechName = null; // resolved name for tech mode

// Load saved settings
try {
  const saved = JSON.parse(localStorage.getItem('maint_settings') || '{}');
  if (saved.apiKey) { Object.assign(CONFIG.airtable, saved); CONFIG.useAirtable = !!saved.apiKey && !!saved.baseId; }
} catch(e) {}

// ===================================================================
// LOCAL PERSISTENCE (demo mode ‚Äî survives refresh)
// ===================================================================
const LocalStore = {
  _key: 'maint_data_v1',
  save() {
    if (CONFIG.useAirtable) return; // don't cache when Airtable is source of truth
    try {
      localStorage.setItem(this._key, JSON.stringify({
        machines, workOrders, operators, activityLog, machineCount: INLINE_MACHINE_COUNT, savedAt: new Date().toISOString()
      }));
    } catch(e) { toast('Local storage full ‚Äî export your data before it is lost!', 'error'); }
  },
  load() {
    try {
      const raw = localStorage.getItem(this._key);
      if (!raw) return false;
      const data = JSON.parse(raw);
      if (data.machines) machines = data.machines;
      if (data.workOrders) workOrders = data.workOrders;
      if (data.operators) operators = data.operators;
      if (data.activityLog) activityLog = data.activityLog;
      return true;
    } catch(e) { return false; }
  },
  clear() {
    localStorage.removeItem(this._key);
  }
};

let activityLog = []; // Transaction log: {ts, type, woId, machineId, text}

function logActivity(type, woId, machineId, text) {
  activityLog.unshift({
    ts: new Date().toISOString(),
    type, // 'created','closed','pending','assigned','pm','updated'
    woId: woId || '',
    machineId: machineId || '',
    text: text || '',
  });
  // Keep last 50 entries
  if (activityLog.length > 50) activityLog.length = 50;
  renderActivityFeed();
}

function renderActivityFeed() {
  const el = $('recentActivity');
  if (!el) return;
  const icons = { created:'üîß', closed:'‚úì', pending:'‚è≥', assigned:'üë∑', pm:'‚ö†', updated:'üìù' };
  const colors = { created:'var(--red)', closed:'var(--green)', pending:'var(--amber)', assigned:'var(--blue)', pm:'var(--amber)', updated:'var(--text-muted)' };
  const items = activityLog.slice(0, 12);

  if (items.length === 0) {
    // Fallback: if no activity log yet, show WO snapshot (backwards compat)
    const recent = [...workOrders].sort((a,b) => {
      const dateA = a.workCompleted || a.workStarted || a.reportedDate;
      const dateB = b.workCompleted || b.workStarted || b.reportedDate;
      return new Date(dateB) - new Date(dateA);
    }).slice(0,8);
    el.innerHTML = recent.map(w => {
      const dotColor = w.status==='Closed' ? 'var(--green)' : w.status==='Pending' ? 'var(--amber)' : 'var(--red)';
      const click = w.status!=='Closed' ? `onclick="openResolveWO('${esc(w.id)}')" style="cursor:pointer"` : '';
      const statusTag = w.status==='Closed'
        ? '<span style="color:var(--green);font-size:11px;font-weight:600">‚úì Completed</span>'
        : w.status==='Pending'
        ? '<span style="color:var(--amber);font-size:11px;font-weight:600">‚è≥ Pending follow-up</span>'
        : '<span style="color:var(--red);font-size:11px;font-weight:600">‚Üó Open</span>';
      const actDate = w.workCompleted || w.reportedDate;
      return `<div class="activity-item" ${click}>
        <div class="activity-dot" style="background:${dotColor}"></div>
        <div>
          <div class="activity-text"><strong>${esc(w.machineId)}</strong> ‚Äî ${esc(w.notes.substring(0,55))}${w.notes.length>55?'‚Ä¶':''} ${statusTag}</div>
          <div class="activity-time">${formatDate(actDate)} ¬∑ ${esc(w.assignedTech) || 'Unassigned'}</div>
        </div>
      </div>`;
    }).join('');
    return;
  }

  el.innerHTML = items.map(a => {
    const icon = icons[a.type] || 'üìù';
    const dotColor = colors[a.type] || 'var(--text-muted)';
    const click = (a.type !== 'closed' && a.woId) ? `onclick="openResolveWO('${esc(a.woId)}')" style="cursor:pointer"` : '';
    const ago = timeAgo(a.ts);
    return `<div class="activity-item" ${click}>
      <div class="activity-dot" style="background:${dotColor}"></div>
      <div>
        <div class="activity-text"><span style="font-size:13px">${icon}</span> <strong>${esc(a.machineId)}</strong> ‚Äî ${esc(a.text)}</div>
        <div class="activity-time">${ago}</div>
      </div>
    </div>`;
  }).join('');
}

function timeAgo(isoStr) {
  const diff = Date.now() - new Date(isoStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 7) return days + 'd ago';
  return formatDate(isoStr);
}

// ---- OPERATORS (from Excel Lookup > Technicians) ----
let operators = [
  { id: 'op-1', name: 'EO', role: 'Technician', active: true },
  { id: 'op-2', name: 'NC', role: 'Technician', active: true },
  { id: 'op-3', name: 'JR', role: 'Technician', active: true },
  { id: 'op-4', name: 'Mike T.', role: 'Technician', active: true },
  { id: 'op-5', name: 'Carlos R.', role: 'Technician', active: true },
  { id: 'op-6', name: 'Alex', role: 'Technician', active: true },
  { id: 'op-7', name: 'Noel', role: 'Technician', active: true },
  { id: 'op-8', name: 'External Service', role: 'External Service', active: true },
];

// ---- MACHINES (from Airtable Machines table ‚Äî 182 unique) ----
let machines = [
  { id:'AFI-221', name:'Oscilator machine', type:'Foam oscillatting cutter', location:'Rigid Foam', manufacturer:'Wintech', model:'D0Z2018-2225-BCT', serviceFreqDays:30, lastService:'2025-10-07', status:'Operational', manualLink:'https://wintech.com' },
  { id:'QFP-81', name:'Brown Machinery', type:'Plastic Machinery', location:'Raw Materials', manufacturer:'John Brown Plastic Machinery', model:'R-223-E', serviceFreqDays:60, lastService:'2025-11-26', status:'Operational', manualLink:'' },
  { id:'QFP-396', name:'BROWN MACHINE', type:'Plastic Machinery', location:'Raw Materials', manufacturer:'Brown Machine', model:'', serviceFreqDays:60, lastService:'2025-10-15', status:'Operational', manualLink:'' },
  { id:'QFP-544', name:'Bandsaw Jet 18', type:'Band Saw', location:'Fabrication', manufacturer:'', model:'JWBS-18QT', serviceFreqDays:90, lastService:'2025-10-21', status:'Operational', manualLink:'' },
  { id:'QFP-531A', name:'Flow Waterjet', type:'Waterjet', location:'Waterjet Dept', manufacturer:'WardJet', model:'4020 Quad Head 044917-1 Mach 3', serviceFreqDays:30, lastService:'2025-08-01', status:'Down - Non-Critical', downSince:'2025-08-01T08:00:00Z', manualLink:'https://flowwaterjet.com' },
  { id:'AFI-125', name:'Bldg C Laminator', type:'Laminator', location:'Building C', manufacturer:'Veit-Kannegiesser', model:'Multstar CLF 1400L', serviceFreqDays:60, lastService:'2025-09-30', status:'Operational', manualLink:'' },
  { id:'AFI-33', name:'Seat Fab Router', type:'Router', location:'Seat Fab', manufacturer:'Grizzly', model:'G8030', serviceFreqDays:90, lastService:'2025-08-05', status:'Operational', manualLink:'https://grizzly.com' },
  { id:'QFP-577A', name:'Wardjet Z', type:'Waterjet', location:'Waterjet Dept', manufacturer:'Wardjet', model:'Z -2543', serviceFreqDays:30, lastService:'2025-10-02', status:'Operational', manualLink:'https://wardjet.com' },
  { id:'AFI-191', name:'Plastic Dept Maac ASP', type:'Vaccuum Former', location:'Plastic Dept', manufacturer:'MAAC', model:'ASP', serviceFreqDays:45, lastService:'2025-08-07', status:'Down - Non-Critical', downSince:'2025-08-07T08:00:00Z', manualLink:'https://maacmachinery.com' },
  { id:'AFI-254', name:'Plastic Dept Maac', type:'Vaccuum Former', location:'Plastic Dept', manufacturer:'MAAC', model:'C64S', serviceFreqDays:45, lastService:'2025-08-15', status:'Operational', manualLink:'https://maacmachinery.com' },
  { id:'AFI-87', name:'Gerber', type:'Leather Cut', location:'Building C', manufacturer:'Gerber Taurus 2', model:'', serviceFreqDays:60, lastService:'2025-09-11', status:'Operational', manualLink:'https://lectra.com' },
  { id:'AFI-257', name:'PathFinder', type:'Fabric CNC', location:'Fabrication', manufacturer:'PathFinder', model:'8038', serviceFreqDays:60, lastService:'2025-11-11', status:'Operational', manualLink:'https://pathfindercutting.com' },
  { id:'AFI-16', name:'MAAC ASP #1', type:'Thermoformer', location:'Raw Materials', manufacturer:'MAAC', model:'ASP 4079', serviceFreqDays:45, lastService:'2025-12-08', status:'Operational', manualLink:'https://maacmachinery.com' },
  { id:'QFP-292', name:'JET Bandsaw', type:'Band Saw', location:'Fabrication', manufacturer:'JET', model:'JWBS-20-1', serviceFreqDays:90, lastService:'2025-10-06', status:'Operational', manualLink:'https://jettools.com' },
  { id:'QFP-561A', name:'JET bandsaw 18"', type:'Band Saw', location:'Raw Materials', manufacturer:'JET', model:'JWBS-18QT', serviceFreqDays:90, lastService:'2025-09-23', status:'Operational', manualLink:'' },
  { id:'QFP-577B', name:'Hypertherm', type:'Intensifier', location:'Waterjet Dept', manufacturer:'Hypertherm', model:'HyPrecision 75s', serviceFreqDays:30, lastService:'2025-09-16', status:'Operational', manualLink:'https://hypertherm.com' },
  { id:'AFI-5/AFI-44A', name:'DMS(1)', type:'CNC Router Cooling Router', location:'CNC Routers', manufacturer:'Pfannenberg', model:'DTS-3041', serviceFreqDays:45, lastService:'2025-09-22', status:'Operational', manualLink:'https://pfannenberg.com' },
  { id:'AFI-42/AFI-44B', name:'DMS(2)', type:'CNC Router Cooling Router', location:'CNC Routers', manufacturer:'Pfannenberg', model:'DTS-3041', serviceFreqDays:45, lastService:'2025-09-22', status:'Operational', manualLink:'https://pfannenberg.com' },
  { id:'QFP-562', name:'WAPORA bandsaw', type:'Vertical Foam Cut', location:'Fabrication', manufacturer:'AB WAPORA', model:'', serviceFreqDays:60, lastService:'2025-11-17', status:'Operational', manualLink:'https://baumer.com' },
  { id:'AFI-103A', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-103B', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-105A', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-105B', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-105C', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-105D', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-11', name:'Shear - HS-0410E', type:'Shear', location:'Plastic Dept', manufacturer:'Gallop Machine', model:'HS-0410E', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-110', name:'Sewing Machine - MX3216-A04', type:'Sewing Machine', location:'Building C', manufacturer:'PAGUAS', model:'MX3216-A04', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-111', name:'Sewing Machine - KE-430FS-05', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'KE-430FS-05', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-113 A-G', name:'Sewing Tables - Custom Sewing Tables', type:'Sewing Tables', location:'Building C', manufacturer:'Doug Heiberg', model:'Custom Sewing Tables', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-114A', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-114B', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-114C', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-124', name:'Spray Tunnel - SaniMister S-2438', type:'Spray Tunnel', location:'Flexible Fab Dept', manufacturer:'Viking', model:'SaniMister S-2438', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-126', name:'Flammability Tester - VC-2 Flammablity Tester', type:'Flammability Tester', location:'Quality Dept', manufacturer:'Deatak', model:'VC-2 Flammablity Tester', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-127A', name:'Dryer - DT-422 Turbo Jet Star', type:'Dryer', location:'Flexible Fab Dept', manufacturer:'Ranar', model:'DT-422 Turbo Jet Star', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-127B', name:'Dryer - DT-422 Turbo Jet Star', type:'Dryer', location:'Flexible Fab Dept', manufacturer:'Ranar', model:'DT-422 Turbo Jet Star', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-129', name:'CNC Milling Center - VF-3SSYT', type:'CNC Milling Center', location:'CNC Dept', manufacturer:'Haas', model:'VF-3SSYT', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-13', name:'Dryer - DT-422 Turbo Jet-Star', type:'Dryer', location:'Plastic Fab Dept', manufacturer:'Ranar', model:'DT-422 Turbo Jet-Star', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-130', name:'Sewing Machine - M Type 868', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 868', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-132A', name:'Work Station - QHM', type:'Work Station', location:'Leather Dept 1', manufacturer:'QHM', model:'Work Station', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-133A', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-133B', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-133C', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Leather Dept 2', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-134', name:'Sewing Machine - M Type 867', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 867', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-137A', name:'Work Station - QHM', type:'Work Station', location:'Leather Dept 1', manufacturer:'QHM', model:'Work Station', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-137B', name:'Work Station - QHM', type:'Work Station', location:'Seat Fab Dept', manufacturer:'QHM', model:'Work Station', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-138', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-139', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-140', name:'Sewing Machine - S-7200C-405', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Brother', model:'S-7200C-405', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-141', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-149', name:'Velcro Cutter - HC530A', type:'Velcro Cutter', location:'Seat Fab Dept', manufacturer:'Sheffield', model:'HC530A', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-14A', name:'Bandsaw - 18"', type:'Bandsaw', location:'Rigid Foam Dept', manufacturer:'Rikon', model:'18"', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-150', name:'Cutting Machine - Blue Streak 2', type:'Cutting Machine', location:'Fireblock Dept', manufacturer:'Eastman', model:'Blue Streak 2', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-151 A -R', name:'Chairs - 18  Chairs', type:'Chairs', location:'Building C', manufacturer:'', model:'18  Chairs', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-155', name:'Sewing Machine - AE-8050H', type:'Sewing Machine', location:'Building C', manufacturer:'Checkit', model:'AE-8050H', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-164A', name:'Bandsaw - JWBS-20QT-3', type:'Bandsaw', location:'Seat Fab Dept', manufacturer:'Jet', model:'JWBS-20QT-3', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-164B', name:'Bandsaw - JWBS-20QT-3', type:'Bandsaw', location:'Seat Fab Dept', manufacturer:'Jet', model:'JWBS-20QT-3', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-165', name:'Sewing Machine - HCS2-1201-30', type:'Sewing Machine', location:'Building C', manufacturer:'Happy', model:'HCS2-1201-30', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-166A', name:'Lunch Tables - H-2129BLU', type:'Lunch Tables', location:'Outside Parking Lot', manufacturer:'Uline', model:'H-2129BLU', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-166B', name:'Lunch Tables - H-2129BLU', type:'Lunch Tables', location:'Outside Parking Lot', manufacturer:'Uline', model:'H-2129BLU', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-166C', name:'Lunch Tables - H-2129BLU', type:'Lunch Tables', location:'Outside Parking Lot', manufacturer:'Uline', model:'H-2129BLU', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-166D', name:'Lunch Tables - H-2129BLU', type:'Lunch Tables', location:'Outside Parking Lot', manufacturer:'Uline', model:'H-2129BLU', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-169', name:'Dryer - DT-422 Turbo Jet-Star', type:'Dryer', location:'Plastic Fab Dept', manufacturer:'Ranar', model:'DT-422 Turbo Jet-Star', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-17', name:'Pad Printer - G2 150', type:'Pad Printer', location:'Plastic Dept', manufacturer:'Printex', model:'G2 150', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-171', name:'Stapler - F53PN', type:'Stapler', location:'Plastic Fab Dept', manufacturer:'Josef Kihlberg', model:'F53PN', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-172 A-F', name:'Cart - 6   H-4149 Carts', type:'Cart', location:'Flexible Fab Dept', manufacturer:'Uline', model:'6   H-4149 Carts', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-174', name:'DownDraft Table - H2936', type:'DownDraft Table', location:'Rigid Foam Dept', manufacturer:'Grizzly', model:'H2936', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-184', name:'Oven - 9231-HP-UA-17', type:'Oven', location:'Plastic Dept', manufacturer:'Sammons', model:'9231-HP-UA-17', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-185B', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-187', name:'Velcro Cutter - HC530A', type:'Velcro Cutter', location:'Fireblock Dept', manufacturer:'Sheffield', model:'HC530A', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-195', name:'Vacuum Former - ASP', type:'Vacuum Former', location:'Plastic Dept', manufacturer:'Macc', model:'ASP', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-198A', name:'Marking Machines - Jet Stamp 790MP', type:'Marking Machines', location:'Plastic Fab Dept', manufacturer:'Rein', model:'Jet Stamp 790MP', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-198B', name:'Marking Machines - Jet Stamp 790MP', type:'Marking Machines', location:'Plastic Fab Dept', manufacturer:'Rein', model:'Jet Stamp 790MP', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-199', name:'Router - G9981', type:'Router', location:'Rigid Foam Dept', manufacturer:'Grizzly', model:'G9981', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-204A', name:'CNC Router - F55-4-8-7CLVxx', type:'CNC Router', location:'CNC Dept', manufacturer:'Freedom', model:'F55-4-8-7CLVxx', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-204B', name:'Vacuum Pump - VMX0203KA1-11', type:'Vacuum Pump', location:'CNC Dept', manufacturer:'Dekker', model:'VMX0203KA1-11', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-204C', name:'Dust Collector - G0562ZP', type:'Dust Collector', location:'CNC Dept', manufacturer:'Grizzly', model:'G0562ZP', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-205', name:'DownDraft Table - H2936', type:'DownDraft Table', location:'Rigid Foam Dept', manufacturer:'Grizzly', model:'H2936', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-206', name:'Sewing Machine - BAS Programable', type:'Sewing Machine', location:'Building C', manufacturer:'Brother', model:'BAS Programable', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-208', name:'Spindle - H1423H0224', type:'Spindle', location:'CNC Dept', manufacturer:'HSD', model:'H1423H0224', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-209', name:'Air Cutter - Falcon End Cutter', type:'Air Cutter', location:'Building C', manufacturer:'Eastman', model:'Falcon End Cutter', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-216', name:'Sewing Machine - CNC Quilting Machine', type:'Sewing Machine', location:'Leather Dept 2', manufacturer:'ABM Int', model:'CNC Quilting Machine', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-220', name:'CNC Contour Cutter - DOZ2225-BCT', type:'CNC Contour Cutter', location:'Rigid Foam Dept', manufacturer:'Wintech', model:'DOZ2225-BCT', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-223', name:'Sewing Machine - HX88-4TD-03', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Hikari', model:'HX88-4TD-03', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-224', name:'Sewing Machine - M Type 867', type:'Sewing Machine', location:'Leather Dept 2', manufacturer:'Durkopp Adler', model:'M Type 867', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-225A', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-225B', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-225C', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-225D', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-225E', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-226', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-227', name:'Sewing Machine - DCS-S4', type:'Sewing Machine', location:'Leather Dept 2', manufacturer:'Consew', model:'DCS-S4', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-229', name:'Dust Collector - Grizzly', type:'Dust Collector', location:'Rigid Foam Dept', manufacturer:'Grizzly', model:'', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-23', name:'CNC Router - 35T5-5-6-36SCOxRx', type:'CNC Router', location:'CNC Dept', manufacturer:'DMS', model:'35T5-5-6-36SCOxRx', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-232A', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Leather Dept 2', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-232B', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Leather Dept 2', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-232E', name:'Sewing Machine - MH2654', type:'Sewing Machine', location:'Building C', manufacturer:'Mauser', model:'MH2654', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-235', name:'Sewing Machine - M Type 867', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Durkopp Adler', model:'M Type 867', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-238A', name:'Sewing Machine - M Type 867', type:'Sewing Machine', location:'Leather Dept 2', manufacturer:'Durkopp Adler', model:'M Type 867', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-238B', name:'Sewing Machine - M Type 867', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Durkopp Adler', model:'M Type 867', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-240', name:'Cutting Machine - Buzzaird', type:'Cutting Machine', location:'Fireblock Dept', manufacturer:'Eastman', model:'Buzzaird', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-241', name:'Sewing Machine - BC-1201', type:'Sewing Machine', location:'Building C', manufacturer:'SINSIM', model:'BC-1201', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-244', name:'Spray Booth - 8x7x6', type:'Spray Booth', location:'Plastic Fab Dept', manufacturer:'Grainger', model:'8x7x6', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-245', name:'Velcro Cutter - HC530A', type:'Velcro Cutter', location:'Fireblock Dept', manufacturer:'Sheffield', model:'HC530A', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-247', name:'Glue Gun - Water Spray Sys', type:'Glue Gun', location:'Plastic Fab Dept', manufacturer:'Binks', model:'Water Spray Sys', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-248 A-C', name:'Oven - 541CHP18361', type:'Oven', location:'Plastic Fab Dept', manufacturer:'Mainstreet', model:'541CHP18361', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-24A', name:'Air Tank - Pressure Tank', type:'Air Tank', location:'CNC Dept', manufacturer:'Sears', model:'Pressure Tank', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-24B', name:'Air Tank - Pressure Tank', type:'Air Tank', location:'CNC Dept', manufacturer:'Sears', model:'Pressure Tank', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-254A', name:'Vacuum Former - Model C64S', type:'Vacuum Former', location:'Plastic Dept', manufacturer:'Macc', model:'Model C64S', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-254B', name:'Vacuum Pump - RA 0100F 506 DGXX', type:'Vacuum Pump', location:'Plastic Dept', manufacturer:'Busch', model:'RA 0100F 506 DGXX', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-255A', name:'Vacuum Former - 2011 Comet', type:'Vacuum Former', location:'Plastic Dept', manufacturer:'Macc', model:'2011 Comet', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-255B', name:'Vacuum Pump - RC0063.E506.1001', type:'Vacuum Pump', location:'Plastic Dept', manufacturer:'Busch', model:'RC0063.E506.1001', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-256', name:'Air Cutter - Falcon End Cutter', type:'Air Cutter', location:'Building C', manufacturer:'Eastman', model:'Falcon End Cutter', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-258', name:'Bandsaw - M3764', type:'Bandsaw', location:'Seat Glue Dept', manufacturer:'Gruppo Grassi', model:'M3764', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-259', name:'Sewing Machine - M Type 869', type:'Sewing Machine', location:'Leather Dept 2', manufacturer:'Durkopp Adler', model:'M Type 869', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-261', name:'Vacuum Pump - VTLF2.250/0-79', type:'Vacuum Pump', location:'CNC Dept', manufacturer:'Becker', model:'VTLF2.250/0-79', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-262', name:'Vacuum Pump - QSV1100E', type:'Vacuum Pump', location:'CNC Dept', manufacturer:'Quincy', model:'QSV1100E', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-263A', name:'CNC Router - 5TT6-5-5-36x/X', type:'CNC Router', location:'CNC Dept', manufacturer:'DMS', model:'5TT6-5-5-36x/X', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-263B', name:'Vacuum Pump - VTLF2.250/0-79', type:'Vacuum Pump', location:'CNC Dept', manufacturer:'Becker', model:'VTLF2.250/0-79', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-264A', name:'Sewing Machine - 1204', type:'Sewing Machine', location:'Building C', manufacturer:'FUWEI', model:'1204', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-264B', name:'Sewing Machine - 1204', type:'Sewing Machine', location:'Vista', manufacturer:'FUWEI', model:'1204', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-265', name:'Bandsaw - Gruppo Grassi', type:'Bandsaw', location:'Flexible Fab Dept', manufacturer:'Gruppo Grassi', model:'', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-268A', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-268B', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-268C', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-28', name:'ForkLift - 8FGCU25', type:'ForkLift', location:'Rigid Foam Dept', manufacturer:'Toyota', model:'8FGCU25', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-29', name:'Engineering - Trace Digitizing', type:'Engineering', location:'Building C', manufacturer:'Logic Tec', model:'Trace Digitizing', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-30', name:'Pallet Racking - 10 Racks', type:'Pallet Racking', location:'Building C', manufacturer:'QHM', model:'10 Racks', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-31', name:'Router - G9981', type:'Router', location:'Rigid Foam Dept', manufacturer:'Grizzly', model:'G9981', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-32', name:'Engineering - Tracer', type:'Engineering', location:'Building C', manufacturer:'Logic Tec', model:'Tracer', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-36A', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-36B', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-36C', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-36D', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-36E', name:'Sewing Machine - M Type 576', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Durkopp Adler', model:'M Type 576', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-38', name:'ForkLift - Foam Clamp', type:'ForkLift', location:'Rigid Foam Dept', manufacturer:'', model:'Foam Clamp', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-41', name:'Sewing Machine - M Type 867', type:'Sewing Machine', location:'Building C', manufacturer:'Durkopp Adler', model:'M Type 867', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-42', name:'CNC Router - 5T5-5-5-36SCOxRx', type:'CNC Router', location:'CNC Dept', manufacturer:'DMS', model:'5T5-5-5-36SCOxRx', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-46', name:'Sewing Machine - M Type 867', type:'Sewing Machine', location:'Leather Dept 1', manufacturer:'Durkopp Adler', model:'M Type 867', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-5', name:'CNC Router - 5T5-5-5-48TCxxRx', type:'CNC Router', location:'CNC Dept', manufacturer:'DMS', model:'5T5-5-5-48TCxxRx', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-63', name:'Marking Machines - Jet Stamp 790MP', type:'Marking Machines', location:'Plastic Fab Dept', manufacturer:'Rein', model:'Jet Stamp 790MP', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-64', name:'Marking Machines - Jet Stamp 790MP', type:'Marking Machines', location:'Plastic Fab Dept', manufacturer:'Rein', model:'Jet Stamp 790MP', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-65A', name:'Marking Machines - Jet Stamp 790MP', type:'Marking Machines', location:'Plastic Fab Dept', manufacturer:'Rein', model:'Jet Stamp 790MP', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-65B', name:'Marking Machines - Jet Stamp 790MP', type:'Marking Machines', location:'Plastic Fab Dept', manufacturer:'Rein', model:'Jet Stamp 790MP', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-66A', name:'Work Station - QHM', type:'Work Station', location:'Plastic Fab Dept', manufacturer:'QHM', model:'Work Station', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-66B', name:'Work Station - QHM', type:'Work Station', location:'Plastic Fab Dept', manufacturer:'QHM', model:'Work Station', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-68B', name:'Cabinet - 13x24x36', type:'Cabinet', location:'Plastic Dept', manufacturer:'Justrite', model:'13x24x36', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-69A', name:'Cabinet - 13x43x65', type:'Cabinet', location:'Plastic Fab Dept', manufacturer:'Justrite', model:'13x43x65', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-82', name:'Air Compressor - ST1100', type:'Air Compressor', location:'Building C', manufacturer:'Sullair', model:'ST1100', serviceFreqDays:90, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-86', name:'Inspection Table - RLM Vet3500', type:'Inspection Table', location:'Building C', manufacturer:'Campbell-Randall', model:'RLM Vet3500', serviceFreqDays:180, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-88 A-E', name:'Sewing Tables - Custom Sewing Tables', type:'Sewing Tables', location:'Building C', manufacturer:'Doug Heiberg', model:'Custom Sewing Tables', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-89 A-D', name:'Sewing Tables - Custom Sewing Tables', type:'Sewing Tables', location:'Building C', manufacturer:'Doug Heiberg', model:'Custom Sewing Tables', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-95', name:'Pallet Racking - Rack Beams', type:'Pallet Racking', location:'Plastic Fab Dept', manufacturer:'JJ Racking', model:'Rack Beams', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-96', name:'Pallet Racking - Rack Riser', type:'Pallet Racking', location:'Plastic Fab Dept', manufacturer:'JJ Racking', model:'Rack Riser', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-A', name:'Sewing Machine - H360-9134-JG', type:'Sewing Machine', location:'Building C', manufacturer:'Checkit', model:'H360-9134-JG', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'AFI-B', name:'Sewing Machine - H360-9134-JG', type:'Sewing Machine', location:'Vista', manufacturer:'Checkit', model:'H360-9134-JG', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-14', name:'Bandsaw - JWBS-20-1', type:'Bandsaw', location:'Seat Fab Dept', manufacturer:'Jet', model:'JWBS-20-1', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-179', name:'Bandsaw - Hot Knife', type:'Bandsaw', location:'Seat Fab Dept', manufacturer:'Tara', model:'Hot Knife', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-184A', name:'Bandsaw - RBMR 130', type:'Bandsaw', location:'Flexible Fab Dept', manufacturer:'Krauss', model:'RBMR 130', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-184B', name:'Bandsaw - RBMR 130', type:'Bandsaw', location:'Flexible Fab Dept', manufacturer:'Krauss', model:'RBMR 130', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-191', name:'Die Cutter - 273M', type:'Die Cutter', location:'Flexible Fab Dept', manufacturer:'Vilh Pederson', model:'273M', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-193', name:'Drill Press - 1600', type:'Drill Press', location:'Rigid Foam Dept', manufacturer:'Walker-Turner', model:'1600', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-22', name:'Drill Press - 1112-23', type:'Drill Press', location:'Rigid Foam Dept', manufacturer:'Walker-Turner', model:'1112-23', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-23', name:'Drill Press - 126-184', type:'Drill Press', location:'Rigid Foam Dept', manufacturer:'Delta', model:'126-184', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-378', name:'Cutting Machine - Blue Streak 2', type:'Cutting Machine', location:'Fireblock Dept', manufacturer:'Eastman', model:'Blue Streak 2', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-387A', name:'Bandsaw - S5', type:'Bandsaw', location:'Seat Glue Dept', manufacturer:'Ragel', model:'S5', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-387B', name:'Bandsaw - 199-0100', type:'Bandsaw', location:'Seat Glue Dept', manufacturer:'Enco', model:'199-0100', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-398', name:'Velcro Cutter - HC530A', type:'Velcro Cutter', location:'Building C', manufacturer:'Sheffield', model:'HC530A', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-430', name:'Sewing Machine - 516-4', type:'Sewing Machine', location:'Fireblock Dept', manufacturer:'Willcox&Gibbs', model:'516-4', serviceFreqDays:30, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-433 A-G', name:'Hampers - McMasterCar', type:'Hampers', location:'Fireblock Dept', manufacturer:'McMasterCar', model:'', serviceFreqDays:365, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-436', name:'Drill Marker - CD3', type:'Drill Marker', location:'Fireblock Dept', manufacturer:'Eastman', model:'CD3', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-46', name:'Bandsaw - SA-20', type:'Bandsaw', location:'Seat Fab Dept', manufacturer:'Butcher Boy', model:'SA-20', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-461', name:'Cutting Machine - Blue Streak 2', type:'Cutting Machine', location:'Fireblock Dept', manufacturer:'Eastman', model:'Blue Streak 2', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-504', name:'Leather Shaver - DCS-S4', type:'Leather Shaver', location:'Building C', manufacturer:'Consew', model:'DCS-S4', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-51', name:'Tablesaw - JWCS-10', type:'Tablesaw', location:'Seat Fab Dept', manufacturer:'Jet', model:'JWCS-10', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-52', name:'Bandsaw - S45', type:'Bandsaw', location:'Seat Glue Dept', manufacturer:'Mini Max', model:'S45', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-59', name:'Bandsaw - M3764', type:'Bandsaw', location:'Seat Glue Dept', manufacturer:'Fecken-Kirfel', model:'M3764', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-60', name:'Die Cutter - AOC60A', type:'Die Cutter', location:'Flexible Fab Dept', manufacturer:'SYSCO', model:'AOC60A', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-64', name:'Router - POR-22-1', type:'Router', location:'Rigid Foam Dept', manufacturer:'Jet', model:'POR-22-1', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-91', name:'Buffer - Sand-Rite', type:'Buffer', location:'Seat Fab Dept', manufacturer:'Sand-Rite', model:'Buffer', serviceFreqDays:60, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-9A', name:'Bandsaw - 11\' 8"', type:'Bandsaw', location:'Seat Fab Dept', manufacturer:'Davis & Wells', model:'11\' 8"', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' },
  { id:'QFP-9B', name:'Bandsaw - DB-20-87', type:'Bandsaw', location:'Seat Fab Dept', manufacturer:'Enco', model:'DB-20-87', serviceFreqDays:45, lastService:'', status:'Operational', manualLink:'' }
];

// ---- WORK ORDERS (from Airtable Service Log table) ----
let workOrders = [
  { id:'WO-001', machineId:'AFI-125', machineName:'Bldg C Laminator', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-01', assignedTech:'EO', status:'Closed', notes:'Replaced Bearing', resolutionNotes:'Bearing replaced and tested', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-01', workCompleted:'2025-08-01', machineDown: false },
  { id:'WO-002', machineId:'QFP-531A', machineName:'Flow Waterjet', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-01', assignedTech:'EO', status:'Closed', notes:'Flow waterjet Wiring and grease', resolutionNotes:'Rewired and greased all rails', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-01', workCompleted:'2025-08-01', machineDown: false },
  { id:'WO-003', machineId:'AFI-125', machineName:'Bldg C Laminator', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-01', assignedTech:'EO', status:'Closed', notes:'Removed Bladder and grease', resolutionNotes:'Bladder removed and regreased', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-01', workCompleted:'2025-08-01', machineDown: false },
  { id:'WO-004', machineId:'QFP-531A', machineName:'Flow Waterjet', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-04', assignedTech:'EO', status:'Open', notes:'New wire Harness P/N 044107-5 / Greased Rails', resolutionNotes:'', partsUsed:'', partsCost:0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-04', workCompleted:'', machineDown: false },
  { id:'WO-005', machineId:'AFI-125', machineName:'Bldg C Laminator', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-04', assignedTech:'EO', status:'Closed', notes:'Greased and Clean / Replaced Bladder', resolutionNotes:'Cleaned and bladder replaced', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-04', workCompleted:'2025-08-04', machineDown: false },
  { id:'WO-006', machineId:'AFI-33', machineName:'Seat Fab Router', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-05', assignedTech:'EO', status:'Closed', notes:'ON/OFF SWITCH / REFIT AIR REGULATOR AND AIR HOSES', resolutionNotes:'Switch replaced and air system refit', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-05', workCompleted:'2025-08-05', machineDown: false },
  { id:'WO-007', machineId:'QFP-577A', machineName:'Wardjet Z', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-05', assignedTech:'EO', status:'Closed', notes:'High Pressure line and Transition Block on head 1 to 4', resolutionNotes:'HP lines and transition blocks replaced on all 4 heads', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-05', workCompleted:'2025-08-05', machineDown: false },
  { id:'WO-008', machineId:'AFI-191', machineName:'Plastic Dept Maac ASP', incidentType:'Repair', priority:'Medium', category:'Electrical', reportedBy:'EO', reportedDate:'2025-08-07', assignedTech:'EO', status:'Open', notes:'Replaced Fuse for Oven', resolutionNotes:'', partsUsed:'', partsCost:0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-07', workCompleted:'', machineDown: false },
  { id:'WO-009', machineId:'QFP-577A', machineName:'Wardjet Z', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-06', assignedTech:'EO', status:'Closed', notes:'Replaced High pressure line', resolutionNotes:'HP line replaced and tested', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-06', workCompleted:'2025-08-06', machineDown: false },
  { id:'WO-010', machineId:'AFI-254', machineName:'Plastic Dept Maac', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-15', assignedTech:'EO', status:'Closed', notes:'Replaced Disconnect on Clamp Frames', resolutionNotes:'Disconnect replaced on clamp frames', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-15', workCompleted:'2025-08-15', machineDown: false },
  { id:'WO-011', machineId:'AFI-257', machineName:'PathFinder', incidentType:'Repair', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-08-14', assignedTech:'EO', status:'Closed', notes:'Switch on PathFinder (Fireblock Dept)', resolutionNotes:'Switch replaced', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-14', workCompleted:'2025-08-14', machineDown: false },
  { id:'WO-012', machineId:'QFP-81', machineName:'Brown Machinery', incidentType:'Preventive', priority:'Medium', category:'Scheduled PM', reportedBy:'EO', reportedDate:'2025-08-14', assignedTech:'EO', status:'Closed', notes:'Brown Machine Oven PM', resolutionNotes:'PM completed ‚Äî oven inspected and cleaned', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:true, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-08-14', workCompleted:'2025-08-14', machineDown: false },
  { id:'WO-013', machineId:'AFI-87', machineName:'Gerber', incidentType:'Preventive', priority:'Medium', category:'Mechanical', reportedBy:'EO', reportedDate:'2025-09-11', assignedTech:'EO', status:'Closed', notes:'Gerber PM service - cleaned and inspected', resolutionNotes:'Full PM service completed', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:true, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-09-11', workCompleted:'2025-09-11', machineDown: false },
  { id:'WO-014', machineId:'AFI-16', machineName:'MAAC ASP #1', incidentType:'Preventive', priority:'Medium', category:'Scheduled PM', reportedBy:'EO', reportedDate:'2025-12-08', assignedTech:'EO', status:'Closed', notes:'MAAC ASP quarterly PM completed', resolutionNotes:'Quarterly PM ‚Äî all checks passed', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:true, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-12-08', workCompleted:'2025-12-08', machineDown: false },
  { id:'WO-015', machineId:'QFP-577B', machineName:'Hypertherm', incidentType:'Repair', priority:'High', category:'Pressure System', reportedBy:'EO', reportedDate:'2025-09-16', assignedTech:'EO', status:'Closed', notes:'Replaced seals on intensifier pump', resolutionNotes:'Intensifier pump seals replaced and pressure tested', partsUsed:'', partsCost:0.0, laborCost:0, _isPM:false, followUp:'No', followUpDate:'', followUpNotes:'', workStarted:'2025-09-16', workCompleted:'2025-09-16', machineDown: false }
];

// Dynamically derived from machine data
function getLocations() {
  return [...new Set(machines.map(m => m.location).filter(Boolean))].sort();
}
const INLINE_MACHINE_COUNT = machines.length;

// ===================================================================
// AIRTABLE API LAYER
// ===================================================================
const AirtableAPI = {
  headers() {
    return { 'Authorization': `Bearer ${CONFIG.airtable.apiKey}`, 'Content-Type': 'application/json' };
  },
  baseUrl() {
    return `https://api.airtable.com/v0/${CONFIG.airtable.baseId}`;
  },
  async fetchAll(tableName) {
    let all = [], offset = null, page = 0;
    do {
      if (page > 0) await new Promise(r => setTimeout(r, 220)); // rate limit: stay under 5 RPS
      const url = `${this.baseUrl()}/${encodeURIComponent(tableName)}${offset ? '?offset='+offset : ''}`;
      const res = await fetch(url, { headers: this.headers() });
      if (!res.ok) throw new Error(`Airtable ${res.status}: ${res.statusText}`);
      const data = await res.json();
      all.push(...data.records);
      offset = data.offset;
      page++;
    } while (offset);
    return all;
  },
  async createRecord(tableName, fields) {
    const res = await fetch(`${this.baseUrl()}/${encodeURIComponent(tableName)}`, {
      method: 'POST', headers: this.headers(),
      body: JSON.stringify({ fields })
    });
    if (!res.ok) throw new Error(`Airtable ${res.status}`);
    return await res.json();
  },
  async updateRecord(tableName, recordId, fields) {
    const res = await fetch(`${this.baseUrl()}/${encodeURIComponent(tableName)}/${recordId}`, {
      method: 'PATCH', headers: this.headers(),
      body: JSON.stringify({ fields })
    });
    if (!res.ok) throw new Error(`Airtable ${res.status}`);
    return await res.json();
  },
  async testConnection() {
    const res = await fetch(`${this.baseUrl()}/${encodeURIComponent(CONFIG.airtable.tables.machines)}?maxRecords=1`, {
      headers: this.headers()
    });
    return res.ok;
  }
};

// ===================================================================
// DATA ACCESS (abstracts mock vs Airtable)
// ===================================================================
const DataService = {
  async getMachines() {
    if (CONFIG.useAirtable) {
      try {
        const records = await AirtableAPI.fetchAll(CONFIG.airtable.tables.machines);
        machines = records.map(r => ({
          _airtableId: r.id,
          id: r.fields['Machine_ID'] || r.fields['Machine ID'] || '',
          name: r.fields['Machine_Name'] || r.fields['Name'] || '',
          type: r.fields['Type'] || '',
          location: r.fields['Location'] || '',
          manufacturer: r.fields['Manufacturer'] || '',
          model: r.fields['Model'] || '',
          serviceFreqDays: r.fields['Service_Freq_Days'] || r.fields['Service Freq (Days)'] || 30,
          lastService: r.fields['Last_Service'] || r.fields['Last Service'] || '',
          status: r.fields['Status'] || r.fields['Current Status'] || 'Operational',
          manualLink: r.fields['Manual_Link'] || r.fields['Manual Link'] || '',
          nextServiceOverride: r.fields['Next_Service_Override'] || '',
          _followUpNotes: r.fields['Override_Notes'] || '',
          downSince: r.fields['Down_Since'] || '',
        }));
      } catch(e) { toast('Airtable fetch failed: ' + e.message, 'error'); }
    }
    return machines;
  },
  async getWorkOrders() {
    if (CONFIG.useAirtable) {
      try {
        const records = await AirtableAPI.fetchAll(CONFIG.airtable.tables.serviceLog);
        workOrders = records.map(r => ({
          _airtableId: r.id,
          id: r.fields['WO_ID'] || r.id,
          machineId: r.fields['Machine_ID'] || r.fields['Machine ID'] || '',
          machineName: r.fields['Machine_Name'] || r.fields['Machine Name'] || '',
          incidentType: r.fields['Incident_Type'] || r.fields['Incident Type'] || '',
          priority: r.fields['Priority'] || 'Medium',
          category: r.fields['Category'] || r.fields['Issue Category'] || '',
          reportedBy: r.fields['Reported_By'] || r.fields['Reported By'] || '',
          reportedDate: r.fields['Reported_Date'] || r.fields['Reported Date/Time'] || '',
          assignedTech: r.fields['Assigned_Tech'] || r.fields['Assigned Tech'] || '',
          status: r.fields['Status'] || '',
          notes: r.fields['Notes'] || r.fields['Resolution Notes'] || '',
          laborCost: r.fields['Labor_Cost'] || r.fields['Labor Cost'] || 0,
          partsCost: r.fields['Parts_Cost'] || r.fields['Parts Cost'] || 0,
          _isPM: r.fields['Is_PM'] || false,
          partsUsed: r.fields['Parts_Used'] || '',
          followUp: r.fields['Follow_Up'] || 'No',
          followUpDate: r.fields['Follow_Up_Date'] || '',
          followUpNotes: r.fields['Follow_Up_Notes'] || '',
          resolutionNotes: r.fields['Resolution_Notes'] || '',
          workStarted: r.fields['Work_Started'] || '',
          workCompleted: r.fields['Work_Completed'] || '',
          machineDown: r.fields['Machine_Down'] || false,
        }));
      } catch(e) { toast('Airtable fetch failed: ' + e.message, 'error'); }
    }
    return workOrders;
  },
  async getOperators() {
    if (CONFIG.useAirtable) {
      try {
        const records = await AirtableAPI.fetchAll(CONFIG.airtable.tables.operators);
        operators = records.map(r => ({
          _airtableId: r.id,
          id: r.id,
          name: r.fields['Name'] || '',
          role: r.fields['Role'] || 'Technician',
          active: r.fields['Active'] !== false,
        }));
      } catch(e) { toast('Airtable fetch failed: ' + e.message, 'error'); }
    }
    return operators;
  },
  async addWorkOrder(wo) {
    if (CONFIG.useAirtable) {
      try {
        const fields = {
          'Machine_ID': wo.machineId,
          'Machine_Name': wo.machineName,
          'Incident_Type': wo.incidentType,
          'Priority': wo.priority,
          'Category': wo.category,
          'Reported_By': wo.reportedBy,
          'Reported_Date': wo.reportedDate,
          'Assigned_Tech': wo.assignedTech,
          'Status': wo.status,
          'Notes': wo.notes,
          'Is_PM': wo._isPM || false,
          'Machine_Down': wo.machineDown || false,
        };
        wo._airtableId = (await AirtableAPI.createRecord(CONFIG.airtable.tables.serviceLog, fields)).id;
      } catch(e) {
        toast('Work order NOT saved ‚Äî Airtable write failed: ' + e.message, 'error');
        return false; // signal failure to caller
      }
    }
    workOrders.unshift(wo);
    LocalStore.save();
    return true;
  },
  async addMachine(m) {
    if (CONFIG.useAirtable) {
      try {
        const fields = {
          'Machine_ID': m.id, 'Machine_Name': m.name, 'Type': m.type,
          'Location': m.location, 'Manufacturer': m.manufacturer, 'Model': m.model,
          'Service_Freq_Days': m.serviceFreqDays, 'Status': m.status,
        };
        m._airtableId = (await AirtableAPI.createRecord(CONFIG.airtable.tables.machines, fields)).id;
      } catch(e) {
        toast('Machine NOT saved ‚Äî Airtable write failed: ' + e.message, 'error');
        return false;
      }
    }
    machines.push(m);
    LocalStore.save();
    return true;
  },
  async addOperator(op) {
    if (CONFIG.useAirtable) {
      try {
        const fields = { 'Name': op.name, 'Role': op.role, 'Active': true };
        op._airtableId = (await AirtableAPI.createRecord(CONFIG.airtable.tables.operators, fields)).id;
      } catch(e) {
        toast('Operator NOT saved ‚Äî Airtable write failed: ' + e.message, 'error');
        return false;
      }
    }
    operators.push(op);
    LocalStore.save();
  }
};

// ===================================================================
// UTILITY
// ===================================================================

// FIX: XSS sanitizer ‚Äî all user content must pass through this before innerHTML
// Helper: push fields to Airtable with guard + error toast
async function syncAirtable(table, recordId, fields, errMsg) {
  if (!CONFIG.useAirtable || !recordId) return;
  try { await AirtableAPI.updateRecord(table, recordId, fields); }
  catch(e) { toast((errMsg || 'Airtable sync failed') + ': ' + e.message, 'error'); }
}

// Helper: render a detail label+value pair
function detailCell(label, value, extraClass) {
  return `<div><span class="detail-label">${label}</span><br><span class="detail-value${extraClass?' '+extraClass:''}">${value}</span></div>`;
}

function esc(str) {
  if (str === null || str === undefined) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// FIX H-4: Parse date-only strings as local noon to avoid UTC offset showing wrong day
function parseLocalDate(dateStr) {
  if (!dateStr) return null;
  const dt = (typeof dateStr === 'string' && !dateStr.includes('T')) ? new Date(dateStr + 'T12:00:00') : new Date(dateStr);
  return isNaN(dt) ? null : dt;
}
function getNextServiceDate(machine) {
  if (machine.nextServiceOverride) {
    const override = parseLocalDate(machine.nextServiceOverride);
    if (override) return override;
  }
  if (!machine.lastService) return null;
  const last = parseLocalDate(machine.lastService);
  if (!last) return null;
  return new Date(last.getTime() + machine.serviceFreqDays * 86400000);
}
function daysUntilService(machine) {
  const next = getNextServiceDate(machine);
  return next ? Math.floor((next - new Date()) / 86400000) : -9999;
}
function nextServiceDate(machine) {
  const next = getNextServiceDate(machine);
  return next ? next.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' }) : 'Unknown';
}
function formatDate(d) {
  if (!d) return '‚Äî';
  const parsed = parseLocalDate(d);
  return parsed ? parsed.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' }) : '‚Äî';
}

// FIX: Error toasts persist 8s, critical errors persist until clicked
function toast(msg, type='success') {
  const c = $('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast ' + (type||'');
  t.textContent = msg;
  const duration = type === 'error' ? 8000 : 4000;
  t.style.cursor = 'pointer';
  t.onclick = () => t.remove();
  c.appendChild(t);
  setTimeout(() => { if (t.parentNode) t.remove(); }, duration);
}

// FIX: Collision-proof ID generation using timestamp + random
function uid() {
  return 'WO-' + Date.now().toString(36).toUpperCase() + '-' + Math.random().toString(36).substring(2, 5).toUpperCase();
}

// FIX: Debounce for search inputs
function debounce(fn, ms) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), ms);
  };
}

// ===================================================================
// SHARED RENDERING HELPERS
// ===================================================================
function woBadgeClass(s) {
  return s === 'Open' ? 'badge-open' : s === 'Pending' ? 'badge-pending' : 'badge-closed';
}
function badgeStatus(s, extra) {
  return `<span class="badge-status ${woBadgeClass(s)}">${esc(s)}${extra||''}</span>`;
}
function machineBadge(m, dts) {
  if (dts < 0 && dts !== -9999) return '<span class="badge-status badge-overdue">‚ö† OVERDUE ' + Math.abs(dts) + 'd</span>';
  return `<span class="badge-status ${m.status === 'Down - Critical' || m.status === 'Down - Non-Critical' ? 'badge-critical' : 'badge-operational'}">${esc(m.status)}</span>`;
}
function renderChart(data, colors, defColor) {
  const max = Math.max(...Object.values(data), 1);
  return Object.entries(data).sort((a,b) => b[1]-a[1]).map(([k,v]) =>
    `<div class="bar-chart-row"><div class="bar-label">${esc(k)}</div><div class="bar-track"><div class="bar-fill" style="width:${(v/max)*100}%;background:${colors[k]||defColor}"></div></div><div class="bar-count">${v}</div></div>`
  ).join('');
}
function renderServiceHistory(wos) {
  if (!wos.length) return '<p style="color:var(--text-muted);font-size:13px">No service history recorded.</p>';
  return `<table class="data-table"><thead><tr><th>Date</th><th>Type</th><th>Tech</th><th>Status</th><th>Notes</th></tr></thead><tbody>
    ${wos.slice(0,10).map(w => `<tr ${w.status!=='Closed'?`onclick="closeModal('machineModal');openResolveWO('${esc(w.id)}')" style="cursor:pointer"`:''}>
      <td style="white-space:nowrap">${formatDate(w.reportedDate)}</td><td>${esc(w.incidentType)}</td>
      <td>${esc(w.assignedTech) || '<span style="color:var(--text-muted);font-style:italic">‚Äî</span>'}</td>
      <td>${badgeStatus(w.status, w.status==='Open'?' ‚Üó':'')}</td><td class="cell-truncate">${esc(w.notes)}</td>
    </tr>`).join('')}
  </tbody></table>`;
}

// ===================================================================
// NAVIGATION
// ===================================================================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  $('page-'+name).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const btns = document.querySelectorAll('.nav-btn');
  const map = { dashboard:0, machines:1, workorders:2, scan:3, operators:4, settings:5 };
  if (map[name] !== undefined) btns[map[name]].classList.add('active');
  if (name === 'dashboard') refreshDashboard();
  if (name === 'machines') renderMachines();
  if (name === 'workorders') renderWorkOrders();
  if (name === 'operators') renderOperators();
  if (name === 'scan') { $('scanInput').focus(); $('scanResult').innerHTML = ''; }
  // Hide FAB when already on scan page
  const fab = $('scanFab');
  if (fab) fab.classList.toggle('hide-on-scan', name === 'scan');
  // close mobile sidebar
  $('sidebar').classList.remove('open');
  $('sidebarOverlay').classList.remove('open');
}
function toggleSidebar() {
  $('sidebar').classList.toggle('open');
  $('sidebarOverlay').classList.toggle('open');
}
function openModal(id) { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }

// ===================================================================
// DASHBOARD & PM GENERATION
// ===================================================================
let _pmGenerated = false;
async function generatePMWorkOrders() {
  if (_pmGenerated) return;
  _pmGenerated = true;
  // Only generate PMs for machines with known service history ‚Äî skip machines with no lastService
  const overdueMachines = machines.filter(m => m.lastService && daysUntilService(m) < 0);
  const activePMs = new Set(workOrders.filter(w => (w.status === 'Open' || w.status === 'Pending') && w._isPM).map(w => w.machineId));
  let created = 0;

  for (const m of overdueMachines) {
    if (activePMs.has(m.id)) continue; // already queued, skip

    const daysOver = Math.abs(daysUntilService(m));
    const priority = daysOver > 90 ? 'High' : daysOver > 30 ? 'Medium' : 'Low';

    const wo = {
      id: uid(),
      machineId: m.id,
      machineName: m.name,
      incidentType: 'Preventive',
      priority: priority,
      category: 'Scheduled PM',
      reportedBy: 'System',
      reportedDate: todayISO(),
      assignedTech: '',
      status: 'Open',
      notes: `Auto-generated PM ‚Äî ${m.serviceFreqDays}-day service interval overdue by ${daysOver} days. Last serviced ${formatDate(m.lastService)}.`,
      laborCost: 0,
      partsCost: 0,
      partsUsed: '',
      followUp: 'No',
      followUpDate: '',
      followUpNotes: '',
      resolutionNotes: '',
      workStarted: '',
      workCompleted: '',
      _isPM: true, // flag to prevent duplicates
    };

    await DataService.addWorkOrder(wo);
    logActivity('pm', wo.id, m.id, `PM auto-generated ‚Äî ${daysOver}d overdue (${m.serviceFreqDays}d interval)`);
    created++;
  }

  if (created > 0) {
    LocalStore.save(); // Persist activity log entries from PM generation
    toast(`${created} PM work order${created>1?'s':''} auto-generated for overdue machines`, 'warning');
  }
}

// ===================================================================
// DASHBOARD
// ===================================================================
let _refreshing = false;
async function refreshDashboard() {
  if (_refreshing) return;
  _refreshing = true;
  const refreshBtn = document.querySelector('#page-dashboard .btn-secondary');
  if (refreshBtn) { refreshBtn.disabled = true; refreshBtn.textContent = '‚Üª Syncing‚Ä¶'; }

  try {
  await DataService.getMachines();
  await DataService.getWorkOrders();
  await DataService.getOperators();

  // AUTO-GENERATE PM WORK ORDERS for overdue machines
  await generatePMWorkOrders();

  if (CONFIG.useAirtable) {
    const ts = new Date().toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
    $('dashDate').innerHTML = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) +
      ` <span style="font-size:11px;color:var(--green);font-family:var(--font-mono);margin-left:8px">‚óè Synced ${ts}</span>`;
  } else {
    $('dashDate').textContent = new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  }

  const activePMsMap = new Map();
  workOrders.forEach(w => { if ((w.status === 'Open' || w.status === 'Pending') && w._isPM) activePMsMap.set(w.machineId, w); });
  const overdue = machines.filter(m => m.lastService && daysUntilService(m) < 0);
  const openWO = workOrders.filter(w => w.status === 'Open');
  const pendingWO = workOrders.filter(w => w.status === 'Pending');
  const closedWO = workOrders.filter(w => w.status === 'Closed');

  $('openWoBadge').textContent = openWO.length + pendingWO.length;

  $('kpiGrid').innerHTML = `
    <div class="kpi-card overdue"><div class="kpi-accent"></div><div class="kpi-icon">‚ö†Ô∏è</div><div class="kpi-value">${overdue.length}</div><div class="kpi-label">Overdue Services</div></div>
    <div class="kpi-card open"><div class="kpi-accent"></div><div class="kpi-icon">üîß</div><div class="kpi-value">${openWO.length}</div><div class="kpi-label">Open Work Orders</div></div>
    <div class="kpi-card" style="--accent:var(--amber)"><div class="kpi-accent"></div><div class="kpi-icon">‚è≥</div><div class="kpi-value">${pendingWO.length}</div><div class="kpi-label">Pending Follow-up</div></div>
    <div class="kpi-card completed"><div class="kpi-accent"></div><div class="kpi-icon">‚úÖ</div><div class="kpi-value">${closedWO.length}</div><div class="kpi-label">Completed WOs</div></div>
  `;

  // Overdue table ‚Äî now links to the PM work order so management can assign directly
  const sorted = [...overdue].sort((a,b) => daysUntilService(a) - daysUntilService(b));
  $('overdueCount').textContent = overdue.length + ' machines';
  const tbody = document.querySelector('#overdueTable tbody');
  tbody.innerHTML = sorted.slice(0,10).map(m => {
    const days = Math.abs(daysUntilService(m));
    const pmWO = workOrders.find(w => w.machineId === m.id && (w.status === 'Open' || w.status === 'Pending') && w._isPM);
    const clickAction = pmWO
      ? `onclick="openResolveWO('${pmWO.id}')" title="Click to assign tech & resolve"`
      : `onclick="openMachineDetail('${esc(m.id)}')"`;
    return `<tr style="cursor:pointer" ${clickAction}>
      <td class="machine-id">${esc(m.id)}</td>
      <td class="cell-name">${esc(m.name)}</td>
      <td><span style="color:var(--red);font-family:var(--font-mono);font-weight:600">${days}d</span></td>
      <td>${pmWO
        ? `<span class="badge-status badge-open" style="font-size:10px">${pmWO.id} ¬∑ ASSIGN ‚Üó</span>`
        : '<span class="badge-status badge-overdue">‚ö† OVERDUE</span>'
      }</td>
    </tr>`;
  }).join('');

  // WO Type chart
  const types = {};
  workOrders.forEach(w => { types[w.incidentType] = (types[w.incidentType]||0) + 1; });
  $('woTypeChart').innerHTML = renderChart(types, { Corrective:'var(--red)', Preventive:'var(--green)', Emergency:'var(--amber)', Inspection:'var(--blue)', Repair:'var(--red)', Installation:'var(--purple)', Upgrade:'var(--cyan)' }, 'var(--blue)');

  // Recent Activity ‚Äî rendered from transaction log
  renderActivityFeed();

  // Location chart
  const locs = {};
  machines.forEach(m => { locs[m.location] = (locs[m.location]||0) + 1; });
  $('locationChart').innerHTML = renderChart(locs, {}, 'var(--cyan)');
  } finally {
    _refreshing = false;
    if (refreshBtn) { refreshBtn.disabled = false; refreshBtn.textContent = '‚Üª Refresh'; }
  }
}

// ===================================================================
// MACHINES
// ===================================================================
let machineLocationFilter = 'all';

function renderLocationFilters() {
  const locs = getLocations();
  $('locationFilters').innerHTML =
    `<div class="filter-chip ${machineLocationFilter==='all'?'active':''}" data-loc="all" onclick="setMachineFilter(this)">All</div>` +
    locs.map(l => `<div class="filter-chip ${machineLocationFilter===l?'active':''}" data-loc="${esc(l)}" onclick="setMachineFilter(this)">${esc(l)}</div>`).join('');
}

function setMachineFilter(el) {
  machineLocationFilter = el.dataset.loc;
  document.querySelectorAll('#locationFilters .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderMachineGrid();
}

function renderMachines() {
  $('machineCount').textContent = machines.length;
  renderLocationFilters();
  renderMachineGrid();
}

function renderMachineGrid() {
  const search = ($('machineSearch').value||'').toLowerCase();
  const filtered = machines.filter(m => {
    if (machineLocationFilter !== 'all' && m.location !== machineLocationFilter) return false;
    if (search && !([m.id, m.name, m.type, m.manufacturer].join(' ')).toLowerCase().includes(search)) return false;
    return true;
  });

  $('machinesGrid').innerHTML = filtered.map(m => {
    const dts = daysUntilService(m);
    const isOverdue = dts < 0 && dts !== -9999;
    const statusBadge = isOverdue ? '<span class="badge-status badge-overdue">‚ö† OVERDUE</span>' :
      m.status.includes('Down') ? '<span class="badge-status badge-critical">'+m.status+'</span>' :
      '<span class="badge-status badge-operational">'+m.status+'</span>';

    return `<div class="machine-card" onclick="openMachineDetail('${esc(m.id)}')">
      ${isOverdue ? '<div class="mc-overdue-bar"></div>' : ''}
      <div class="mc-top">
        <div class="mc-id">${esc(m.id)}</div>
        ${statusBadge}
      </div>
      <div class="mc-name">${esc(m.name)}</div>
      <div class="mc-type">${esc(m.type)} ¬∑ ${esc(m.manufacturer)}</div>
      <div class="mc-meta">
        <div><span class="label">Location</span>${esc(m.location)}</div>
        <div><span class="label">Service Freq</span>${m.serviceFreqDays}d</div>
        <div><span class="label">Next Service</span>${nextServiceDate(m)}</div>
      </div>
    </div>`;
  }).join('');
}


function openAddMachine() {
  const sel = $('amLocation');
  sel.innerHTML = getLocations().map(l => `<option>${esc(l)}</option>`).join('');
  openModal('addMachineModal');
}

async function addMachine() {
  const m = {
    id: $val('amId'),
    name: $val('amName'),
    type: $val('amType'),
    location: $val('amLocation'),
    manufacturer: $val('amMfg'),
    model: $val('amModel'),
    serviceFreqDays: parseInt($val('amFreq')) || 30,
    lastService: todayISO(),
    status: $('amStatus').value,
    manualLink: '',
  };
  if (!m.id || !m.name) { toast('Machine ID and Name required','error'); return; }
  if (machines.find(x => x.id.toUpperCase() === m.id.toUpperCase())) { toast('Machine ID ' + m.id + ' already exists','error'); return; }
  await DataService.addMachine(m);
  closeModal('addMachineModal');
  renderMachines();
  toast('Machine added: ' + m.id);
}

function openMachineDetail(id) {
  const m = machines.find(x => x.id === id);
  if (!m) return;
  const dts = daysUntilService(m);
  const isOverdue = dts < 0 && dts !== -9999;
  const mWOs = workOrders.filter(w => w.machineId === id).sort((a,b) => new Date(b.reportedDate)-new Date(a.reportedDate));

  $('machineModalTitle').innerHTML = `<span style="color:var(--amber)">${esc(m.id)}</span> ‚Äî ${esc(m.name)}`;
  $('machineModalBody').innerHTML = `
    <div class="detail-grid">
      ${detailCell('Type', esc(m.type))}
      ${detailCell('Location', esc(m.location))}
      ${detailCell('Manufacturer', esc(m.manufacturer))}
      ${detailCell('Model', esc(m.model))}
      ${detailCell('Service Freq', m.serviceFreqDays + ' days')}
      ${detailCell('Last Service', formatDate(m.lastService))}
      <div><span class="detail-label">Next Service</span><br><span class="detail-value" ${isOverdue?'style="color:var(--red)"':''}>${nextServiceDate(m)} ${isOverdue?'('+Math.abs(dts)+'d OVERDUE)':''}</span>
      ${m.nextServiceOverride ? `<br><span style="font-size:11px;color:var(--amber)">üìÖ Follow-up override: ${formatDate(m.nextServiceOverride)}</span>` : ''}
      ${m._followUpNotes ? `<br><span style="font-size:11px;color:var(--text-muted)">üìå ${m._followUpNotes}</span>` : ''}
      </div>
      ${detailCell('Status', esc(m.status) + (m.downSince ? ' <span style="font-size:11px;color:var(--red);display:block">üîª Down since ' + formatDate(m.downSince) + ' (' + Math.max(1, Math.round((new Date() - new Date(m.downSince)) / 86400000)) + 'd)</span>' : ''))}
    </div>
    ${m.manualLink && /^https?:\/\//i.test(m.manualLink) ? `<a href="${esc(m.manualLink)}" target="_blank" rel="noopener" style="color:var(--amber);font-size:13px">üìÑ Manufacturer Manual ‚Üí</a><br><br>` : ''}
    <div class="section-divider">
      <h4 class="section-heading">Service History (${mWOs.length} records)</h4>
      ${renderServiceHistory(mWOs)}
    </div>
    <div style="margin-top:16px">
      <button class="btn btn-primary" onclick="closeModal('machineModal');prefillWO('${esc(m.id)}')">üö® Report Issue</button>
    </div>
  `;
  openModal('machineModal');
}

// ===================================================================
// WORK ORDERS
// ===================================================================
let woFilterStatus = 'Active';

function renderWorkOrders() {
  const search = ($('woSearch').value||'').toLowerCase();
  let filtered = workOrders.filter(w => {
    if (woFilterStatus === 'Active' && w.status !== 'Open' && w.status !== 'Pending') return false;
    if (woFilterStatus === 'Open' && w.status !== 'Open') return false;
    if (woFilterStatus === 'Pending' && w.status !== 'Pending') return false;
    if (woFilterStatus === 'Closed' && w.status !== 'Closed') return false;
    if (woFilterStatus === 'PM' && !w._isPM) return false;
    if (woFilterStatus === 'Reported' && w._isPM) return false;
    if (search && !(w.machineId+w.machineName+w.notes+w.assignedTech+w.reportedBy).toLowerCase().includes(search)) return false;
    return true;
  });

  filtered.sort((a,b) => new Date(b.reportedDate) - new Date(a.reportedDate));

  const tbody = document.querySelector('#woTable tbody');
  tbody.innerHTML = filtered.map(w => {
    const prioColor = { Critical:'var(--red)', High:'var(--amber)', Medium:'var(--text-secondary)', Low:'var(--text-muted)' };
    const clickable = `onclick="openResolveWO('${esc(w.id)}')" style="cursor:pointer"`;
    const pmTag = w._isPM ? '<span style="background:var(--blue-dim);color:var(--blue);font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;font-family:var(--font-mono);margin-left:4px">PM</span>' : '';
    return `<tr ${clickable}>
      <td class="machine-id">${esc(w.machineId)}</td>
      <td class="cell-name">${esc(w.machineName)}${pmTag}</td>
      <td>${esc(w.incidentType)}</td>
      <td style="color:${prioColor[w.priority]||'inherit'};font-weight:600;font-size:12px">${esc(w.priority)}</td>
      <td>${esc(w.category)}</td>
      <td style="white-space:nowrap">${formatDate(w.reportedDate)}</td>
      <td>${esc(w.assignedTech) || '<span style="color:var(--text-muted);font-style:italic">Unassigned</span>'}</td>
      <td>${badgeStatus(w.status)}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(w.notes)}</td>
    </tr>`;
  }).join('');
}

function filterWO(status, el) {
  woFilterStatus = status;
  document.querySelectorAll('#page-workorders .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderWorkOrders();
}
// ===================================================================
// MODE / LOGIN
// ===================================================================
function selectMode(mode) {
  _loginMode = mode;
  document.querySelectorAll('.mode-tile').forEach(t => t.classList.remove('selected'));
  $('tile-' + mode).classList.add('selected');
  $('loginPin').focus();
  $('loginErr').textContent = '';
}

function doLogin() {
  if (!_loginMode) { $('loginErr').textContent = 'Select a role first.'; return; }
  const pin = $('loginPin').value;

  let valid = false;
  _loggedInTechName = null;

  if (_loginMode === 'tech') {
    // tech PINs are a map: PIN ‚Üí name
    const name = CONFIG.pins.tech[pin];
    if (name) { valid = true; _loggedInTechName = name; }
  } else {
    valid = (pin === CONFIG.pins[_loginMode]);
  }

  if (!valid) {
    $('loginErr').textContent = 'Incorrect code ‚Äî try again.';
    $('loginPin').value = '';
    $('loginPin').focus();
    return;
  }
  currentMode = _loginMode;
  $('loginScreen').style.display = 'none';
  applyMode();
  refreshDashboard();
}

function doLogout() {
  if (!confirm('Log out?')) return;
  currentMode = null; _loginMode = null; _loggedInTechName = null;
  $('loginPin').value = '';
  $('loginErr').textContent = '';
  document.querySelectorAll('.mode-tile').forEach(t => t.classList.remove('selected'));
  $('loginScreen').style.display = 'flex';
}

function applyMode() {
  const isAdmin = currentMode === 'admin';
  // Show / hide admin-only nav
  document.querySelectorAll('.admin-only-nav').forEach(el => {
    el.style.display = isAdmin ? '' : 'none';
  });
  // Mode badge
  const labels = { admin: '‚ö° Admin', tech: 'üîß Tech', operator: 'üë∑ Operator' };
  const badge  = $('modeBadge');
  badge.className = 'mode-badge ' + currentMode;
  const techLabel = (currentMode === 'tech' && _loggedInTechName) ? `üîß ${_loggedInTechName}` : labels[currentMode];
  badge.innerHTML = techLabel + ' <span style="font-size:9px;opacity:.6">¬∑ log out</span>';
  // Hide "Add Machine" button for non-admins
  const addBtn = document.querySelector('#page-machines .page-header .btn-primary');
  if (addBtn) addBtn.style.display = isAdmin ? '' : 'none';
}

// ===================================================================
// MACHINE ID ‚Äî BARCODE / TYPEAHEAD
// ===================================================================
let _msSel = -1; // highlighted suggestion index

function openNewWorkOrder() {
  $('woModalTitle').textContent = 'Report Machine Issue';
  $('woMachineId').value = '';
  $('woMachineName').value = '';
  $('woReportedBy').value = '';
  $('woMachineDown').checked = false;
  $('woPriority').value = 'Medium';
  hideWoSug();
  openModal('woModal');
  setTimeout(() => $('woMachineId').focus(), 80);
}

function onMachineDownToggle() {
  if ($('woMachineDown').checked) {
    $('woPriority').value = 'Critical';
  }
}

function prefillWO(machineId) {
  openNewWorkOrder();
  const m = machines.find(x => x.id === machineId);
  if (m) confirmMachine(m);
}

function machineInput() {
  const raw   = $('woMachineId').value;
  const clean = raw.trim().toUpperCase().replace(/\*/g, '');
  $('woMachineName').value = '';
  if (!clean) { hideWoSug(); return; }

  // Exact ID match ‚Üí auto-confirm (barcode scanner typically fires Enter too,
  // but handle paste-without-Enter for USB wedge scanners)
  const exact = machines.find(x => x.id.toUpperCase() === clean ||
    x.id.toUpperCase().replace(/[()]/g, '') === clean);
  if (exact) { confirmMachine(exact); return; }

  const hits = machines.filter(x =>
    x.id.toUpperCase().includes(clean) || x.name.toUpperCase().includes(clean)
  ).slice(0, 12);
  hits.length ? showWoSug(hits) : hideWoSug();
}

function machineKeydown(e) {
  const box   = $('woMachineSuggestions');
  const items = box.querySelectorAll('.ms-item');
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    _msSel = Math.min(_msSel + 1, items.length - 1);
    items.forEach((el, i) => el.classList.toggle('hi', i === _msSel));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    _msSel = Math.max(_msSel - 1, 0);
    items.forEach((el, i) => el.classList.toggle('hi', i === _msSel));
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (_msSel >= 0 && items[_msSel]) { items[_msSel].click(); return; }
    // Barcode scanner ‚Äî try exact match on current value
    const clean = $('woMachineId').value.trim().toUpperCase().replace(/\*/g, '');
    const m = machines.find(x => x.id.toUpperCase() === clean ||
      x.id.toUpperCase().replace(/[()]/g, '') === clean);
    if (m) confirmMachine(m);
  } else if (e.key === 'Escape') {
    hideWoSug();
  }
}

function showWoSug(hits) {
  _msSel = -1;
  const box = $('woMachineSuggestions');
  box.innerHTML = hits.map(m =>
    `<div class="ms-item" data-machine-id="${esc(m.id)}">
      <span class="ms-id">${esc(m.id)}</span>
      <span class="ms-name">${esc(m.name)}</span>
    </div>`
  ).join('');
  box.style.display = 'block';
}

// Use event delegation ‚Äî avoids inline onclick with string interpolation
$('woMachineSuggestions').addEventListener('click', function(e) {
  const item = e.target.closest('.ms-item[data-machine-id]');
  if (!item) return;
  const m = machines.find(x => x.id === item.dataset.machineId);
  if (m) confirmMachine(m);
});

function hideWoSug() {
  $('woMachineSuggestions').style.display = 'none';
  _msSel = -1;
}

function confirmMachine(m) {
  if (!m) return;
  $('woMachineId').value  = m.id;
  $('woMachineName').value = m.name;
  // Pre-check "machine down" if machine is already in a down state
  if (m.status === 'Down - Critical' || m.status === 'Down - Non-Critical') {
    $('woMachineDown').checked = true;
    $('woPriority').value = 'Critical';
  }
  hideWoSug();
}

document.addEventListener('click', e => {
  if (!e.target.closest('.machine-id-wrap')) { hideWoSug(); hideTechSug(); }
});

// ===================================================================
// TECH AUTOCOMPLETE (Assign Tech in resolve modal)
// ===================================================================
let _tsSel = -1;

function techInput() {
  const val = $('resolveAssignTech').value.trim().toLowerCase();
  if (!val) { hideTechSug(); return; }
  const hits = operators.filter(o => o.name.toLowerCase().includes(val)).slice(0, 8);
  hits.length ? showTechSug(hits) : hideTechSug();
}

function techKeydown(e) {
  const box   = $('techSuggestions');
  const items = box.querySelectorAll('.ms-item');
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    _tsSel = Math.min(_tsSel + 1, items.length - 1);
    items.forEach((el, i) => el.classList.toggle('hi', i === _tsSel));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    _tsSel = Math.max(_tsSel - 1, 0);
    items.forEach((el, i) => el.classList.toggle('hi', i === _tsSel));
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (_tsSel >= 0 && items[_tsSel]) items[_tsSel].click();
  } else if (e.key === 'Escape') {
    hideTechSug();
  }
}

function showTechSug(hits) {
  _tsSel = -1;
  const box = $('techSuggestions');
  box.innerHTML = hits.map(o =>
    `<div class="ms-item" onclick="confirmTech('${esc(o.name).replace(/'/g,"\\'")}')">
      <span class="ms-id">${esc(o.name)}</span>
      <span class="ms-name">${esc(o.role || '')}</span>
    </div>`
  ).join('');
  box.style.display = 'block';
}

function hideTechSug() {
  const box = $('techSuggestions');
  if (box) box.style.display = 'none';
  _tsSel = -1;
}

function confirmTech(name) {
  $('resolveAssignTech').value = name;
  hideTechSug();
}

// ===================================================================
// RESOLVE / MANAGE WORK ORDER
// ===================================================================
let currentResolveWOId = null;

function openResolveWO(woId) {
  const w = workOrders.find(x => x.id === woId);
  if (!w) return;

  // OPERATOR: read-only view only ‚Äî no form access
  // TECH: can only manage WOs assigned to them
  if (currentMode === 'operator') {
    toast('Operators can view work orders but cannot manage them', 'warning');
    return;
  }
  if (currentMode === 'tech' && w.assignedTech && w.assignedTech !== _currentTechName()) {
    toast('You can only manage work orders assigned to you', 'warning');
    return;
  }

  currentResolveWOId = woId;

  const m = machines.find(x => x.id === w.machineId);
  const dts = m ? daysUntilService(m) : null;
  const isOverdue = dts !== null && dts < 0 && dts !== -9999;

  $('resolveWoTitle').innerHTML = `<span style="color:var(--amber)">${esc(w.id)}</span> ‚Äî ${esc(w.machineId)}`;

  const isPM = w._isPM;
  const descLabel = isPM ? 'System PM Notice' : "Operator's Description";
  const descBorderColor = isPM ? 'var(--blue)' : 'var(--amber)';

  $('resolveWoInfo').innerHTML = `
    ${isPM ? '<div style="background:var(--blue-dim);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius);padding:10px 14px;margin-bottom:10px;display:flex;align-items:center;gap:8px"><span style="font-size:16px">üîÑ</span><span style="font-size:13px;color:var(--blue);font-weight:600">Auto-Generated PM Work Order</span><span style="font-size:12px;color:var(--text-muted);margin-left:auto">Assign a tech to get this done</span></div>' : ''}
    <div style="background:var(--bg-tertiary);border-radius:var(--radius);padding:14px 16px;margin-bottom:4px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div><span class="detail-label-sm">Machine</span><br>
          <span style="font-family:var(--font-mono);color:var(--amber);font-weight:600">${esc(w.machineId)}</span> ‚Äî ${esc(w.machineName)}</div>
        <div><span class="detail-label-sm">Location</span><br>${m ? esc(m.location) : '‚Äî'}</div>
        <div><span class="detail-label-sm">${isPM ? 'Generated' : 'Reported By'}</span><br>${esc(w.reportedBy)}</div>
        <div><span class="detail-label-sm">Date</span><br>${formatDate(w.reportedDate)}</div>
        <div><span class="detail-label-sm">Type</span><br>${esc(w.incidentType)}</div>
        <div><span class="detail-label-sm">Category</span><br>${esc(w.category)}</div>
        ${w.workStarted || w.workCompleted ? `
        <div><span class="detail-label-sm">Work Started</span><br>${w.workStarted ? formatDate(w.workStarted) : '<span style="color:var(--text-muted)">‚Äî</span>'}</div>
        <div><span class="detail-label-sm">${w.workCompleted ? 'Completed' : 'Turnaround'}</span><br>${w.workCompleted ? formatDate(w.workCompleted) + (w.workStarted ? ' <span style="font-size:11px;color:var(--green);font-family:var(--font-mono)">(' + Math.max(1, Math.round((parseLocalDate(w.workCompleted) - parseLocalDate(w.workStarted)) / 86400000)) + 'd)</span>' : '') : (w.workStarted ? '<span style="font-family:var(--font-mono);color:var(--amber)">' + Math.max(1, Math.round((new Date() - parseLocalDate(w.workStarted)) / 86400000)) + 'd in progress</span>' : '‚Äî')}</div>
        ` : ''}
      </div>
      <div><span class="detail-label-sm">${descLabel}</span>
        <p style="margin-top:4px;font-size:13.5px;color:var(--text-primary);line-height:1.5;background:var(--bg-card);padding:10px 12px;border-radius:var(--radius);border-left:3px solid ${descBorderColor}">${esc(w.notes) || '<span style="color:var(--text-muted);font-style:italic">No description provided</span>'}</p>
      </div>
      ${w.resolutionNotes ? `<div style="margin-top:10px"><span class="detail-label-sm">Resolution Notes</span>
        <p style="margin-top:4px;font-size:13px;color:var(--text-secondary);line-height:1.4;background:var(--bg-card);padding:10px 12px;border-radius:var(--radius);border-left:3px solid var(--green)">${esc(w.resolutionNotes)}</p>
      </div>` : ''}
      <div style="margin-top:10px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        ${badgeStatus(w.status)}
        ${w.assignedTech ? `<span style="font-size:12px;color:var(--text-secondary)">Assigned: <strong>${esc(w.assignedTech)}</strong></span>` : '<span style="font-size:12px;color:var(--text-muted);font-style:italic">‚ö† No tech assigned yet</span>'}
        ${isOverdue ? `<span class="badge-status badge-overdue">Machine ${Math.abs(dts)}d OVERDUE</span>` : ''}
        ${w.machineDown ? '<span style="font-size:12px;color:var(--red);font-weight:600">üîª Reported DOWN by operator</span>' : ''}
        ${m && m.downSince ? `<span style="font-size:11px;color:var(--red);font-family:var(--font-mono)">Down ${Math.max(1, Math.round((new Date() - new Date(m.downSince)) / 86400000))}d</span>` : ''}
        ${w.followUp==='Yes' && w.followUpDate ? `<span style="font-size:12px;color:var(--amber);font-family:var(--font-mono)">üìÖ Follow-up: ${formatDate(w.followUpDate)}</span>` : ''}
      </div>
      ${w.followUpNotes ? `<div style="margin-top:8px;font-size:12px;color:var(--text-secondary);padding:6px 10px;background:var(--bg-card);border-radius:var(--radius);border-left:2px solid var(--amber)">üìå ${esc(w.followUpNotes)}</div>` : ''}
    </div>
  `;

  // ‚îÄ‚îÄ Assign Tech field: locked once a tech is set ‚îÄ‚îÄ
  const techInput  = $('resolveAssignTech');
  const techWrap   = techInput.closest('.form-group');
  hideTechSug();

  if (w.assignedTech) {
    // Already assigned ‚Äî show locked display, hide input
    techInput.style.display = 'none';
    let locked = techWrap.querySelector('.field-locked');
    if (!locked) {
      locked = document.createElement('div');
      locked.className = 'field-locked';
      techWrap.appendChild(locked);
    }
    locked.innerHTML = `<span class="lock-icon">üîí</span> ${esc(w.assignedTech)}`;
    locked.style.display = 'flex';
  } else {
    // Unassigned ‚Äî show input for admin or tech self-assign
    techInput.style.display = '';
    techInput.value = '';
    techInput.placeholder = currentMode === 'tech'
      ? 'Type your name to self-assign‚Ä¶'
      : 'Type name or scan tech ID‚Ä¶';
    const locked = techWrap.querySelector('.field-locked');
    if (locked) locked.style.display = 'none';
  }

  // ‚îÄ‚îÄ Tech mode: hide assign-tech row entirely (they handle their own) ‚îÄ‚îÄ
  // (already handled above ‚Äî tech sees input to self-assign when unassigned)

  $('resolvePriority').value = w.priority || 'Medium';
  $('resolveStatus').value   = w.status || 'Open';
  $('resolveNotes').value    = w.resolutionNotes || '';
  $('resolvePartsUsed').value = w.partsUsed || '';
  $('resolveWorkStarted').value = w.workStarted ? w.workStarted + (w.workStarted.includes('T') ? '' : 'T08:00') : '';
  $('resolveFollowUp').value = w.followUp || 'No';

  const fuSection = $('followUpDateSection');
  if (w.followUp === 'Yes') {
    fuSection.style.display = 'block';
    $('resolveFollowUpDate').value  = w.followUpDate || '';
    $('resolveFollowUpNotes').value = w.followUpNotes || '';
  } else {
    fuSection.style.display = 'none';
    $('resolveFollowUpDate').value  = '';
    $('resolveFollowUpNotes').value = '';
  }

  openModal('resolveWoModal');
}

async function resolveWorkOrder() {
  const btn = $('btnResolveWO');
  if (btn.disabled) return;
  btn.disabled = true;
  try {
  const w = workOrders.find(x => x.id === currentResolveWOId);
  if (!w) return;
  const oldStatus = w.status;
  const oldTech = w.assignedTech;

  let newStatus = $val('resolveStatus');
  // Read assignedTech: if field is locked (already had a tech), keep existing value
  const techField  = $('resolveAssignTech');
  const assignedTech = techField.style.display === 'none'
    ? w.assignedTech       // locked ‚Äî preserve existing
    : techField.value.trim(); // free-text input
  const resNotes     = $val('resolveNotes');
  const followUp     = $val('resolveFollowUp');
  const followUpDate = $val('resolveFollowUpDate');
  const followUpNotes = $val('resolveFollowUpNotes');
  const newPriority  = $val('resolvePriority');
  const newPartsUsed = $val('resolvePartsUsed');
  const newWorkStarted = $val('resolveWorkStarted') || w.workStarted || '';

  // Tech mode: can only close WOs assigned to them; cannot set status to something else
  if (currentMode === 'tech') {
    const myName = _currentTechName();
    if (assignedTech && assignedTech !== myName && !w.assignedTech) {
      // tech is self-assigning ‚Äî ok
    } else if (w.assignedTech && w.assignedTech !== myName) {
      toast('You can only manage work orders assigned to you', 'warning');
      return;
    }
  }

  // Force Pending when follow-up is scheduled
  if (followUp === 'Yes' && followUpDate) {
    newStatus = 'Pending';
  }

  // Compute workStarted: first tech assignment = work begins
  let computedWorkStarted = newWorkStarted;
  if (assignedTech && !w.assignedTech && !computedWorkStarted) {
    computedWorkStarted = todayISO();
  }

  // Compute workCompleted
  let computedWorkCompleted = w.workCompleted || '';
  if (newStatus === 'Closed') {
    computedWorkCompleted = todayISO();
    if (!computedWorkStarted) computedWorkStarted = computedWorkCompleted;
  }

  const m = machines.find(x => x.id === w.machineId);

  // --- AIRTABLE WRITES FIRST (before any local mutation) ---
  if (CONFIG.useAirtable && w._airtableId) {
    try {
      const updateFields = {
        'Assigned_Tech': assignedTech,
        'Priority': newPriority,
        'Status': newStatus,
        'Resolution_Notes': resNotes,
        'Parts_Used': newPartsUsed,
        'Follow_Up': followUp,
        'Follow_Up_Date': followUpDate || null,
        'Follow_Up_Notes': followUpNotes || '',
      };
      if (computedWorkStarted) updateFields['Work_Started'] = computedWorkStarted;
      if (computedWorkCompleted) updateFields['Work_Completed'] = computedWorkCompleted;
      await AirtableAPI.updateRecord(CONFIG.airtable.tables.serviceLog, w._airtableId, updateFields);
    } catch(e) {
      toast('Save failed ‚Äî no changes made: ' + e.message, 'error');
      return; // abort, don't close modal, don't mutate
    }

    // Machine updates in Airtable
    if (newStatus === 'Pending' && followUp === 'Yes' && followUpDate && m && m._airtableId) {
      try {
        await AirtableAPI.updateRecord(CONFIG.airtable.tables.machines, m._airtableId, {
          'Next_Service_Override': followUpDate, 'Override_Notes': followUpNotes,
        });
      } catch(e) { toast('Machine override NOT saved to Airtable: ' + e.message, 'error'); }
    } else if (newStatus === 'Closed' && m && m._airtableId) {
      const remainingActive = workOrders.filter(x =>
        x.machineId === m.id && (x.status === 'Open' || x.status === 'Pending') && x.id !== w.id
      );
      const machineFields = {
        'Last_Service': computedWorkCompleted || computedWorkStarted,
        'Next_Service_Override': null, 'Override_Notes': '',
      };
      if (remainingActive.length === 0 && (m.status === 'Down - Critical' || m.status === 'Down - Non-Critical')) {
        machineFields['Status'] = 'Operational';
        machineFields['Down_Since'] = null;
      }
      try {
        await AirtableAPI.updateRecord(CONFIG.airtable.tables.machines, m._airtableId, machineFields);
      } catch(e) { toast('Machine update NOT saved to Airtable: ' + e.message, 'error'); }
    }
  }

  // --- NOW MUTATE LOCAL STATE (Airtable succeeded or not in Airtable mode) ---
  w.assignedTech = assignedTech;
  w.priority = newPriority;
  w.status = newStatus;
  w.resolutionNotes = resNotes;
  w.partsUsed = newPartsUsed;
  w.workStarted = computedWorkStarted;
  w.workCompleted = computedWorkCompleted;
  w.followUp = followUp;
  w.followUpDate = followUpDate || '';
  w.followUpNotes = followUpNotes;

  if (m) {
    if (newStatus === 'Pending' && followUp === 'Yes' && followUpDate) {
      m.nextServiceOverride = followUpDate;
      m._followUpNotes = followUpNotes;
    } else if (newStatus === 'Closed') {
      m.lastService = computedWorkCompleted || computedWorkStarted;
      m.nextServiceOverride = '';
      m._followUpNotes = '';
      const remainingActive = workOrders.filter(x =>
        x.machineId === m.id && (x.status === 'Open' || x.status === 'Pending') && x.id !== w.id
      );
      if (remainingActive.length === 0 && (m.status === 'Down - Critical' || m.status === 'Down - Non-Critical')) {
        m.status = 'Operational';
        m.downSince = '';
      }
    }
  }

  closeModal('resolveWoModal');
  renderWorkOrders();

  if (newStatus === 'Pending' && followUp === 'Yes' && followUpDate) {
    toast(`${esc(w.id)} ‚Äî follow-up scheduled for ${formatDate(followUpDate)}. Status set to Pending.`, 'warning');
    logActivity('pending', w.id, w.machineId, `Follow-up scheduled ${formatDate(followUpDate)}${assignedTech ? ' ¬∑ ' + assignedTech : ''}`);
  } else if (newStatus === 'Closed') {
    toast(`${esc(w.id)} resolved and closed${assignedTech ? ' by ' + assignedTech : ''}`);
    logActivity('closed', w.id, w.machineId, `Closed${assignedTech ? ' by ' + assignedTech : ''}${w.workStarted ? ' (' + Math.max(1, Math.round((parseLocalDate(w.workCompleted) - parseLocalDate(w.workStarted)) / 86400000)) + 'd turnaround)' : ''}`);
  } else {
    toast(`${esc(w.id)} updated`);
    // Log tech assignment as distinct event
    if (assignedTech && !oldTech) {
      logActivity('assigned', w.id, w.machineId, `Tech assigned: ${assignedTech}`);
    } else {
      logActivity('updated', w.id, w.machineId, `Updated${assignedTech ? ' ¬∑ ' + assignedTech : ''}`);
    }
  }

  LocalStore.save(); // Save after logActivity so activity entries are persisted

  // Update badge count (Open + Pending)
  const activeCount = workOrders.filter(x => x.status === 'Open' || x.status === 'Pending').length;
  $('openWoBadge').textContent = activeCount;

  // If user resolved from dashboard (clicked activity item), refresh KPIs/overdue table
  if ($('page-dashboard').classList.contains('active')) {
    _refreshing = false; // allow re-render
    refreshDashboard();
  }
  } finally { btn.disabled = false; }
}

function toggleFollowUpDate() {
  const val = $('resolveFollowUp').value;
  const section = $('followUpDateSection');
  section.style.display = val === 'Yes' ? 'block' : 'none';
  if (val === 'Yes') {
    // Default to machine's current service freq from today
    const w = workOrders.find(x => x.id === currentResolveWOId);
    if (w) {
      const m = machines.find(x => x.id === w.machineId);
      if (m) {
        const defaultDate = new Date(Date.now() + m.serviceFreqDays * 86400000);
        $('resolveFollowUpDate').value = defaultDate.toISOString().split('T')[0];
      }
    }
  }
}

function setFollowUpDays(days) {
  const d = new Date(Date.now() + days * 86400000);
  $('resolveFollowUpDate').value = d.toISOString().split('T')[0];
}

async function submitWorkOrder() {
  const btn = $('btnSubmitWO');
  if (btn.disabled) return;
  btn.disabled = true;
  try {
  const wo = {
    id: uid(),
    machineId: $val('woMachineId'),
    machineName: $val('woMachineName'),
    incidentType: $val('woIncidentType'),
    priority: $val('woPriority'),
    category: $val('woCategory'),
    reportedBy: $val('woReportedBy'),
    reportedDate: todayISO(),
    assignedTech: '',
    status: 'Open',
    notes: $val('woNotes'),
    machineDown: $('woMachineDown').checked,
    laborCost: 0,
    partsCost: 0,
    partsUsed: '',
    followUp: 'No',
    followUpDate: '',
    followUpNotes: '',
    resolutionNotes: '',
    workStarted: '',
    workCompleted: '',
  };
  if (!wo.machineId) { toast('Scan or type a Machine ID first', 'error'); return; }
  if (!wo.notes.trim()) { toast('Describe the problem so we can start diagnosing','warning'); return; }
  const ok = await DataService.addWorkOrder(wo);
  if (ok === false) return; // Airtable write failed ‚Äî don't close modal

  // Update machine status: operator marked down OR Emergency/Repair auto-down
  const shouldMarkDown = wo.machineDown || wo.incidentType === 'Emergency' || wo.incidentType === 'Repair';
  if (shouldMarkDown) {
    const m = machines.find(x => x.id === wo.machineId);
    if (m && m.status !== 'Down - Critical') {
      const newMachineStatus = (wo.machineDown || wo.incidentType === 'Emergency') ? 'Down - Critical' : 'Down - Non-Critical';
      const machineFields = { 'Status': newMachineStatus, 'Down_Since': new Date().toISOString() };
      await syncAirtable(CONFIG.airtable.tables.machines, m._airtableId, machineFields, 'Machine status NOT updated in Airtable');
      m.status = newMachineStatus;
      m.downSince = machineFields['Down_Since'];
      LocalStore.save();
    }
  }

  closeModal('woModal');
  renderWorkOrders();
  $('openWoBadge').textContent = workOrders.filter(x => x.status === 'Open' || x.status === 'Pending').length;
  toast('Work order submitted: ' + wo.id + ' ‚Äî management will assign a tech');
  logActivity('created', wo.id, wo.machineId, `${wo.incidentType} ‚Äî ${wo.notes.substring(0, 60)}${wo.notes.length > 60 ? '‚Ä¶' : ''}`);
  LocalStore.save(); // Persist activity log entry
  $('woNotes').value = '';
  } finally { btn.disabled = false; }
}

// ===================================================================
// SCAN
// ===================================================================
// Auto-submit after 300ms of no input ‚Äî handles scanners that don't send Enter
let _scanTimer = null;
function scheduleScan() {
  clearTimeout(_scanTimer);
  const val = $('scanInput').value.trim();
  if (val.length < 3) return; // don't fire on partial typing
  _scanTimer = setTimeout(scanMachine, 300);
}

function scanMachine() {
  clearTimeout(_scanTimer);
  const input = $('scanInput').value.trim().toUpperCase();
  if (!input) return;
  // strip asterisks from barcode scan
  const clean = input.replace(/\*/g, '');
  const m = machines.find(x => x.id.toUpperCase() === clean || x.id.toUpperCase().replace(/[()]/g,'') === clean);
  const resultDiv = $('scanResult');

  if (!m) {
    resultDiv.innerHTML = `<div class="panel" style="border-left:3px solid var(--red)">
      <div class="panel-body"><p style="color:var(--red);font-weight:600">No machine found for ID: ${esc(clean)}</p><p style="color:var(--text-muted);font-size:13px;margin-top:4px">Check the ID and try again, or add a new machine from the Machines page.</p></div>
    </div>`;
    // Refocus for next scan
    const si = $('scanInput');
    si.value = ''; si.focus(); si.select();
    return;
  }

  const dts = daysUntilService(m);
  const isOverdue = dts < 0 && dts !== -9999;
  const mWOs = workOrders.filter(w => w.machineId === m.id).sort((a,b) => new Date(b.reportedDate)-new Date(a.reportedDate)).slice(0,5);

  resultDiv.innerHTML = `
    <div class="panel" style="border-left:3px solid var(--amber)">
      <div class="panel-header">
        <h3><span style="color:var(--amber)">${esc(m.id)}</span> ‚Äî ${esc(m.name)}</h3>
        ${machineBadge(m, dts)}
      </div>
      <div class="panel-body">
        <div class="detail-grid-auto">
          <div><span class="detail-label-sm">Type</span><br>${esc(m.type)}</div>
          <div><span class="detail-label-sm">Location</span><br>${esc(m.location)}</div>
          <div><span class="detail-label-sm">Mfg</span><br>${esc(m.manufacturer)}</div>
          <div><span class="detail-label-sm">Service Freq</span><br>${m.serviceFreqDays}d</div>
          <div><span class="detail-label-sm">Last Service</span><br>${formatDate(m.lastService)}</div>
          <div><span class="detail-label-sm">Next Service</span><br><span ${isOverdue?'style="color:var(--red)"':''}>${nextServiceDate(m)}</span></div>
        </div>
        ${mWOs.length ? `<h4 class="section-heading" style="font-size:11px;margin-bottom:8px">Recent Service History</h4>
        ${renderServiceHistory(mWOs)}` : ''}
        <div style="margin-top:16px;display:flex;gap:10px">
          <button class="btn btn-primary" onclick="prefillWO('${esc(m.id)}')">üö® Report Issue</button>
          <button class="btn btn-secondary" onclick="openMachineDetail('${esc(m.id)}')">Full Details</button>
        </div>
      </div>
    </div>`;

  // Refocus for next scan
  const si = $('scanInput');
  si.value = ''; si.focus(); si.select();
}

// ===================================================================
// OPERATORS
// ===================================================================
function renderOperators() {
  const tbody = document.querySelector('#operatorsTable tbody');
  tbody.innerHTML = operators.map(o => {
    const woCount = workOrders.filter(w => w.assignedTech === o.name).length;
    return `<tr>
      <td class="cell-name" style="font-family:var(--font-mono);font-weight:600">${esc(o.name)}</td>
      <td>${esc(o.role)}</td>
      <td style="font-family:var(--font-mono)">${woCount}</td>
      <td><span class="badge-status ${o.active?'badge-operational':'badge-critical'}">${o.active?'Active':'Inactive'}</span></td>
    </tr>`;
  }).join('');
}

function openAddOperator() { openModal('addOperatorModal'); }

async function addOperator() {
  const name = $val('aoName');
  if (!name) { toast('Name required','error'); return; }
  const op = { id: 'op-'+Date.now(), name, role: $('aoRole').value, active: true };
  await DataService.addOperator(op);
  closeModal('addOperatorModal');
  renderOperators();
  toast('Operator added: ' + name);
  $('aoName').value = '';
}

// ===================================================================
// SETTINGS
// ===================================================================
function saveSettings() {
  CONFIG.airtable.apiKey = $('atApiKey').value.trim();
  CONFIG.airtable.baseId = $('atBaseId').value.trim();
  CONFIG.airtable.tables.machines = $('atMachinesTable').value.trim();
  CONFIG.airtable.tables.serviceLog = $('atServiceTable').value.trim();
  CONFIG.airtable.tables.operators = $('atOperatorsTable').value.trim();
  CONFIG.useAirtable = !!CONFIG.airtable.apiKey && !!CONFIG.airtable.baseId;

  localStorage.setItem('maint_settings', JSON.stringify(CONFIG.airtable));
  updateConnStatus();
  toast('Settings saved');

  if (CONFIG.useAirtable) {
    refreshDashboard();
  }
}

async function testConnection() {
  CONFIG.airtable.apiKey = $('atApiKey').value.trim();
  CONFIG.airtable.baseId = $('atBaseId').value.trim();
  if (!CONFIG.airtable.apiKey || !CONFIG.airtable.baseId) { toast('Enter API key and Base ID first','error'); return; }
  $('connStatus').textContent = 'Testing connection...';
  try {
    const ok = await AirtableAPI.testConnection();
    $('connStatus').innerHTML = ok
      ? '<span style="color:var(--green)">‚úì Connection successful</span>'
      : '<span style="color:var(--red)">‚úó Connection failed ‚Äî check credentials</span>';
  } catch(e) {
    $('connStatus').innerHTML = `<span style="color:var(--red)">‚úó ${e.message}</span>`;
  }
}

function disconnectAirtable() {
  if (!confirm('Disconnect from Airtable? The app will switch to demo mode with local data only.')) return;
  CONFIG.airtable.apiKey = '';
  CONFIG.airtable.baseId = '';
  CONFIG.useAirtable = false;
  $('atApiKey').value = '';
  $('atBaseId').value = '';
  localStorage.removeItem('maint_settings');
  updateConnStatus();
  toast('Disconnected from Airtable');
}

function resetDemoData() {
  if (!confirm('Reset all local data to factory defaults? This clears all work orders, machines, and operators you have added in demo mode. This cannot be undone.')) return;
  LocalStore.clear();
  location.reload();
}

function updateConnStatus() {
  const dot = $('connDot');
  const label = $('connLabel');
  if (CONFIG.useAirtable) {
    dot.style.background = 'var(--green)';
    label.textContent = 'Airtable Connected';
  } else {
    dot.style.background = 'var(--amber)';
    label.textContent = 'Demo Mode';
  }
}

function exportData() {
  const data = { machines, workOrders, operators, activityLog, exported: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'maintenance_data_' + todayISO() + '.json';
  a.click();
}

// ===================================================================
// INIT
// ===================================================================
// Returns the operator name matching the logged-in tech (matched by name from operators list)
// In a real deployment this would come from the PIN-to-operator mapping;
// for now techs select themselves when self-assigning.
function _currentTechName() {
  return _loggedInTechName; // set by doLogin() for tech mode, null otherwise
}

(async function init() {
  // Detect duplicate machine IDs at startup ‚Äî flags data quality issues
  const idCounts = machines.reduce((acc, m) => { acc[m.id] = (acc[m.id]||0)+1; return acc; }, {});
  Object.entries(idCounts).filter(([,n]) => n > 1).forEach(([id]) =>
    console.warn(`[MAINT] Duplicate machine ID detected: "${id}" ‚Äî second entry shadowed. Verify asset registry.`)
  );

  updateConnStatus();

  // Load persisted data in demo mode (survives page refresh)
  // Detect stale cache: if stored machine count doesn't match inline data, clear it
  if (!CONFIG.useAirtable) {
    try {
      const raw = localStorage.getItem('maint_data_v1');
      if (raw) {
        const cached = JSON.parse(raw);
        if (!cached.machineCount || cached.machineCount !== INLINE_MACHINE_COUNT) {
          localStorage.removeItem('maint_data_v1');
          toast('Asset registry updated ‚Äî local cache cleared', 'warning');
        }
      }
    } catch(e) { localStorage.removeItem('maint_data_v1'); }

    const loaded = LocalStore.load();
    if (loaded) {
      toast('Data restored from local storage', 'success');
    }
  }

  // Prefill settings fields
  if (CONFIG.airtable.apiKey) $('atApiKey').value = CONFIG.airtable.apiKey;
  if (CONFIG.airtable.baseId) $('atBaseId').value = CONFIG.airtable.baseId;
  if (CONFIG.airtable.tables.machines) $('atMachinesTable').value = CONFIG.airtable.tables.machines;
  if (CONFIG.airtable.tables.serviceLog) $('atServiceTable').value = CONFIG.airtable.tables.serviceLog;
  if (CONFIG.airtable.tables.operators) $('atOperatorsTable').value = CONFIG.airtable.tables.operators;

  // FIX: Debounce search inputs (300ms)
  const debouncedMachineSearch = debounce(() => renderMachineGrid(), 300);
  const debouncedWOSearch = debounce(() => renderWorkOrders(), 300);
  $('machineSearch').addEventListener('input', debouncedMachineSearch);
  $('woSearch').addEventListener('input', debouncedWOSearch);

  // Initialize badge count immediately after data loads
  $('openWoBadge').textContent = workOrders.filter(x => x.status === 'Open' || x.status === 'Pending').length;

  // Bootstrap activity log from existing WO data if empty (cold start)
  if (activityLog.length === 0 && workOrders.length > 0) {
    const events = [];
    for (const w of workOrders) {
      if (w.reportedDate) events.push({ ts: w.reportedDate + 'T08:00:00Z', type: w._isPM ? 'pm' : 'created', woId: w.id, machineId: w.machineId,
        text: w._isPM ? `PM auto-generated ‚Äî overdue` : `${w.incidentType} ‚Äî ${(w.notes||'').substring(0,55)}${(w.notes||'').length>55?'‚Ä¶':''}`});
      if (w.workStarted && w.assignedTech) events.push({ ts: w.workStarted + 'T10:00:00Z', type: 'assigned', woId: w.id, machineId: w.machineId,
        text: `Tech assigned: ${w.assignedTech}`});
      if (w.workCompleted && w.status === 'Closed') events.push({ ts: w.workCompleted + 'T14:00:00Z', type: 'closed', woId: w.id, machineId: w.machineId,
        text: `Closed${w.assignedTech ? ' by ' + w.assignedTech : ''}`});
      if (w.status === 'Pending' && w.followUpDate) events.push({ ts: (w.workStarted || w.reportedDate) + 'T12:00:00Z', type: 'pending', woId: w.id, machineId: w.machineId,
        text: `Follow-up scheduled ${formatDate(w.followUpDate)}`});
    }
    events.sort((a,b) => new Date(b.ts) - new Date(a.ts));
    activityLog = events.slice(0, 50);
  }

  // Show login screen ‚Äî dashboard loads after successful login
  $('loginScreen').style.display = 'flex';
  // (refreshDashboard is called by doLogin after mode is set)
})();
</script>
</body>
</html>
